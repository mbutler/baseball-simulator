function bM(q){let z=/<!--([\s\S]*?)-->/g,J=[],Q;while((Q=z.exec(q))!==null)J.push(Q[1]);return J}function gM(q,z){let J=new DOMParser;for(let Q of q)if(Q.includes(`id="${z}"`))return J.parseFromString(Q,"text/html").querySelector(`table#${z}`);return null}function kM(q){let z=document.createElement("div");z.style.display="none",document.body.appendChild(z),z.innerHTML=q;let J=z.querySelector("table#players_standard_batting"),Q=z.querySelector("table#players_standard_pitching"),X=bM(q),Z=gM(X,"players_standard_fielding");return z.remove(),{batting:J,pitching:Q,fielding:Z}}function GM(q){if(!q||!q.href)return null;let z=q.href.match(/\/players\/.\/([^/.]+)\.shtml/);return z?z[1]:null}function nM(q){return q.toLowerCase().replace(/[^a-z0-9]/g,"").slice(0,12)}function YM(q){if(!q)return[];let z=Array.from(q.querySelectorAll("tbody > tr")).filter((X)=>!X.classList.contains("thead")),J=Array.from(q.querySelectorAll("thead tr th")).map((X)=>(X.textContent??"").trim()),Q=[];for(let X of z){let Z=[X.querySelector("th"),...X.querySelectorAll("td")];if(Z.length!==J.length)continue;let $={};for(let Y=0;Y<J.length;Y++){let N=J[Y],K=Z[Y];if(Y===0){let V=K?.textContent?.trim()||"",E=K?.querySelector?.("a"),W=GM(E);if(/^\d+$/.test(V)){let O=X.querySelector("td");V=O?.textContent?.trim()||"(unknown)",E=O?.querySelector?.("a"),W=GM(E)||W}$.name=V,$.player_id=W||nM(V)}else{let V=K?.textContent?.trim()||"",E=Number(V.replace(/,/g,""));$[N]=isNaN(E)?V:E}}Q.push($)}return Q}function xM(q){return q.map((z)=>{let J=Number(z.PA)||0,Q=Number(z.AB)||0,X=Number(z.H)||0,Z=Number(z.HR)||0,$=Number(z.BB)||0,Y=Number(z.SO)||0,N=Number(z.SF)||0,K=Number(z.HBP)||0,V=Number(z["2B"])||0,E=Number(z["3B"])||0,W=X-V-E-Z,O=Q-Y-Z+N,G=O>0?(X-Z)/O:null,p=J>0?Y/J:null,x=J>0?$/J:null,C=J>0?Z/J:null,_=Number(z.b_runs_baserunning)||null,j=null;if(_!==null)j=Math.max(0,Math.min(100,50+_*10));else{let T=Number(z["3B"])||0,v=Number(z["2B"])||0;j=Math.max(30,Math.min(80,50+T*5+v*1))}return{name:z.name,player_id:z.player_id,PA:J,stats:{H:X,HR:Z,BB:$,SO:Y,SF:N,HBP:K,singles:W,doubles:V,triples:E},rates:{kRate:p,bbRate:x,hrRate:C,BABIP:G},baserunning:{runsBaserunning:_,speed:j}}})}function wM(q){return q.map((z)=>{let J=Number(z.IP)||0,Q=Number(z.TBF)||0,X=Number(z.H)||0,Z=Number(z.HR)||0,$=Number(z.BB)||0,Y=Number(z.SO)||0,N=Number(z.HBP)||0,K=Q>0?Y/Q:null,V=Q>0?$/Q:null,E=Q>0?Z/Q:null,W=Q-Y-Z-$-N,O=W>0?(X-Z)/W:null;return{name:z.name,player_id:z.player_id,TBF:Q,stats:{IP:J,H:X,HR:Z,BB:$,SO:Y,HBP:N},rates:{kRate:K,bbRate:V,hrRate:E,BABIP:O}}})}function FM(q){return q.map((z)=>{let J=Number(z.f_sb_catcher_only)||0,Q=Number(z.f_cs_catcher_only)||0,X=Number(z.f_cs_perc_catcher_only)||null,Z=Number(z.f_pickoffs_catcher_only)||0,$=null;if(X!==null)$=Math.max(0,Math.min(100,50+(X-25)*2));else if(J>0||Q>0){let Y=J>0?Q/(Q+J):0.25;$=Math.max(20,Math.min(80,50+(Y-0.25)*100))}else $=50;return{name:z.name,player_id:z.player_id,position:z.Pos||"",stats:{G:Number(z.G)||0,Inn:Number(z.Inn)||0,PO:Number(z.PO)||0,A:Number(z.A)||0,E:Number(z.E)||0,DP:Number(z.DP)||0,FP:typeof z.FP==="string"?Number(z.FP):typeof z.FP==="number"?z.FP:null,RF:typeof z.RF==="string"?Number(z.RF):typeof z.RF==="number"?z.RF:null,TZ:typeof z.TZ==="string"?Number(z.TZ):typeof z.TZ==="number"?z.TZ:null,sbAllowed:J,cs:Q,csPct:X,pickoffs:Z,armStrength:$}}})}function r(q,z,J,Q){let X=q.map((Y)=>{let N=J.find((K)=>K.player_id===Y);if(!N)throw new Error(`Lineup player not found: ${Y}`);return N}),Z=Q.find((Y)=>Y.player_id===z);if(!Z)throw new Error(`Starting pitcher not found: ${z}`);let $=new Set;for(let Y of X){if($.has(Y.player_id))throw new Error(`Duplicate player in lineup: ${Y.player_id}`);$.add(Y.player_id)}if($.has(z))throw new Error(`Pitcher also appears in lineup: ${z}`);return{lineup:X,pitcher:Z}}function SM(q,z){return(q+z)/2}function S(q,z){return q==null||isNaN(q)||q===0?z:q}var ZM=0.22,$M=0.08,NM=0.03;function PM(q,z){let J=q.rates||{},Q=z.rates||{},X=q.stats||{},Z=U(S(J.kRate,ZM),"batter.kRate"),$=U(S(Q.kRate,ZM),"pitcher.kRate"),Y=U(S(J.bbRate,$M),"batter.bbRate"),N=U(S(Q.bbRate,$M),"pitcher.bbRate"),K=U(S(J.hrRate,NM),"batter.hrRate"),V=U(S(Q.hrRate,NM),"pitcher.hrRate"),E=U(J.BABIP??0.29,"batter.BABIP"),W=U(Q.BABIP??0.29,"pitcher.BABIP"),O=Math.max(0,q.PA||0),G=Math.max(0,X.HBP??0),p=Math.max(0,X.singles??0),x=Math.max(0,X.doubles??0),C=Math.max(0,X.triples??0),_=U(ZM>0?Z*$/ZM:0,"K"),j=U($M>0?Y*N/$M:0,"BB"),T=U(NM>0?K*V/NM:0,"HR"),v=U(SM(E,W),"BABIP"),y=U(O>0?G/O:0,"HBP"),R=_+j+y+T,b=Math.max(0,1-R),g=v*b,HM=b-g,L=p+x+C,H=L>0?p/L:0.7,D=L>0?x/L:0.2,B=L>0?C/L:0.1;return{K:U(_,"K"),BB:U(j,"BB"),HBP:U(y,"HBP"),HR:U(T,"HR"),"1B":U(g*H,"1B"),"2B":U(g*D,"2B"),"3B":U(g*B,"3B"),Out:U(HM,"Out")}}function U(q,z){if(typeof q!=="number"||isNaN(q))return 0;if(q<0){if(z)console.warn(`[probabilityModel] Clamped negative value for ${z}: ${q} → 0`);return 0}if(q>1){if(z)console.warn(`[probabilityModel] Clamped value >1 for ${z}: ${q} → 1`);return 1}return q}function a(q){let{lineup:z,pitcher:J}=q;return z.map((Q)=>{let X=PM(Q,J);return{batter_id:Q.player_id,pitcher_id:J.player_id,probabilities:X}})}function t(q){let z=Object.values(q).reduce((Q,X)=>Q+X,0),J=Math.random()*z;for(let[Q,X]of Object.entries(q))if((J-=X)<=0)return Q;return Object.keys(q).pop()||""}var mM={Groundout:0.48,Flyout:0.32,Lineout:0.12,Popout:0.08},iM={Groundout:{"1B":0.1,"2B":0.27,SS:0.32,"3B":0.16,P:0.15},Flyout:{LF:0.28,CF:0.48,RF:0.24},Lineout:{"1B":0.28,"2B":0.18,SS:0.18,"3B":0.28,LF:0.04,CF:0.02,RF:0.02},Popout:{C:0.3,"1B":0.18,"2B":0.08,SS:0.18,"3B":0.18,LF:0.04,RF:0.04}};function AM(q){if(q==="Out"){let z=t(mM),J=t(iM[z]);return`${z} to ${J}`}return q}function RM(){return{inning:1,top:!0,outs:0,bases:[null,null,null],lineupIndices:[0,0],score:[0,0],pitcherFatigue:[{battersFaced:0},{battersFaced:0}]}}function LM(q){let z=[];if(q[0])z.push(0);if(q[1]&&q[0])z.push(1);if(q[2]&&q[1]&&q[0])z.push(2);return z}function jM(q,z,J){let Q=0,X=[null,null,null];for(let $=2;$>=0;$--){if(!q[$])continue;let Y=$+(z==="1B"?1:z==="2B"?2:z==="3B"?3:4);if(Y>=3)Q++;else X[Y]=q[$]}let Z={"1B":0,"2B":1,"3B":2}[z];if(Z!==void 0)X[Z]=J;if(z==="HR")Q++;return[X,Q]}function BM(q,z,J,Q,X,Z,$,Y,N){let K=Y||t,V=N||AM,E=J.top?0:1,W=E===0?q:z,O=E===0?Z:$,G=E===0?X:Q,p=Array.isArray(G)?G:[],x=J.lineupIndices[E],C=W[x%W.length],_=O.lineup[x%O.lineup.length],j=C.probabilities;if(J.pitcherFatigue&&J.pitcherFatigue[1-E]){J.pitcherFatigue[1-E].battersFaced++;let L=J.pitcherFatigue[1-E].battersFaced;if(L>18){let D=Math.min((L-18)*0.005,0.05);j={...j};let B=j.Out;if(j.BB)j.BB+=D;if(j["1B"])j["1B"]+=D;if(j.Out){if(j.Out-=D,j.Out<0.5*B)j.Out=0.5*B}let s=Object.values(j).reduce((n,cM)=>n+cM,0);Object.keys(j).forEach((n)=>j[n]=Math.max(0,j[n]/s))}}let T=K(j),v=V(T);J.lineupIndices[E]++;let y=void 0,R="",b=!1,g=!1,HM=!1;if(T==="Out"){let L=v.match(/to ([A-Z0-9]+)/);if(L){if(R=L[1],y=p.find((H)=>H.position===R),y&&y.stats){let H=Number(y.stats.E)||0,D=Number(y.stats.PO)||0,B=Number(y.stats.A)||0,s=D+B+H,n=s>0?H/s:0.01;if(Math.random()<n)b=!0}else if(Math.random()<0.01)b=!0}}if(b){let[L,H]=jM(J.bases,"1B",_);return J.bases=L,J.score[E]+=H,{batter_id:C.batter_id,outcome:`Error on ${R}`,fielder:y,fielderPosition:R}}if(T==="Out"&&/^Groundout to [A-Z0-9]+$/.test(v)&&J.outs===0){let L=LM(J.bases);if(L.length>=2){if(Math.random()<0.01){HM=!0;let H=L.slice().sort((D,B)=>B-D);for(let D=0;D<2&&D<H.length;D++)J.bases[H[D]]=null;return J.outs=3,{batter_id:C.batter_id,outcome:"Grounded into triple play",...y?{fielder:y,fielderPosition:R}:{}}}}}if(T==="Out"&&/^Groundout to [A-Z0-9]+$/.test(v)&&J.outs<2){let L=LM(J.bases);if(L.length>=1){if(Math.random()<0.25){g=!0;let H=Math.max(...L);return J.bases[H]=null,J.outs=Math.min(J.outs+2,3),{batter_id:C.batter_id,outcome:"Grounded into double play",...y?{fielder:y,fielderPosition:R}:{}}}}}if(T==="Out"&&/^Groundout to [A-Z0-9]+$/.test(v)){J.outs++;let L=LM(J.bases);for(let H of L.slice().sort((D,B)=>B-D))if(J.bases[H])if(H===2)J.bases[H]=null,J.score[E]+=1;else J.bases[H+1]=J.bases[H],J.bases[H]=null,console.log("Advancing forced runner from",H,"to",H+1,"Bases:",J.bases);return{batter_id:C.batter_id,outcome:v,...y?{fielder:y,fielderPosition:R}:{}}}if(T==="Out"||T==="K")J.outs++;else if(T==="BB"||T==="HBP"){let[L,H]=jM(J.bases,"1B",_);J.bases=L,J.score[E]+=H}else{let[L,H]=jM(J.bases,T,_);J.bases=L,J.score[E]+=H}return{batter_id:C.batter_id,outcome:v,...y?{fielder:y,fielderPosition:R}:{}}}function VM(q,z,J,Q,X,Z,$){let Y=$||Math.random;if(!z.bases[Z-1])return{success:!1,out:!1,description:`No runner on base ${Z} to steal from.`};let N=q===2?0.6:q===3?0.3:0.1;if(J?.baserunning&&X?.stats){let V=J.baserunning.speed||50,E=X.stats.armStrength||50;if(console.log("Runner speed:",V,"Catcher arm:",E),N=0.5+(V-E)/200,q===3)N-=0.2;if(q===4)N-=0.4;N=Math.max(0.05,Math.min(0.95,N))}if(Y(1)<N){let V=z.bases[Z-1];if(z.bases[Z-1]=null,q<=3)z.bases[q-1]=V;else z.score[z.top?0:1]+=1;return{success:!0,out:!1,description:`Runner successfully stole base ${q===4?"Home":q}`}}else return z.bases[Z-1]=null,z.outs++,{success:!1,out:!0,description:`Runner caught stealing base ${q===4?"Home":q}`}}function EM(q,z,J,Q,X,Z){let $=Z||Math.random;if(!z.bases[q-1])return{success:!1,out:!1,error:!1,description:`No runner on base ${q} to pick off.`};let Y=0.05,N=0.1;if(Q?.stats&&J?.baserunning){let V=Q.stats.pickoffs||0,E=J.baserunning.speed||50;Y=0.03+V*0.02-(E-50)/1000,Y=Math.max(0.01,Math.min(0.15,Y))}if(X?.stats)N=0.05+(1-(X.stats.FP||0.985))*2,N=Math.max(0.01,Math.min(0.2,N));let K=$(1);if(K<Y)return z.bases[q-1]=null,z.outs++,{success:!0,out:!0,error:!1,description:`Runner picked off at base ${q}`};else if(K<Y+N){let V=z.bases[q-1];if(z.bases[q-1]=null,q<3)z.bases[q]=V;else z.score[z.top?0:1]+=1;return{success:!1,out:!1,error:!0,description:`Pickoff error: runner advances from base ${q}`}}else return{success:!1,out:!1,error:!1,description:`Pickoff attempt at base ${q} unsuccessful`}}function UM(q,z){let{inning:J,top:Q,outs:X,score:Z}=q,[$,Y]=Z;if(J<9)return!1;if(Q&&X===3){if(Y>$)return z("Home",Z,J,!0),!0;return!1}if(!Q&&X===3)if($>Y)return z("Away",Z,J,!1),!0;else if(Y>$)return z("Home",Z,J,!1),!0;else return!1;if(!Q&&X<3&&Y>$)return z("Home",Z,J,!1),!0;return!1}var u=document.getElementById("home-team-select"),f=document.getElementById("away-team-select"),yM=document.getElementById("load-teams-btn"),w=document.getElementById("status"),KM=document.getElementById("lineups-container"),e=document.getElementById("game-state-container"),I=document.getElementById("next-atbat-btn"),d=document.getElementById("atbat-result-container"),TM=document.getElementById("customize-home-lineup-btn"),WM=document.getElementById("customize-away-lineup-btn"),c=document.getElementById("custom-lineup-modal"),DM=document.getElementById("close-lineup-modal"),OM=document.getElementById("lineup-modal-title"),CM=document.getElementById("custom-lineup-form"),m=document.getElementById("batting-order-list"),i=document.getElementById("pitcher-select"),F=document.getElementById("lineup-error"),MM=document.getElementById("steal-2b-btn"),qM=document.getElementById("steal-3b-btn"),zM=document.getElementById("steal-home-btn"),JM=document.getElementById("pickoff-1b-btn"),QM=document.getElementById("pickoff-2b-btn"),XM=document.getElementById("pickoff-3b-btn"),_M=document.getElementById("simulate-full-game-btn");function vM(q,z){if(!KM)return;KM.innerHTML="";let J=(Q,X)=>{if(!Q)return`<div><strong>${X}:</strong> Not loaded</div>`;let Z=Q.lineup||Q.batters||[],$=Q.pitcher||Q.pitchers&&Q.pitchers[0]||{name:"N/A"};return`
      <div style="margin-bottom:1.5em;">
        <strong>${X} Lineup</strong>
        <table class="lineup-table">
          <thead><tr><th>#</th><th>Name</th><th>PA</th></tr></thead>
          <tbody>
            ${(Z||[]).slice(0,9).map((Y,N)=>`<tr><td>${N+1}</td><td>${Y.name||""}</td><td>${Y.PA||""}</td></tr>`).join("")}
          </tbody>
        </table>
        <div><strong>Pitcher:</strong> ${$.name}</div>
      </div>
    `};KM.innerHTML=`
    <div style="display:flex;gap:2em;flex-wrap:wrap;">
      <div style="flex:1;min-width:250px;">${J(q,"Home")}</div>
      <div style="flex:1;min-width:250px;">${J(z,"Away")}</div>
    </div>
  `}function k(q,z,J,Q,X,Z,$){if(!e)return;if(!q||!z||!J){if(e.innerHTML="<em>Game not started.</em>",I)I.style.display="none";return}let Y=q,{inning:N,top:K,outs:V,bases:E,score:W,lineupIndices:O}=Y,G=K?0:1,p=G===0?X:Q,x=G===0?J:z;if(!x){if(e.innerHTML="<em>Roster not loaded.</em>",I)I.style.display="none";return}let C=O[G]%x.lineup.length,_=x.lineup[C],j=(G===0?z:J).pitcher,T=["1B","2B","3B"].map((v,y)=>Y.bases[y]?v:"").filter(Boolean).join(", ")||"Empty";if(e.innerHTML=`
    <div><strong>Inning:</strong> ${N} (${K?"Top":"Bottom"})</div>
    <div><strong>Outs:</strong> ${V}</div>
    <div><strong>Bases:</strong> ${T}</div>
    <div><strong>Score:</strong> Away ${W[0]} &ndash; Home ${W[1]}</div>
    <div style="margin-top:1em;"><strong>At Bat:</strong> ${_.name} (vs ${j.name})</div>
  `,I)I.style.display=""}function l(q,z,J){if(!d)return;if(!q)return;z.push(q),J()}function P(q){if(!d)return;d.innerHTML="";let z=null,J=null;for(let Q of q){if(Q.inning!==z||Q.top!==J){let $=document.createElement("div");$.style.marginTop="1em",$.style.fontWeight="bold",$.textContent=`Inning ${Q.inning} - ${Q.top?"Top":"Bottom"}`,d.appendChild($),z=Q.inning,J=Q.top}let X=["1B","2B","3B"].map(($,Y)=>Q.bases[Y]?$:"").filter(Boolean).join(", ")||"Empty",Z=document.createElement("div");Z.innerHTML=`<strong>${Q.batterName}:</strong> ${Q.outcome} <span style="color:#888">(Outs: ${Q.outs}, Score: Away ${Q.score[0]} – Home ${Q.score[1]}, Bases: ${X})</span>`,d.appendChild(Z)}}function A(q,z){q(),z()}var M={loadedHome:null,loadedAway:null,homeRoster:null,awayRoster:null,homeFielders:null,awayFielders:null,homeMatchups:null,awayMatchups:null,gameState:null,lastRenderedInning:1,lastRenderedTop:!0,customHomeLineup:null,customHomePitcher:null,customAwayLineup:null,customAwayPitcher:null,editingTeam:null,atBatLog:[]};async function oM(){return["ARI-2025.html","ATL-2025.html","BAL-2025.html","BOS-2025.html","CHC-2025.html","CHW-2025.html","CIN-2025.html","CLE-2025.html","COL-2025.html","DET-2025.html","HOU-2025.html","KCR-2025.html","LAA-2025.html","LAD-2025.html","MIA-2025.html","MIL-2025.html","MIN-2025.html","NYM-2025.html","NYY-2025.html","OAK-2025.html","PHI-2025.html","PIT-2025.html","SDP-2025.html","SEA-2025.html","SFG-2025.html","STL-2025.html","TBR-2025.html","TEX-2025.html","TOR-2025.html","WSN-2025.html"]}async function hM(q){let J=await(await fetch(`./data/${q}`)).text(),{batting:Q,pitching:X,fielding:Z}=kM(J),$=Q?YM(Q):[],Y=X?YM(X):[],N=Z?YM(Z):[],K=xM($),V=wM(Y),E=FM(N);return{batters:K,pitchers:V,fielders:E}}function o(q,z){let J=q.find((X)=>X.position===z);if(J)return J;let Q=q.find((X)=>X.positions&&X.positions.includes(z));if(Q)return Q;return q.find((X)=>X.stats)||{stats:{armStrength:50,FP:0.985}}}function uM(q,z,J,Q){let X=document.querySelector(".sticky-action-bar");if(X)X.querySelectorAll("button").forEach(($)=>{$.disabled=!0,$.classList.add("disabled-greyed")});if(w)w.textContent=`Game Over: ${q} wins! Final Score: Away ${z[0]} – Home ${z[1]} (${J}${Q?" Top":" Bottom"})`;if(d){let Z=document.createElement("div");Z.style.marginTop="1em",Z.style.fontWeight="bold",Z.style.color="#b00",Z.textContent=`Game Over: ${q} wins! Final Score: Away ${z[0]} – Home ${z[1]} (${J}${Q?" Top":" Bottom"})`,d.appendChild(Z)}}function fM(){if(!M.homeRoster||!M.awayRoster)return;M.homeMatchups=a(M.homeRoster),M.awayMatchups=a(M.awayRoster),M.gameState=RM(),M.atBatLog=[],P(M.atBatLog),A(()=>k(M.gameState,M.homeRoster,M.awayRoster,M.homeMatchups,M.awayMatchups,M.lastRenderedInning,M.lastRenderedTop),h)}function dM(){if(!M.gameState||!M.homeMatchups||!M.awayMatchups||!M.homeRoster||!M.awayRoster)return;let q=M.gameState,z=q.top?0:1,J=z===0?M.awayRoster:M.homeRoster,Q=q.lineupIndices[z]%J.lineup.length,X=J.lineup[Q],Z=BM(M.awayMatchups,M.homeMatchups,q,[],[],M.awayRoster,M.homeRoster);if(l({batterName:X.name,outcome:Z.outcome,outs:q.outs,score:[...q.score],bases:q.bases.map((K)=>K?1:0),inning:q.inning,top:q.top},M.atBatLog,()=>P(M.atBatLog)),UM({inning:q.inning,top:q.top,score:q.score,outs:q.outs},uM)){A(()=>k(M.gameState,M.homeRoster,M.awayRoster,M.homeMatchups,M.awayMatchups,M.lastRenderedInning,M.lastRenderedTop),h);return}let Y="",N=!1;if(q.outs>=3){if(q.bases=[null,null,null],q.outs=0,q.top)q.top=!1,Y="End of top half. Switching to bottom of inning.";else q.top=!0,q.inning++,Y="End of inning. Advancing to next inning.";N=!0}if(N){if(UM({inning:q.inning,top:q.top,score:q.score,outs:q.outs},uM)){A(()=>k(M.gameState,M.homeRoster,M.awayRoster,M.homeMatchups,M.awayMatchups,M.lastRenderedInning,M.lastRenderedTop),h);return}}if(Y)l({batterName:"System",outcome:Y,outs:q.outs,score:[...q.score],bases:q.bases.map((K)=>K?1:0),inning:q.inning,top:q.top},M.atBatLog,()=>P(M.atBatLog));A(()=>k(M.gameState,M.homeRoster,M.awayRoster,M.homeMatchups,M.awayMatchups,M.lastRenderedInning,M.lastRenderedTop),h)}function sM(){if(!M.gameState||!M.homeMatchups||!M.awayMatchups)fM();while(M.gameState&&I&&!I.disabled)dM()}async function IM(){if(!u||!f||!w)return;let q=u.value,z=f.value;if(!q||!z)return;w.textContent="Loading lineups...";try{let[J,Q]=await Promise.all([hM(q),hM(z)]);M.loadedHome=J,M.loadedAway=Q,M.homeFielders=J.fielders,M.awayFielders=Q.fielders,M.homeRoster=J&&J.batters&&J.pitchers?r(M.customHomeLineup&&M.customHomeLineup.length===9?M.customHomeLineup:J.batters.slice(0,9).map((X)=>X.player_id),M.customHomePitcher||J.pitchers[0].player_id,J.batters,J.pitchers):null,M.awayRoster=Q&&Q.batters&&Q.pitchers?r(M.customAwayLineup&&M.customAwayLineup.length===9?M.customAwayLineup:Q.batters.slice(0,9).map((X)=>X.player_id),M.customAwayPitcher||Q.pitchers[0].player_id,Q.batters,Q.pitchers):null,vM(M.homeRoster,M.awayRoster),M.atBatLog=[],P(M.atBatLog),w.textContent="Lineups loaded. Ready to simulate!",console.log("--- Home Roster (normalized, ready for engine) ---"),console.log(JSON.stringify(M.homeRoster,null,2)),console.log("--- Away Roster (normalized, ready for engine) ---"),console.log(JSON.stringify(M.awayRoster,null,2)),fM()}catch(J){w.textContent="Failed to load lineups."}}async function lM(){if(!w)return;w.textContent="Loading teams...";let q=await oM();if(!q.length){w.textContent="No teams found in data folder.";return}for(let z of[u,f]){if(!z)continue;z.innerHTML="";for(let J of q){let Q=document.createElement("option");Q.value=J,Q.textContent=J.replace(".html",""),z.appendChild(Q)}}if(u)u.value="CHC-2025.html";if(f)f.value="MIL-2025.html";if(w.textContent="Select home and away teams.",u&&f)IM()}function rM(){if(!M.loadedHome||!M.loadedAway)return;if(M.homeRoster=M.loadedHome&&M.loadedHome.batters&&M.loadedHome.pitchers?r(M.customHomeLineup&&M.customHomeLineup.length===9?M.customHomeLineup:M.loadedHome.batters.slice(0,9).map((q)=>q.player_id),M.customHomePitcher||M.loadedHome.pitchers[0].player_id,M.loadedHome.batters,M.loadedHome.pitchers):null,M.awayRoster=M.loadedAway&&M.loadedAway.batters&&M.loadedAway.pitchers?r(M.customAwayLineup&&M.customAwayLineup.length===9?M.customAwayLineup:M.loadedAway.batters.slice(0,9).map((q)=>q.player_id),M.customAwayPitcher||M.loadedAway.pitchers[0].player_id,M.loadedAway.batters,M.loadedAway.pitchers):null,M.homeRoster&&M.awayRoster)M.homeMatchups=a({lineup:M.homeRoster.lineup,pitcher:M.awayRoster.pitcher}),M.awayMatchups=a({lineup:M.awayRoster.lineup,pitcher:M.homeRoster.pitcher});vM(M.homeRoster,M.awayRoster),k(M.gameState,M.homeRoster,M.awayRoster,M.homeMatchups,M.awayMatchups,M.lastRenderedInning,M.lastRenderedTop)}function pM(q,z,J,Q,X){if(M.editingTeam=q,!c||!OM||!m||!i)return;if(OM.textContent=`Customize ${q==="home"?"Home":"Away"} Lineup`,F)F.textContent="";c.style.display="flex";let Z=Q,$=X;if(q==="home"&&M.homeRoster)Z=M.homeRoster.lineup?M.homeRoster.lineup.map((Y)=>Y.player_id):Q,$=M.homeRoster.pitcher?M.homeRoster.pitcher.player_id:X;else if(q==="away"&&M.awayRoster)Z=M.awayRoster.lineup?M.awayRoster.lineup.map((Y)=>Y.player_id):Q,$=M.awayRoster.pitcher?M.awayRoster.pitcher.player_id:X;m.innerHTML="";for(let Y=0;Y<9;Y++){let N=document.createElement("li"),K=document.createElement("select");if(K.name=`batter${Y}`,K.required=!0,K.innerHTML='<option value="">-- Select --</option>'+z.map((V)=>`<option value="${V.player_id}">${V.name} (${V.PA} PA)</option>`).join(""),Z&&Z[Y])K.value=Z[Y];N.appendChild(K),m.appendChild(N)}if(i.innerHTML='<option value="">-- Select --</option>'+J.map((Y)=>`<option value="${Y.player_id}">${Y.name} (${Y.stats&&Y.stats.IP?Y.stats.IP:""} IP)</option>`).join(""),$)i.value=$}function h(){if(!M.gameState)return;if(MM)MM.disabled=!M.gameState.bases[0];if(qM)qM.disabled=!M.gameState.bases[1];if(zM)zM.disabled=!M.gameState.bases[2];if(JM)JM.disabled=!M.gameState.bases[0];if(QM)QM.disabled=!M.gameState.bases[1];if(XM)XM.disabled=!M.gameState.bases[2]}if(yM)yM.addEventListener("click",lM);if(u)u.addEventListener("change",IM);if(f)f.addEventListener("change",IM);if(I)I.addEventListener("click",dM);if(TM)TM.addEventListener("click",()=>{if(!M.loadedHome)return;pM("home",M.loadedHome.batters,M.loadedHome.pitchers,M.customHomeLineup,M.customHomePitcher)});if(WM)WM.addEventListener("click",()=>{if(!M.loadedAway)return;pM("away",M.loadedAway.batters,M.loadedAway.pitchers,M.customAwayLineup,M.customAwayPitcher)});if(DM)DM.addEventListener("click",()=>{if(c)c.style.display="none"});if(CM)CM.addEventListener("submit",(q)=>{if(q.preventDefault(),!m||!i)return;let z=[],J=m.querySelectorAll("select");for(let X of J){if(!X.value){if(F)F.textContent="Please select a player for every lineup slot.";return}z.push(X.value)}if(new Set(z).size!==z.length){if(F)F.textContent="No duplicate players allowed in the lineup.";return}let Q=i.value;if(!Q){if(F)F.textContent="Please select a starting pitcher.";return}if(z.includes(Q)){if(F)F.textContent="Pitcher cannot also be in the batting lineup.";return}if(M.editingTeam==="home")M.customHomeLineup=z,M.customHomePitcher=Q;else M.customAwayLineup=z,M.customAwayPitcher=Q;if(c)c.style.display="none";rM()});window.addEventListener("DOMContentLoaded",()=>{lM()});if(MM)MM.addEventListener("click",()=>{if(!M.gameState||!M.homeRoster||!M.awayRoster)return;let q=M.gameState.top?0:1,z=q===0?M.awayRoster:M.homeRoster,J=q===0?M.homeRoster:M.awayRoster,Q=q===0?M.homeFielders:M.awayFielders,X=M.gameState.bases[0];if(!X)return;let Z=Q?o(Q,"C"):{stats:{armStrength:50}},$=J.pitcher;console.log("UI runner object:",X),console.log("UI catcher object:",Z);let Y=VM(2,M.gameState,X,$,Z,1);l({batterName:X.name,outcome:Y.description,outs:M.gameState.outs,score:[...M.gameState.score],bases:M.gameState.bases.map((N)=>N?1:0),inning:M.gameState.inning,top:M.gameState.top},M.atBatLog,()=>P(M.atBatLog)),A(()=>k(M.gameState,M.homeRoster,M.awayRoster,M.homeMatchups,M.awayMatchups,M.lastRenderedInning,M.lastRenderedTop),h)});if(qM)qM.addEventListener("click",()=>{if(!M.gameState||!M.homeRoster||!M.awayRoster)return;let q=M.gameState.top?0:1,z=q===0?M.awayRoster:M.homeRoster,J=q===0?M.homeRoster:M.awayRoster,Q=q===0?M.homeFielders:M.awayFielders,X=M.gameState.bases[1];if(!X)return;let Z=Q?o(Q,"C"):{stats:{armStrength:50}},$=J.pitcher,Y=VM(3,M.gameState,X,$,Z,2);l({batterName:X.name,outcome:Y.description,outs:M.gameState.outs,score:[...M.gameState.score],bases:M.gameState.bases.map((N)=>N?1:0),inning:M.gameState.inning,top:M.gameState.top},M.atBatLog,()=>P(M.atBatLog)),A(()=>k(M.gameState,M.homeRoster,M.awayRoster,M.homeMatchups,M.awayMatchups,M.lastRenderedInning,M.lastRenderedTop),h)});if(zM)zM.addEventListener("click",()=>{if(!M.gameState||!M.homeRoster||!M.awayRoster)return;let q=M.gameState.top?0:1,z=q===0?M.awayRoster:M.homeRoster,J=q===0?M.homeRoster:M.awayRoster,Q=q===0?M.homeFielders:M.awayFielders,X=M.gameState.bases[2];if(!X)return;let Z=Q?o(Q,"C"):{stats:{armStrength:50}},$=J.pitcher,Y=VM(4,M.gameState,X,$,Z,3);l({batterName:X.name,outcome:Y.description,outs:M.gameState.outs,score:[...M.gameState.score],bases:M.gameState.bases.map((N)=>N?1:0),inning:M.gameState.inning,top:M.gameState.top},M.atBatLog,()=>P(M.atBatLog)),A(()=>k(M.gameState,M.homeRoster,M.awayRoster,M.homeMatchups,M.awayMatchups,M.lastRenderedInning,M.lastRenderedTop),h)});if(JM)JM.addEventListener("click",()=>{if(!M.gameState||!M.homeRoster||!M.awayRoster)return;let q=M.gameState.top?0:1,z=q===0?M.awayRoster:M.homeRoster,J=q===0?M.homeRoster:M.awayRoster,Q=q===0?M.homeFielders:M.awayFielders,X=M.gameState.bases[0];if(!X)return;let Z=Q?o(Q,"1B"):{stats:{FP:0.985}},$=J.pitcher,Y=EM(1,M.gameState,X,$,Z);l({batterName:X.name,outcome:Y.description,outs:M.gameState.outs,score:[...M.gameState.score],bases:M.gameState.bases.map((N)=>N?1:0),inning:M.gameState.inning,top:M.gameState.top},M.atBatLog,()=>P(M.atBatLog)),A(()=>k(M.gameState,M.homeRoster,M.awayRoster,M.homeMatchups,M.awayMatchups,M.lastRenderedInning,M.lastRenderedTop),h)});if(QM)QM.addEventListener("click",()=>{if(!M.gameState||!M.homeRoster||!M.awayRoster)return;let q=M.gameState.top?0:1,z=q===0?M.awayRoster:M.homeRoster,J=q===0?M.homeRoster:M.awayRoster,Q=q===0?M.homeFielders:M.awayFielders,X=M.gameState.bases[1];if(!X)return;let Z=Q?o(Q,"2B"):{stats:{FP:0.985}},$=J.pitcher,Y=EM(2,M.gameState,X,$,Z);l({batterName:X.name,outcome:Y.description,outs:M.gameState.outs,score:[...M.gameState.score],bases:M.gameState.bases.map((N)=>N?1:0),inning:M.gameState.inning,top:M.gameState.top},M.atBatLog,()=>P(M.atBatLog)),A(()=>k(M.gameState,M.homeRoster,M.awayRoster,M.homeMatchups,M.awayMatchups,M.lastRenderedInning,M.lastRenderedTop),h)});if(XM)XM.addEventListener("click",()=>{if(!M.gameState||!M.homeRoster||!M.awayRoster)return;let q=M.gameState.top?0:1,z=q===0?M.awayRoster:M.homeRoster,J=q===0?M.homeRoster:M.awayRoster,Q=q===0?M.homeFielders:M.awayFielders,X=M.gameState.bases[2];if(!X)return;let Z=Q?o(Q,"3B"):{stats:{FP:0.985}},$=J.pitcher,Y=EM(3,M.gameState,X,$,Z);l({batterName:X.name,outcome:Y.description,outs:M.gameState.outs,score:[...M.gameState.score],bases:M.gameState.bases.map((N)=>N?1:0),inning:M.gameState.inning,top:M.gameState.top},M.atBatLog,()=>P(M.atBatLog)),A(()=>k(M.gameState,M.homeRoster,M.awayRoster,M.homeMatchups,M.awayMatchups,M.lastRenderedInning,M.lastRenderedTop),h)});if(_M)_M.addEventListener("click",sM);
