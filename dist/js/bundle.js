function S0(q){const J=/<!--([\s\S]*?)-->/g,Q=[];let U;while((U=J.exec(q))!==null)Q.push(U[1]);return Q}function P0(q,J){const Q=new DOMParser;for(let U of q)if(U.includes(`id="${J}"`))return Q.parseFromString(U,"text/html").querySelector(`table#${J}`)||null;return null}function X0(q){const J=document.createElement("div");J.style.display="none",document.body.appendChild(J),J.innerHTML=q;const Q=J.querySelector("table#players_standard_batting"),U=J.querySelector("table#players_standard_pitching"),X=S0(q),Y=P0(X,"players_standard_fielding");return J.remove(),{batting:Q,pitching:U,fielding:Y}}function Y0(q){if(!q||!q.href)return null;const J=q.href.match(/\/players\/.\/([^/.]+)\.shtml/);return J?J[1]:null}function g0(q){return q.toLowerCase().replace(/[^a-z0-9]/g,"").slice(0,12)}function a(q){if(!q)return[];const J=Array.from(q.querySelectorAll("tbody > tr")).filter((X)=>!X.classList.contains("thead")),Q=Array.from(q.querySelectorAll("thead tr th")).map((X)=>(X.textContent??"").trim()),U=[];for(let X of J){const Y=[X.querySelector("th"),...X.querySelectorAll("td")];if(Y.length!==Q.length)continue;const V={};for(let $=0;$<Q.length;$++){const Z=Q[$],K=Y[$];if($===0){let W=K?.textContent?.trim()||"",_=K?.querySelector?.("a")||null,j=Y0(_);if(/^\d+$/.test(W)){const z=X.querySelector("td");W=z?.textContent?.trim()||"(unknown)",_=z?.querySelector?.("a")||null,j=Y0(_)||j}V.name=W,V.player_id=j||g0(W)}else{const W=K?.textContent?.trim()||"",_=Number(W.replace(/,/g,""));V[Z]=isNaN(_)?W:_}}U.push(V)}return U}function $0(q){return q.map((J)=>{const Q=Number(J.PA)||0,U=Number(J.AB)||0,X=Number(J.H)||0,Y=Number(J.HR)||0,V=Number(J.BB)||0,$=Number(J.SO)||0,Z=Number(J.SF)||0,K=Number(J.HBP)||0,W=Number(J["2B"])||0,_=Number(J["3B"])||0,j=X-W-_-Y,z=U-$-Y+Z,D=z>0?(X-Y)/z:null,T=Q>0?$/Q:null,E=Q>0?V/Q:null,x=Q>0?Y/Q:null;return{name:J.name,player_id:J.player_id,PA:Q,stats:{H:X,HR:Y,BB:V,SO:$,SF:Z,HBP:K,singles:j,doubles:W,triples:_},rates:{kRate:T,bbRate:E,hrRate:x,BABIP:D}}})}function V0(q){return q.map((J)=>{const Q=Number(J.IP)||0,U=Number(J.TBF)||0,X=Number(J.H)||0,Y=Number(J.HR)||0,V=Number(J.BB)||0,$=Number(J.SO)||0,Z=Number(J.HBP)||0,K=U>0?$/U:null,W=U>0?V/U:null,_=U>0?Y/U:null,j=U-$-Y-V-Z,z=j>0?(X-Y)/j:null;return{name:J.name,player_id:J.player_id,TBF:U,stats:{IP:Q,H:X,HR:Y,BB:V,SO:$,HBP:Z},rates:{kRate:K,bbRate:W,hrRate:_,BABIP:z}}})}function t(q,J,Q,U){const X=q.map(($)=>{const Z=Q.find((K)=>K.player_id===$);if(!Z)throw new Error(`Lineup player not found: ${$}`);return Z}),Y=U.find(($)=>$.player_id===J);if(!Y)throw new Error(`Starting pitcher not found: ${J}`);const V=new Set;for(let $ of X){if(V.has($.player_id))throw new Error(`Duplicate player in lineup: ${$.player_id}`);V.add($.player_id)}if(V.has(J))throw new Error(`Pitcher also appears in lineup: ${J}`);return{lineup:X,pitcher:Y}}function o(q,J){return(q+J)/2}function Z0(q,J){const Q=q.rates||{},U=J.rates||{},X=q.stats||{},Y=G(Q.kRate??0,"batter.kRate"),V=G(U.kRate??0,"pitcher.kRate"),$=G(Q.bbRate??0,"batter.bbRate"),Z=G(U.bbRate??0,"pitcher.bbRate"),K=G(Q.hrRate??0,"batter.hrRate"),W=G(U.hrRate??0,"pitcher.hrRate"),_=G(Q.BABIP??0.29,"batter.BABIP"),j=G(U.BABIP??0.29,"pitcher.BABIP"),z=Math.max(0,q.PA||0),D=Math.max(0,X.HBP??0),T=Math.max(0,X.singles??0),E=Math.max(0,X.doubles??0),x=Math.max(0,X.triples??0),N=G(o(Y,V),"K"),v=G(o($,Z),"BB"),g=G(o(K,W),"HR"),s=G(o(_,j),"BABIP"),O=G(z>0?D/z:0,"HBP"),k=N+v+O+g,m=Math.max(0,1-k),w=s*m,p=m-w,A=T+E+x,A0=A>0?T/A:0.7,H0=A>0?E/A:0.2,I0=A>0?x/A:0.1;return{K:G(N,"K"),BB:G(v,"BB"),HBP:G(O,"HBP"),HR:G(g,"HR"),"1B":G(w*A0,"1B"),"2B":G(w*H0,"2B"),"3B":G(w*I0,"3B"),Out:G(p,"Out")}}function G(q,J){if(typeof q!=="number"||isNaN(q))return 0;if(q<0){if(J)console.warn(`[probabilityModel] Clamped negative value for ${J}: ${q} \u2192 0`);return 0}if(q>1){if(J)console.warn(`[probabilityModel] Clamped value >1 for ${J}: ${q} \u2192 1`);return 1}return q}function e(q){const{lineup:J,pitcher:Q}=q;return J.map((U)=>{const X=Z0(U,Q);return{batter_id:U.player_id,pitcher_id:Q.player_id,probabilities:X}})}function h(q){const J=Object.values(q).reduce((U,X)=>U+X,0);let Q=Math.random()*J;for(let[U,X]of Object.entries(q))if((Q-=X)<=0)return U;return Object.keys(q).pop()||""}function K0(q){if(q==="Out"){const J=h(w0),Q=h(R0[J]);return`${J} to ${Q}`}return q}var w0={Groundout:0.45,Flyout:0.3,Lineout:0.15,Popout:0.1},R0={Groundout:{"1B":0.2,"2B":0.2,SS:0.25,"3B":0.2,P:0.15},Flyout:{LF:0.35,CF:0.45,RF:0.2},Lineout:{"1B":0.25,"2B":0.25,SS:0.25,"3B":0.25},Popout:{C:0.3,"1B":0.2,"2B":0.15,SS:0.2,"3B":0.15}};function W0(){return{inning:1,top:!0,outs:0,bases:[0,0,0],lineupIndices:[0,0],score:[0,0]}}function q0(q,J){let Q=0;const U=[0,0,0];for(let Y=2;Y>=0;Y--){if(!q[Y])continue;const V=Y+(J==="1B"?1:J==="2B"?2:J==="3B"?3:4);if(V>=3)Q++;else U[V]=1}const X={"1B":0,"2B":1,"3B":2}[J];if(X!==void 0)U[X]=1;if(J==="HR")Q++;return[U,Q]}function G0(q,J,Q,U,X,Y,V){const $=Y||h,Z=V||K0,K=Q.top?0:1,W=K===0?q:J;let _=K===0?X:U;const j=Array.isArray(_)?_:[],z=Q.lineupIndices[K],D=W[z%W.length],T=D.probabilities,E=$(T),x=Z(E);Q.lineupIndices[K]++;let N=void 0,v="",g=!1,s=!1;if(E==="Out"){const O=x.match(/to ([A-Z0-9]+)/);if(O){if(v=O[1],N=j.find((k)=>k.position===v),N&&N.stats){const k=Number(N.stats.E)||0,m=Number(N.stats.PO)||0,w=Number(N.stats.A)||0,p=m+w+k,A=p>0?k/p:0.01;if(Math.random()<A)g=!0}else if(Math.random()<0.01)g=!0}}if(E==="Out"&&/^Groundout to [A-Z0-9]+$/.test(x)&&Q.outs<2&&Q.bases[0]===1){if(Math.random()<0.25)return s=!0,Q.bases[0]=0,Q.outs=Math.min(Q.outs+2,3),{batter_id:D.batter_id,outcome:"Grounded into double play",...N?{fielder:N,fielderPosition:v}:{}}}if(g){const[O,k]=q0(Q.bases,"1B");return Q.bases=O,Q.score[K]+=k,{batter_id:D.batter_id,outcome:`Error on ${v}`,fielder:N,fielderPosition:v}}if(E==="Out"||E==="K")Q.outs++;else if(E==="BB"||E==="HBP"){const[O,k]=q0(Q.bases,"1B");Q.bases=O,Q.score[K]+=k}else{const[O,k]=q0(Q.bases,E);Q.bases=O,Q.score[K]+=k}return{batter_id:D.batter_id,outcome:x,...N?{fielder:N,fielderPosition:v}:{}}}async function f0(){return["ARI-2025.html","ATL-2025.html","BAL-2025.html","BOS-2025.html","CHC-2025.html","CHW-2025.html","CIN-2025.html","CLE-2025.html","COL-2025.html","DET-2025.html","HOU-2025.html","KCR-2025.html","LAA-2025.html","LAD-2025.html","MIA-2025.html","MIL-2025.html","MIN-2025.html","NYM-2025.html","NYY-2025.html","OAK-2025.html","PHI-2025.html","PIT-2025.html","SDP-2025.html","SEA-2025.html","SFG-2025.html","STL-2025.html","TBR-2025.html","TEX-2025.html","TOR-2025.html","WSN-2025.html"]}async function O0(q){const Q=await(await fetch(`./data/${q}`)).text(),{batting:U,pitching:X}=X0(Q),Y=U?a(U):[],V=X?a(X):[],$=$0(Y),Z=V0(V);return{batters:$,pitchers:Z}}function F0(q,J){if(!J0)return;J0.innerHTML="";const Q=(U,X)=>{if(!U)return`<div><strong>${X}:</strong> Not loaded</div>`;const Y=U.lineup||U.batters||[],V=U.pitcher||U.pitchers&&U.pitchers[0]||{name:"N/A"};return`
      <div style="margin-bottom:1.5em;">
        <strong>${X} Lineup</strong>
        <table class="lineup-table">
          <thead><tr><th>#</th><th>Name</th><th>PA</th></tr></thead>
          <tbody>
            ${(Y||[]).slice(0,9).map(($,Z)=>`<tr><td>${Z+1}</td><td>${$.name||""}</td><td>${$.PA||""}</td></tr>`).join("")}
          </tbody>
        </table>
        <div><strong>Pitcher:</strong> ${V.name}</div>
      </div>
    `};J0.innerHTML=`
    <div style="display:flex;gap:2em;flex-wrap:wrap;">
      <div style="flex:1;min-width:250px;">${Q(q,"Home")}</div>
      <div style="flex:1;min-width:250px;">${Q(J,"Away")}</div>
    </div>
  `}function L0(){if(!n)return;if(!y||!L||!M){if(n.innerHTML="<em>Game not started.</em>",H)H.style.display="none";return}const q=y,{inning:J,top:Q,outs:U,bases:X,score:Y,lineupIndices:V}=q,$=Q?0:1,Z=$===0?f:R,K=$===0?M:L;if(!K){if(n.innerHTML="<em>Roster not loaded.</em>",H)H.style.display="none";return}const W=V[$]%K.lineup.length,_=K.lineup[W],j=($===0?L:M).pitcher,z=["1B","2B","3B"].map((D,T)=>q.bases[T]?D:"").filter(Boolean).join(", ")||"Empty";if(n.innerHTML=`
    <div><strong>Inning:</strong> ${J} (${Q?"Top":"Bottom"})</div>
    <div><strong>Outs:</strong> ${U}</div>
    <div><strong>Bases:</strong> ${z}</div>
    <div><strong>Score:</strong> Away ${Y[0]} &ndash; Home ${Y[1]}</div>
    <div style="margin-top:1em;"><strong>At Bat:</strong> ${_.name} (vs ${j.name})</div>
  `,H)H.style.display=""}function M0(q,J=!1){if(!F)return;if(!q)return;if(J){const X=document.createElement("div");X.style.marginTop="1em",X.style.fontWeight="bold",X.textContent=`Inning ${q.inning} - ${q.top?"Top":"Bottom"}`,F.appendChild(X)}const Q=["1B","2B","3B"].map((X,Y)=>q.bases[Y]?X:"").filter(Boolean).join(", ")||"Empty",U=document.createElement("div");U.innerHTML=`<strong>Batter:</strong> ${q.batterName}<br><strong>Result:</strong> ${q.outcome}<br><strong>Outs:</strong> ${q.outs} &nbsp; <strong>Score:</strong> Away ${q.score[0]} \u2013 Home ${q.score[1]} &nbsp; <strong>Bases:</strong> ${Q}`,F.appendChild(U),F.appendChild(document.createElement("br"))}function B0(){if(!L||!M)return;R=e(L),f=e(M),y=W0(),L0(),M0(null)}function y0(){if(!y||!R||!f)return;const q=y,J=q.top?0:1,Q=J===0?f:R,U=J===0?M:L;if(!U)return;const X=q.lineupIndices[J]%U.lineup.length,Y=U.lineup[X],V=G0(f,R,q,[],[]);M0({batterName:Y.name,outcome:V.outcome,outs:q.outs,score:[...q.score],bases:[...q.bases],inning:q.inning,top:q.top});let $="",Z=!1;if(q.outs>=3)if(q.outs=0,q.bases=[0,0,0],q.top)q.top=!1,$="End of top half. Switching to bottom of inning.",Z=!0;else q.top=!0,q.inning++,$="End of inning. Advancing to next inning.",Z=!0;if(Z){if(F){const K=document.createElement("div");K.innerHTML=`<em>${$}</em>`,F.appendChild(K),D0=q.inning,C0=q.top;const W=document.createElement("div");W.style.marginTop="1em",W.style.fontWeight="bold",W.textContent=`Inning ${q.inning} - ${q.top?"Top":"Bottom"}`,F.appendChild(W)}}L0()}async function r(){if(!I||!S||!P)return;const q=I.value,J=S.value;if(!q||!J)return;P.textContent="Loading lineups...";try{const[Q,U]=await Promise.all([O0(q),O0(J)]);l=Q,i=U,L=Q&&Q.batters&&Q.pitchers?t(u&&u.length===9?u:Q.batters.slice(0,9).map((X)=>X.player_id),Q0||Q.pitchers[0].player_id,Q.batters,Q.pitchers):null,M=U&&U.batters&&U.pitchers?t(c&&c.length===9?c:U.batters.slice(0,9).map((X)=>X.player_id),U0||U.pitchers[0].player_id,U.batters,U.pitchers):null,F0(L,M),P.textContent="Lineups loaded. Ready to simulate!",B0()}catch(Q){P.textContent="Failed to load lineups."}}async function T0(){if(!P)return;P.textContent="Loading teams...";const q=await f0();if(!q.length){P.textContent="No teams found in data folder.";return}for(let J of[I,S]){if(!J)continue;J.innerHTML="";for(let Q of q){const U=document.createElement("option");U.value=Q,U.textContent=Q.replace(".html",""),J.appendChild(U)}}if(I)I.value="CHC-2025.html";if(S)S.value="MIL-2025.html";if(P.textContent="Select home and away teams.",I&&S)r()}function x0(q,J,Q,U,X){if(v0=q,!B||!E0||!b||!d)return;if(E0.textContent=`Customize ${q==="home"?"Home":"Away"} Lineup`,C)C.textContent="";B.style.display="flex",b.innerHTML="";for(let Y=0;Y<9;Y++){const V=document.createElement("li"),$=document.createElement("select");if($.name=`batter${Y}`,$.required=!0,$.innerHTML='<option value="">-- Select --</option>'+J.map((Z)=>`<option value="${Z.player_id}">${Z.name} (${Z.PA} PA)</option>`).join(""),U&&U[Y])$.value=U[Y];V.appendChild($),b.appendChild(V)}if(d.innerHTML='<option value="">-- Select --</option>'+Q.map((Y)=>`<option value="${Y.player_id}">${Y.name} (${Y.stats&&Y.stats.IP?Y.stats.IP:""} IP)</option>`).join(""),X)d.value=X}var I=document.getElementById("home-team-select"),S=document.getElementById("away-team-select"),_0=document.getElementById("load-teams-btn"),P=document.getElementById("status"),J0=document.getElementById("lineups-container"),n=document.getElementById("game-state-container"),H=document.getElementById("next-atbat-btn"),F=document.getElementById("atbat-result-container"),j0=document.getElementById("customize-home-lineup-btn"),z0=document.getElementById("customize-away-lineup-btn"),B=document.getElementById("custom-lineup-modal"),N0=document.getElementById("close-lineup-modal"),E0=document.getElementById("lineup-modal-title"),k0=document.getElementById("custom-lineup-form"),b=document.getElementById("batting-order-list"),d=document.getElementById("pitcher-select"),C=document.getElementById("lineup-error"),l=null,i=null,L=null,M=null,R=null,f=null,y=null,D0=1,C0=!0,u=null,Q0=null,c=null,U0=null,v0=null;if(_0)_0.addEventListener("click",T0);if(I)I.addEventListener("change",r);if(S)S.addEventListener("change",r);if(H)H.addEventListener("click",y0);if(j0)j0.addEventListener("click",()=>{if(!l)return;x0("home",l.batters,l.pitchers,u,Q0)});if(z0)z0.addEventListener("click",()=>{if(!i)return;x0("away",i.batters,i.pitchers,c,U0)});if(N0)N0.addEventListener("click",()=>{if(B)B.style.display="none"});if(k0)k0.addEventListener("submit",(q)=>{if(q.preventDefault(),!b||!d)return;const J=[],Q=b.querySelectorAll("select");for(let X of Q){if(!X.value){if(C)C.textContent="Please select a player for every lineup slot.";return}J.push(X.value)}if(new Set(J).size!==J.length){if(C)C.textContent="No duplicate players allowed in the lineup.";return}const U=d.value;if(!U){if(C)C.textContent="Please select a starting pitcher.";return}if(J.includes(U)){if(C)C.textContent="Pitcher cannot also be in the batting lineup.";return}if(v0==="home")u=J,Q0=U;else c=J,U0=U;if(B)B.style.display="none";if(R=null,f=null,y=null,D0=1,C0=!0,F)F.innerHTML="";F0(L,M),r()});window.addEventListener("DOMContentLoaded",()=>{T0()});
