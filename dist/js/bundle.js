function bM(q){let z=/<!--([\s\S]*?)-->/g,J=[],Q;while((Q=z.exec(q))!==null)J.push(Q[1]);return J}function gM(q,z){let J=new DOMParser;for(let Q of q)if(Q.includes(`id="${z}"`))return J.parseFromString(Q,"text/html").querySelector(`table#${z}`);return null}function kM(q){let z=document.createElement("div");z.style.display="none",document.body.appendChild(z),z.innerHTML=q;let J=z.querySelector("table#players_standard_batting"),Q=z.querySelector("table#players_standard_pitching"),X=bM(q),Z=gM(X,"players_standard_fielding");return z.remove(),{batting:J,pitching:Q,fielding:Z}}function GM(q){if(!q||!q.href)return null;let z=q.href.match(/\/players\/.\/([^/.]+)\.shtml/);return z?z[1]:null}function nM(q){return q.toLowerCase().replace(/[^a-z0-9]/g,"").slice(0,12)}function YM(q){if(!q)return[];console.log("Table id:",q?.id);let z=Array.from(q.querySelectorAll("thead tr"));console.log("Header rows:",z.map(($)=>$.textContent));let J=z[z.length-1],Q=Array.from(J.querySelectorAll("th")).map(($)=>($.textContent??"").trim());console.log("Header cells:",Q);let X=Array.from(q.querySelectorAll("tbody > tr")).filter(($)=>!$.classList.contains("thead"));console.log("First data row:",X[0]?.innerHTML);let Z=[];for(let $ of X){let Y=[$.querySelector("th"),...$.querySelectorAll("td")];if(Y.length!==Q.length)continue;let N={};for(let V=0;V<Q.length;V++){let K=Q[V],E=Y[V];if(V===0){let T=E?.textContent?.trim()||"",U=E?.querySelector?.("a"),C=GM(U);if(/^\d+$/.test(T)){let R=$.querySelector("td");T=R?.textContent?.trim()||"(unknown)",U=R?.querySelector?.("a"),C=GM(U)||C}N.name=T,N.player_id=C||nM(T)}else{let T=E?.textContent?.trim()||"",U=Number(T.replace(/,/g,""));N[K]=isNaN(U)?T:U}}Z.push(N)}return Z}function SM(q){if(typeof q!=="string")return"";let z=q.replace("*","").split("/")[0];return{"1":"P","2":"C","3":"1B","4":"2B","5":"3B","6":"SS","7":"LF","8":"CF","9":"RF",DH:"DH"}[z]||z}function xM(q){return q.map((z)=>{let J=Number(z.PA)||0,Q=Number(z.AB)||0,X=Number(z.H)||0,Z=Number(z.HR)||0,$=Number(z.BB)||0,Y=Number(z.SO)||0,N=Number(z.SF)||0,V=Number(z.HBP)||0,K=Number(z["2B"])||0,E=Number(z["3B"])||0,T=X-K-E-Z,U=Q-Y-Z+N,C=U>0?(X-Z)/U:null,R=J>0?Y/J:null,x=J>0?$/J:null,_=J>0?Z/J:null,v=Number(z.b_runs_baserunning)||null,j=null;if(v!==null)j=Math.max(0,Math.min(100,50+v*10));else{let D=Number(z["3B"])||0,I=Number(z["2B"])||0;j=Math.max(30,Math.min(80,50+D*5+I*1))}return{name:z.name,player_id:z.player_id,PA:J,stats:{H:X,HR:Z,BB:$,SO:Y,SF:N,HBP:V,singles:T,doubles:K,triples:E},rates:{kRate:R,bbRate:x,hrRate:_,BABIP:C},baserunning:{runsBaserunning:v,speed:j}}})}function FM(q){return q.map((z)=>{let J=Number(z.IP)||0,Q=Number(z.TBF)||0,X=Number(z.H)||0,Z=Number(z.HR)||0,$=Number(z.BB)||0,Y=Number(z.SO)||0,N=Number(z.HBP)||0,V=Q>0?Y/Q:null,K=Q>0?$/Q:null,E=Q>0?Z/Q:null,T=Q-Y-Z-$-N,U=T>0?(X-Z)/T:null;return{name:z.name,player_id:z.player_id,TBF:Q,stats:{IP:J,H:X,HR:Z,BB:$,SO:Y,HBP:N},rates:{kRate:V,bbRate:K,hrRate:E,BABIP:U}}})}function wM(q){return q.map((z)=>{let J=z.Pos||z.Position||z.position||z.POS||z["Primary Pos"]||"",Q=SM(J),X=Number(z.f_sb_catcher_only)||0,Z=Number(z.f_cs_catcher_only)||0,$=Number(z.f_cs_perc_catcher_only)||null,Y=Number(z.f_pickoffs_catcher_only)||0,N=null;if($!==null)N=Math.max(0,Math.min(100,50+($-25)*2));else if(X>0||Z>0){let V=X>0?Z/(Z+X):0.25;N=Math.max(20,Math.min(80,50+(V-0.25)*100))}else N=50;return{name:z.name,player_id:z.player_id,position:Q,stats:{...z,sbAllowed:X,cs:Z,csPct:$,pickoffs:Y,armStrength:N}}})}function r(q,z,J,Q){let X=q.map((Y)=>{let N=J.find((V)=>V.player_id===Y);if(!N)throw new Error(`Lineup player not found: ${Y}`);return N}),Z=Q.find((Y)=>Y.player_id===z);if(!Z)throw new Error(`Starting pitcher not found: ${z}`);let $=new Set;for(let Y of X){if($.has(Y.player_id))throw new Error(`Duplicate player in lineup: ${Y.player_id}`);$.add(Y.player_id)}if($.has(z))throw new Error(`Pitcher also appears in lineup: ${z}`);return{lineup:X,pitcher:Z}}function mM(q,z){return(q+z)/2}function S(q,z){return q==null||isNaN(q)||q===0?z:q}var ZM=0.22,$M=0.08,NM=0.03;function PM(q,z){let J=q.rates||{},Q=z.rates||{},X=q.stats||{},Z=y(S(J.kRate,ZM),"batter.kRate"),$=y(S(Q.kRate,ZM),"pitcher.kRate"),Y=y(S(J.bbRate,$M),"batter.bbRate"),N=y(S(Q.bbRate,$M),"pitcher.bbRate"),V=y(S(J.hrRate,NM),"batter.hrRate"),K=y(S(Q.hrRate,NM),"pitcher.hrRate"),E=y(J.BABIP??0.29,"batter.BABIP"),T=y(Q.BABIP??0.29,"pitcher.BABIP"),U=Math.max(0,q.PA||0),C=Math.max(0,X.HBP??0),R=Math.max(0,X.singles??0),x=Math.max(0,X.doubles??0),_=Math.max(0,X.triples??0),v=y(ZM>0?Z*$/ZM:0,"K"),j=y($M>0?Y*N/$M:0,"BB"),D=y(NM>0?V*K/NM:0,"HR"),I=y(mM(E,T),"BABIP"),W=y(U>0?C/U:0,"HBP"),B=v+j+W+D,b=Math.max(0,1-B),g=I*b,HM=b-g,L=R+x+_,H=L>0?R/L:0.7,O=L>0?x/L:0.2,h=L>0?_/L:0.1;return{K:y(v,"K"),BB:y(j,"BB"),HBP:y(W,"HBP"),HR:y(D,"HR"),"1B":y(g*H,"1B"),"2B":y(g*O,"2B"),"3B":y(g*h,"3B"),Out:y(HM,"Out")}}function y(q,z){if(typeof q!=="number"||isNaN(q))return 0;if(q<0){if(z)console.warn(`[probabilityModel] Clamped negative value for ${z}: ${q} → 0`);return 0}if(q>1){if(z)console.warn(`[probabilityModel] Clamped value >1 for ${z}: ${q} → 1`);return 1}return q}function a(q){let{lineup:z,pitcher:J}=q;return z.map((Q)=>{let X=PM(Q,J);return{batter_id:Q.player_id,pitcher_id:J.player_id,probabilities:X}})}function t(q){let z=Object.values(q).reduce((Q,X)=>Q+X,0),J=Math.random()*z;for(let[Q,X]of Object.entries(q))if((J-=X)<=0)return Q;return Object.keys(q).pop()||""}var iM={Groundout:0.48,Flyout:0.32,Lineout:0.12,Popout:0.08},oM={Groundout:{"1B":0.1,"2B":0.27,SS:0.32,"3B":0.16,P:0.15},Flyout:{LF:0.28,CF:0.48,RF:0.24},Lineout:{"1B":0.28,"2B":0.18,SS:0.18,"3B":0.28,LF:0.04,CF:0.02,RF:0.02},Popout:{C:0.3,"1B":0.18,"2B":0.08,SS:0.18,"3B":0.18,LF:0.04,RF:0.04}};function AM(q){if(q==="Out"){let z=t(iM),J=t(oM[z]);return`${z} to ${J}`}return q}function RM(){return{inning:1,top:!0,outs:0,bases:[null,null,null],lineupIndices:[0,0],score:[0,0],pitcherFatigue:[{battersFaced:0},{battersFaced:0}]}}function LM(q){let z=[];if(q[0])z.push(0);if(q[1]&&q[0])z.push(1);if(q[2]&&q[1]&&q[0])z.push(2);return z}function jM(q,z,J){let Q=0,X=[null,null,null];for(let $=2;$>=0;$--){if(!q[$])continue;let Y=$+(z==="1B"?1:z==="2B"?2:z==="3B"?3:4);if(Y>=3)Q++;else X[Y]=q[$]}let Z={"1B":0,"2B":1,"3B":2}[z];if(Z!==void 0)X[Z]=J;if(z==="HR")Q++;return[X,Q]}function BM(q,z,J,Q,X,Z,$,Y,N){let V=Y||t,K=N||AM,E=J.top?0:1,T=E===0?q:z,U=E===0?Z:$,C=E===0?X:Q,R=Array.isArray(C)?C:[],x=J.lineupIndices[E],_=T[x%T.length],v=U.lineup[x%U.lineup.length],j=_.probabilities;if(J.pitcherFatigue&&J.pitcherFatigue[1-E]){J.pitcherFatigue[1-E].battersFaced++;let L=J.pitcherFatigue[1-E].battersFaced;if(L>18){let O=Math.min((L-18)*0.005,0.05);j={...j};let h=j.Out;if(j.BB)j.BB+=O;if(j["1B"])j["1B"]+=O;if(j.Out){if(j.Out-=O,j.Out<0.5*h)j.Out=0.5*h}let s=Object.values(j).reduce((n,cM)=>n+cM,0);Object.keys(j).forEach((n)=>j[n]=Math.max(0,j[n]/s))}}let D=V(j),I=K(D);J.lineupIndices[E]++;let W=void 0,B="",b=!1,g=!1,HM=!1;if(D==="Out"){let L=I.match(/to ([A-Z0-9]+)/);if(L){if(B=L[1],W=R.find((H)=>H.position===B),W&&W.stats){let H=Number(W.stats.E)||0,O=Number(W.stats.PO)||0,h=Number(W.stats.A)||0,s=O+h+H,n=s>0?H/s:0.01;if(Math.random()<n)b=!0}else if(Math.random()<0.01)b=!0}}if(b){let[L,H]=jM(J.bases,"1B",v);return J.bases=L,J.score[E]+=H,{batter_id:_.batter_id,outcome:`Error on ${B}`,fielder:W,fielderPosition:B}}if(D==="Out"&&/^Groundout to [A-Z0-9]+$/.test(I)&&J.outs===0){let L=LM(J.bases);if(L.length>=2){if(Math.random()<0.01){HM=!0;let H=L.slice().sort((O,h)=>h-O);for(let O=0;O<2&&O<H.length;O++)J.bases[H[O]]=null;return J.outs=3,{batter_id:_.batter_id,outcome:"Grounded into triple play",...W?{fielder:W,fielderPosition:B}:{}}}}}if(D==="Out"&&/^Groundout to [A-Z0-9]+$/.test(I)&&J.outs<2){let L=LM(J.bases);if(L.length>=1){if(Math.random()<0.25){g=!0;let H=Math.max(...L);return J.bases[H]=null,J.outs=Math.min(J.outs+2,3),{batter_id:_.batter_id,outcome:"Grounded into double play",...W?{fielder:W,fielderPosition:B}:{}}}}}if(D==="Out"&&/^Groundout to [A-Z0-9]+$/.test(I)){J.outs++;let L=LM(J.bases);for(let H of L.slice().sort((O,h)=>h-O))if(J.bases[H])if(H===2)J.bases[H]=null,J.score[E]+=1;else J.bases[H+1]=J.bases[H],J.bases[H]=null,console.log("Advancing forced runner from",H,"to",H+1,"Bases:",J.bases);return{batter_id:_.batter_id,outcome:I,...W?{fielder:W,fielderPosition:B}:{}}}if(D==="Out"||D==="K")J.outs++;else if(D==="BB"||D==="HBP"){let[L,H]=jM(J.bases,"1B",v);J.bases=L,J.score[E]+=H}else{let[L,H]=jM(J.bases,D,v);J.bases=L,J.score[E]+=H}return{batter_id:_.batter_id,outcome:I,...W?{fielder:W,fielderPosition:B}:{}}}function VM(q,z,J,Q,X,Z,$){let Y=$||Math.random;if(!z.bases[Z-1])return{success:!1,out:!1,description:`No runner on base ${Z} to steal from.`};let N=q===2?0.6:q===3?0.3:0.1;if(J?.baserunning&&X?.stats){let K=J.baserunning.speed||50,E=X.stats.armStrength||50;if(console.log("Runner speed:",K,"Catcher arm:",E),N=0.5+(K-E)/200,q===3)N-=0.2;if(q===4)N-=0.4;N=Math.max(0.05,Math.min(0.95,N))}if(Y(1)<N){let K=z.bases[Z-1];if(z.bases[Z-1]=null,q<=3)z.bases[q-1]=K;else z.score[z.top?0:1]+=1;return{success:!0,out:!1,description:`Runner successfully stole base ${q===4?"Home":q}`}}else return z.bases[Z-1]=null,z.outs++,{success:!1,out:!0,description:`Runner caught stealing base ${q===4?"Home":q}`}}function EM(q,z,J,Q,X,Z){let $=Z||Math.random;if(!z.bases[q-1])return{success:!1,out:!1,error:!1,description:`No runner on base ${q} to pick off.`};let Y=0.05,N=0.1;if(Q?.stats&&J?.baserunning){let K=Q.stats.pickoffs||0,E=J.baserunning.speed||50;Y=0.03+K*0.02-(E-50)/1000,Y=Math.max(0.01,Math.min(0.15,Y))}if(X?.stats)N=0.05+(1-(X.stats.FP||0.985))*2,N=Math.max(0.01,Math.min(0.2,N));let V=$(1);if(V<Y)return z.bases[q-1]=null,z.outs++,{success:!0,out:!0,error:!1,description:`Runner picked off at base ${q}`};else if(V<Y+N){let K=z.bases[q-1];if(z.bases[q-1]=null,q<3)z.bases[q]=K;else z.score[z.top?0:1]+=1;return{success:!1,out:!1,error:!0,description:`Pickoff error: runner advances from base ${q}`}}else return{success:!1,out:!1,error:!1,description:`Pickoff attempt at base ${q} unsuccessful`}}function UM(q,z){let{inning:J,top:Q,outs:X,score:Z}=q,[$,Y]=Z;if(J<9)return!1;if(Q&&X===3){if(Y>$)return z("Home",Z,J,!0),!0;return!1}if(!Q&&X===3)if($>Y)return z("Away",Z,J,!1),!0;else if(Y>$)return z("Home",Z,J,!1),!0;else return!1;if(!Q&&X<3&&Y>$)return z("Home",Z,J,!1),!0;return!1}var f=document.getElementById("home-team-select"),d=document.getElementById("away-team-select"),TM=document.getElementById("load-teams-btn"),F=document.getElementById("status"),KM=document.getElementById("lineups-container"),e=document.getElementById("game-state-container"),k=document.getElementById("next-atbat-btn"),p=document.getElementById("atbat-result-container"),yM=document.getElementById("customize-home-lineup-btn"),WM=document.getElementById("customize-away-lineup-btn"),c=document.getElementById("custom-lineup-modal"),DM=document.getElementById("close-lineup-modal"),OM=document.getElementById("lineup-modal-title"),CM=document.getElementById("custom-lineup-form"),m=document.getElementById("batting-order-list"),i=document.getElementById("pitcher-select"),w=document.getElementById("lineup-error"),MM=document.getElementById("steal-2b-btn"),qM=document.getElementById("steal-3b-btn"),zM=document.getElementById("steal-home-btn"),JM=document.getElementById("pickoff-1b-btn"),QM=document.getElementById("pickoff-2b-btn"),XM=document.getElementById("pickoff-3b-btn"),_M=document.getElementById("simulate-full-game-btn");function vM(q,z){if(!KM)return;KM.innerHTML="";let J=(Q,X)=>{if(!Q)return`<div><strong>${X}:</strong> Not loaded</div>`;let Z=Q.lineup||Q.batters||[],$=Q.pitcher||Q.pitchers&&Q.pitchers[0]||{name:"N/A"};return`
      <div style="margin-bottom:1.5em;">
        <strong>${X} Lineup</strong>
        <table class="lineup-table">
          <thead><tr><th>#</th><th>Name</th><th>PA</th></tr></thead>
          <tbody>
            ${(Z||[]).slice(0,9).map((Y,N)=>`<tr><td>${N+1}</td><td>${Y.name||""}</td><td>${Y.PA||""}</td></tr>`).join("")}
          </tbody>
        </table>
        <div><strong>Pitcher:</strong> ${$.name}</div>
      </div>
    `};KM.innerHTML=`
    <div style="display:flex;gap:2em;flex-wrap:wrap;">
      <div style="flex:1;min-width:250px;">${J(q,"Home")}</div>
      <div style="flex:1;min-width:250px;">${J(z,"Away")}</div>
    </div>
  `}function G(q,z,J,Q,X,Z,$){if(!e)return;if(!q||!z||!J){if(e.innerHTML="<em>Game not started.</em>",k)k.style.display="none";return}let Y=q,{inning:N,top:V,outs:K,bases:E,score:T,lineupIndices:U}=Y,C=V?0:1,R=C===0?X:Q,x=C===0?J:z;if(!x){if(e.innerHTML="<em>Roster not loaded.</em>",k)k.style.display="none";return}let _=U[C]%x.lineup.length,v=x.lineup[_],j=(C===0?z:J).pitcher,D=["1B","2B","3B"].map((I,W)=>Y.bases[W]?I:"").filter(Boolean).join(", ")||"Empty";if(e.innerHTML=`
    <div><strong>Inning:</strong> ${N} (${V?"Top":"Bottom"})</div>
    <div><strong>Outs:</strong> ${K}</div>
    <div><strong>Bases:</strong> ${D}</div>
    <div><strong>Score:</strong> Away ${T[0]} &ndash; Home ${T[1]}</div>
    <div style="margin-top:1em;"><strong>At Bat:</strong> ${v.name} (vs ${j.name})</div>
  `,k)k.style.display=""}function l(q,z,J){if(!p)return;if(!q)return;z.push(q),J()}function P(q){if(!p)return;p.innerHTML="";let z=null,J=null;for(let Q of q){if(Q.inning!==z||Q.top!==J){let $=document.createElement("div");$.style.marginTop="1em",$.style.fontWeight="bold",$.textContent=`Inning ${Q.inning} - ${Q.top?"Top":"Bottom"}`,p.appendChild($),z=Q.inning,J=Q.top}let X=["1B","2B","3B"].map(($,Y)=>Q.bases[Y]?$:"").filter(Boolean).join(", ")||"Empty",Z=document.createElement("div");Z.innerHTML=`<strong>${Q.batterName}:</strong> ${Q.outcome} <span style="color:#888">(Outs: ${Q.outs}, Score: Away ${Q.score[0]} – Home ${Q.score[1]}, Bases: ${X})</span>`,p.appendChild(Z)}}function A(q,z){q(),z()}var M={loadedHome:null,loadedAway:null,homeRoster:null,awayRoster:null,homeFielders:null,awayFielders:null,homeMatchups:null,awayMatchups:null,gameState:null,lastRenderedInning:1,lastRenderedTop:!0,customHomeLineup:null,customHomePitcher:null,customAwayLineup:null,customAwayPitcher:null,editingTeam:null,atBatLog:[]};async function sM(){return["ARI-2025.html","ATL-2025.html","BAL-2025.html","BOS-2025.html","CHC-2025.html","CHW-2025.html","CIN-2025.html","CLE-2025.html","COL-2025.html","DET-2025.html","HOU-2025.html","KCR-2025.html","LAA-2025.html","LAD-2025.html","MIA-2025.html","MIL-2025.html","MIN-2025.html","NYM-2025.html","NYY-2025.html","OAK-2025.html","PHI-2025.html","PIT-2025.html","SDP-2025.html","SEA-2025.html","SFG-2025.html","STL-2025.html","TBR-2025.html","TEX-2025.html","TOR-2025.html","WSN-2025.html"]}async function hM(q){let J=await(await fetch(`./data/${q}`)).text(),{batting:Q,pitching:X,fielding:Z}=kM(J),$=Q?YM(Q):[],Y=X?YM(X):[],N=Z?YM(Z):[],V=xM($),K=FM(Y),E=wM(N);console.log(`All fieldersRaw for ${q}:`,N.map((U)=>U.name));let T=N.find((U)=>U.name.includes("Moreno"));return console.log(`${q} Gabriel Moreno fielding raw:`,T),console.log("Fielding table found:",!!Z,Z),{batters:V,pitchers:K,fielders:E}}function o(q,z){let J=q.find((X)=>X.position===z);if(J)return J;let Q=q.find((X)=>X.positions&&X.positions.includes(z));if(Q)return Q;return q.find((X)=>X.stats)||{stats:{armStrength:50,FP:0.985}}}function uM(q,z,J,Q){let X=document.querySelector(".sticky-action-bar");if(X)X.querySelectorAll("button").forEach(($)=>{$.disabled=!0,$.classList.add("disabled-greyed")});if(F)F.textContent=`Game Over: ${q} wins! Final Score: Away ${z[0]} – Home ${z[1]} (${J}${Q?" Top":" Bottom"})`;if(p){let Z=document.createElement("div");Z.style.marginTop="1em",Z.style.fontWeight="bold",Z.style.color="#b00",Z.textContent=`Game Over: ${q} wins! Final Score: Away ${z[0]} – Home ${z[1]} (${J}${Q?" Top":" Bottom"})`,p.appendChild(Z)}}function fM(){if(!M.homeRoster||!M.awayRoster)return;M.homeMatchups=a(M.homeRoster),M.awayMatchups=a(M.awayRoster),M.gameState=RM(),M.atBatLog=[],P(M.atBatLog),A(()=>G(M.gameState,M.homeRoster,M.awayRoster,M.homeMatchups,M.awayMatchups,M.lastRenderedInning,M.lastRenderedTop),u)}function dM(){if(!M.gameState||!M.homeMatchups||!M.awayMatchups||!M.homeRoster||!M.awayRoster)return;let q=M.gameState,z=q.top?0:1,J=z===0?M.awayRoster:M.homeRoster,Q=q.lineupIndices[z]%J.lineup.length,X=J.lineup[Q],Z=BM(M.awayMatchups,M.homeMatchups,q,[],[],M.awayRoster,M.homeRoster);if(l({batterName:X.name,outcome:Z.outcome,outs:q.outs,score:[...q.score],bases:q.bases.map((V)=>V?1:0),inning:q.inning,top:q.top},M.atBatLog,()=>P(M.atBatLog)),UM({inning:q.inning,top:q.top,score:q.score,outs:q.outs},uM)){A(()=>G(M.gameState,M.homeRoster,M.awayRoster,M.homeMatchups,M.awayMatchups,M.lastRenderedInning,M.lastRenderedTop),u);return}let Y="",N=!1;if(q.outs>=3){if(q.bases=[null,null,null],q.outs=0,q.top)q.top=!1,Y="End of top half. Switching to bottom of inning.";else q.top=!0,q.inning++,Y="End of inning. Advancing to next inning.";N=!0}if(N){if(UM({inning:q.inning,top:q.top,score:q.score,outs:q.outs},uM)){A(()=>G(M.gameState,M.homeRoster,M.awayRoster,M.homeMatchups,M.awayMatchups,M.lastRenderedInning,M.lastRenderedTop),u);return}}if(Y)l({batterName:"System",outcome:Y,outs:q.outs,score:[...q.score],bases:q.bases.map((V)=>V?1:0),inning:q.inning,top:q.top},M.atBatLog,()=>P(M.atBatLog));A(()=>G(M.gameState,M.homeRoster,M.awayRoster,M.homeMatchups,M.awayMatchups,M.lastRenderedInning,M.lastRenderedTop),u)}function rM(){if(!M.gameState||!M.homeMatchups||!M.awayMatchups)fM();while(M.gameState&&k&&!k.disabled)dM()}async function IM(){if(!f||!d||!F)return;let q=f.value,z=d.value;if(!q||!z)return;F.textContent="Loading lineups...";try{let[J,Q]=await Promise.all([hM(q),hM(z)]);M.loadedHome=J,M.loadedAway=Q,M.homeFielders=J.fielders,M.awayFielders=Q.fielders,M.homeRoster=J&&J.batters&&J.pitchers?r(M.customHomeLineup&&M.customHomeLineup.length===9?M.customHomeLineup:J.batters.slice(0,9).map((X)=>X.player_id),M.customHomePitcher||J.pitchers[0].player_id,J.batters,J.pitchers):null,M.awayRoster=Q&&Q.batters&&Q.pitchers?r(M.customAwayLineup&&M.customAwayLineup.length===9?M.customAwayLineup:Q.batters.slice(0,9).map((X)=>X.player_id),M.customAwayPitcher||Q.pitchers[0].player_id,Q.batters,Q.pitchers):null,vM(M.homeRoster,M.awayRoster),M.atBatLog=[],P(M.atBatLog),F.textContent="Lineups loaded. Ready to simulate!",console.log("--- Home Roster (normalized, ready for engine) ---"),console.log(JSON.stringify(M.homeRoster,null,2)),console.log("--- Away Roster (normalized, ready for engine) ---"),console.log(JSON.stringify(M.awayRoster,null,2)),fM()}catch(J){F.textContent="Failed to load lineups."}}async function pM(){if(!F)return;F.textContent="Loading teams...";let q=await sM();if(!q.length){F.textContent="No teams found in data folder.";return}for(let z of[f,d]){if(!z)continue;z.innerHTML="";for(let J of q){let Q=document.createElement("option");Q.value=J,Q.textContent=J.replace(".html",""),z.appendChild(Q)}}if(f)f.value="CHC-2025.html";if(d)d.value="MIL-2025.html";if(F.textContent="Select home and away teams.",f&&d)IM()}function aM(){if(!M.loadedHome||!M.loadedAway)return;if(M.homeRoster=M.loadedHome&&M.loadedHome.batters&&M.loadedHome.pitchers?r(M.customHomeLineup&&M.customHomeLineup.length===9?M.customHomeLineup:M.loadedHome.batters.slice(0,9).map((q)=>q.player_id),M.customHomePitcher||M.loadedHome.pitchers[0].player_id,M.loadedHome.batters,M.loadedHome.pitchers):null,M.awayRoster=M.loadedAway&&M.loadedAway.batters&&M.loadedAway.pitchers?r(M.customAwayLineup&&M.customAwayLineup.length===9?M.customAwayLineup:M.loadedAway.batters.slice(0,9).map((q)=>q.player_id),M.customAwayPitcher||M.loadedAway.pitchers[0].player_id,M.loadedAway.batters,M.loadedAway.pitchers):null,M.homeRoster&&M.awayRoster)M.homeMatchups=a({lineup:M.homeRoster.lineup,pitcher:M.awayRoster.pitcher}),M.awayMatchups=a({lineup:M.awayRoster.lineup,pitcher:M.homeRoster.pitcher});vM(M.homeRoster,M.awayRoster),G(M.gameState,M.homeRoster,M.awayRoster,M.homeMatchups,M.awayMatchups,M.lastRenderedInning,M.lastRenderedTop)}function lM(q,z,J,Q,X){if(M.editingTeam=q,!c||!OM||!m||!i)return;if(OM.textContent=`Customize ${q==="home"?"Home":"Away"} Lineup`,w)w.textContent="";c.style.display="flex";let Z=Q,$=X;if(q==="home"&&M.homeRoster)Z=M.homeRoster.lineup?M.homeRoster.lineup.map((Y)=>Y.player_id):Q,$=M.homeRoster.pitcher?M.homeRoster.pitcher.player_id:X;else if(q==="away"&&M.awayRoster)Z=M.awayRoster.lineup?M.awayRoster.lineup.map((Y)=>Y.player_id):Q,$=M.awayRoster.pitcher?M.awayRoster.pitcher.player_id:X;m.innerHTML="";for(let Y=0;Y<9;Y++){let N=document.createElement("li"),V=document.createElement("select");if(V.name=`batter${Y}`,V.required=!0,V.innerHTML='<option value="">-- Select --</option>'+z.map((K)=>`<option value="${K.player_id}">${K.name} (${K.PA} PA)</option>`).join(""),Z&&Z[Y])V.value=Z[Y];N.appendChild(V),m.appendChild(N)}if(i.innerHTML='<option value="">-- Select --</option>'+J.map((Y)=>`<option value="${Y.player_id}">${Y.name} (${Y.stats&&Y.stats.IP?Y.stats.IP:""} IP)</option>`).join(""),$)i.value=$}function u(){if(!M.gameState)return;if(MM)MM.disabled=!M.gameState.bases[0];if(qM)qM.disabled=!M.gameState.bases[1];if(zM)zM.disabled=!M.gameState.bases[2];if(JM)JM.disabled=!M.gameState.bases[0];if(QM)QM.disabled=!M.gameState.bases[1];if(XM)XM.disabled=!M.gameState.bases[2]}if(TM)TM.addEventListener("click",pM);if(f)f.addEventListener("change",IM);if(d)d.addEventListener("change",IM);if(k)k.addEventListener("click",dM);if(yM)yM.addEventListener("click",()=>{if(!M.loadedHome)return;lM("home",M.loadedHome.batters,M.loadedHome.pitchers,M.customHomeLineup,M.customHomePitcher)});if(WM)WM.addEventListener("click",()=>{if(!M.loadedAway)return;lM("away",M.loadedAway.batters,M.loadedAway.pitchers,M.customAwayLineup,M.customAwayPitcher)});if(DM)DM.addEventListener("click",()=>{if(c)c.style.display="none"});if(CM)CM.addEventListener("submit",(q)=>{if(q.preventDefault(),!m||!i)return;let z=[],J=m.querySelectorAll("select");for(let X of J){if(!X.value){if(w)w.textContent="Please select a player for every lineup slot.";return}z.push(X.value)}if(new Set(z).size!==z.length){if(w)w.textContent="No duplicate players allowed in the lineup.";return}let Q=i.value;if(!Q){if(w)w.textContent="Please select a starting pitcher.";return}if(z.includes(Q)){if(w)w.textContent="Pitcher cannot also be in the batting lineup.";return}if(M.editingTeam==="home")M.customHomeLineup=z,M.customHomePitcher=Q;else M.customAwayLineup=z,M.customAwayPitcher=Q;if(c)c.style.display="none";aM()});window.addEventListener("DOMContentLoaded",()=>{pM()});if(MM)MM.addEventListener("click",()=>{if(!M.gameState||!M.homeRoster||!M.awayRoster)return;let q=M.gameState.top?0:1,z=q===0?M.awayRoster:M.homeRoster,J=q===0?M.homeRoster:M.awayRoster,Q=q===0?M.homeFielders:M.awayFielders,X=M.gameState.bases[0];if(!X)return;let Z=Q?o(Q,"C"):{stats:{armStrength:50}},$=J.pitcher;console.log("UI runner object:",X),console.log("UI catcher object:",Z);let Y=VM(2,M.gameState,X,$,Z,1);l({batterName:X.name,outcome:Y.description,outs:M.gameState.outs,score:[...M.gameState.score],bases:M.gameState.bases.map((N)=>N?1:0),inning:M.gameState.inning,top:M.gameState.top},M.atBatLog,()=>P(M.atBatLog)),A(()=>G(M.gameState,M.homeRoster,M.awayRoster,M.homeMatchups,M.awayMatchups,M.lastRenderedInning,M.lastRenderedTop),u)});if(qM)qM.addEventListener("click",()=>{if(!M.gameState||!M.homeRoster||!M.awayRoster)return;let q=M.gameState.top?0:1,z=q===0?M.awayRoster:M.homeRoster,J=q===0?M.homeRoster:M.awayRoster,Q=q===0?M.homeFielders:M.awayFielders,X=M.gameState.bases[1];if(!X)return;let Z=Q?o(Q,"C"):{stats:{armStrength:50}},$=J.pitcher,Y=VM(3,M.gameState,X,$,Z,2);l({batterName:X.name,outcome:Y.description,outs:M.gameState.outs,score:[...M.gameState.score],bases:M.gameState.bases.map((N)=>N?1:0),inning:M.gameState.inning,top:M.gameState.top},M.atBatLog,()=>P(M.atBatLog)),A(()=>G(M.gameState,M.homeRoster,M.awayRoster,M.homeMatchups,M.awayMatchups,M.lastRenderedInning,M.lastRenderedTop),u)});if(zM)zM.addEventListener("click",()=>{if(!M.gameState||!M.homeRoster||!M.awayRoster)return;let q=M.gameState.top?0:1,z=q===0?M.awayRoster:M.homeRoster,J=q===0?M.homeRoster:M.awayRoster,Q=q===0?M.homeFielders:M.awayFielders,X=M.gameState.bases[2];if(!X)return;let Z=Q?o(Q,"C"):{stats:{armStrength:50}},$=J.pitcher,Y=VM(4,M.gameState,X,$,Z,3);l({batterName:X.name,outcome:Y.description,outs:M.gameState.outs,score:[...M.gameState.score],bases:M.gameState.bases.map((N)=>N?1:0),inning:M.gameState.inning,top:M.gameState.top},M.atBatLog,()=>P(M.atBatLog)),A(()=>G(M.gameState,M.homeRoster,M.awayRoster,M.homeMatchups,M.awayMatchups,M.lastRenderedInning,M.lastRenderedTop),u)});if(JM)JM.addEventListener("click",()=>{if(!M.gameState||!M.homeRoster||!M.awayRoster)return;let q=M.gameState.top?0:1,z=q===0?M.awayRoster:M.homeRoster,J=q===0?M.homeRoster:M.awayRoster,Q=q===0?M.homeFielders:M.awayFielders,X=M.gameState.bases[0];if(!X)return;let Z=Q?o(Q,"1B"):{stats:{FP:0.985}},$=J.pitcher,Y=EM(1,M.gameState,X,$,Z);l({batterName:X.name,outcome:Y.description,outs:M.gameState.outs,score:[...M.gameState.score],bases:M.gameState.bases.map((N)=>N?1:0),inning:M.gameState.inning,top:M.gameState.top},M.atBatLog,()=>P(M.atBatLog)),A(()=>G(M.gameState,M.homeRoster,M.awayRoster,M.homeMatchups,M.awayMatchups,M.lastRenderedInning,M.lastRenderedTop),u)});if(QM)QM.addEventListener("click",()=>{if(!M.gameState||!M.homeRoster||!M.awayRoster)return;let q=M.gameState.top?0:1,z=q===0?M.awayRoster:M.homeRoster,J=q===0?M.homeRoster:M.awayRoster,Q=q===0?M.homeFielders:M.awayFielders,X=M.gameState.bases[1];if(!X)return;let Z=Q?o(Q,"2B"):{stats:{FP:0.985}},$=J.pitcher,Y=EM(2,M.gameState,X,$,Z);l({batterName:X.name,outcome:Y.description,outs:M.gameState.outs,score:[...M.gameState.score],bases:M.gameState.bases.map((N)=>N?1:0),inning:M.gameState.inning,top:M.gameState.top},M.atBatLog,()=>P(M.atBatLog)),A(()=>G(M.gameState,M.homeRoster,M.awayRoster,M.homeMatchups,M.awayMatchups,M.lastRenderedInning,M.lastRenderedTop),u)});if(XM)XM.addEventListener("click",()=>{if(!M.gameState||!M.homeRoster||!M.awayRoster)return;let q=M.gameState.top?0:1,z=q===0?M.awayRoster:M.homeRoster,J=q===0?M.homeRoster:M.awayRoster,Q=q===0?M.homeFielders:M.awayFielders,X=M.gameState.bases[2];if(!X)return;let Z=Q?o(Q,"3B"):{stats:{FP:0.985}},$=J.pitcher,Y=EM(3,M.gameState,X,$,Z);l({batterName:X.name,outcome:Y.description,outs:M.gameState.outs,score:[...M.gameState.score],bases:M.gameState.bases.map((N)=>N?1:0),inning:M.gameState.inning,top:M.gameState.top},M.atBatLog,()=>P(M.atBatLog)),A(()=>G(M.gameState,M.homeRoster,M.awayRoster,M.homeMatchups,M.awayMatchups,M.lastRenderedInning,M.lastRenderedTop),u)});if(_M)_M.addEventListener("click",rM);
