function E0(q){const J=/<!--([\s\S]*?)-->/g,Q=[];let U;while((U=J.exec(q))!==null)Q.push(U[1]);return Q}function G0(q,J){const Q=new DOMParser;for(let U of q)if(U.includes(`id="${J}"`))return Q.parseFromString(U,"text/html").querySelector(`table#${J}`)||null;return null}function m(q){const J=document.createElement("div");J.style.display="none",document.body.appendChild(J),J.innerHTML=q;const Q=J.querySelector("table#players_standard_batting"),U=J.querySelector("table#players_standard_pitching"),X=E0(q),Z=G0(X,"players_standard_fielding");return J.remove(),{batting:Q,pitching:U,fielding:Z}}function o(q){if(!q||!q.href)return null;const J=q.href.match(/\/players\/.\/([^/.]+)\.shtml/);return J?J[1]:null}function _0(q){return q.toLowerCase().replace(/[^a-z0-9]/g,"").slice(0,12)}function g(q){if(!q)return[];const J=Array.from(q.querySelectorAll("tbody > tr")).filter((X)=>!X.classList.contains("thead")),Q=Array.from(q.querySelectorAll("thead tr th")).map((X)=>(X.textContent??"").trim()),U=[];for(let X of J){const Z=[X.querySelector("th"),...X.querySelectorAll("td")];if(Z.length!==Q.length)continue;const $={};for(let Y=0;Y<Q.length;Y++){const V=Q[Y],E=Z[Y];if(Y===0){let z=E?.textContent?.trim()||"",G=E?.querySelector?.("a")||null,W=o(G);if(/^\d+$/.test(z)){const _=X.querySelector("td");z=_?.textContent?.trim()||"(unknown)",G=_?.querySelector?.("a")||null,W=o(G)||W}$.name=z,$.player_id=W||_0(z)}else{const z=E?.textContent?.trim()||"",G=Number(z.replace(/,/g,""));$[V]=isNaN(G)?z:G}}U.push($)}return U}function n(q){return q.map((J)=>{const Q=Number(J.PA)||0,U=Number(J.AB)||0,X=Number(J.H)||0,Z=Number(J.HR)||0,$=Number(J.BB)||0,Y=Number(J.SO)||0,V=Number(J.SF)||0,E=Number(J.HBP)||0,z=Number(J["2B"])||0,G=Number(J["3B"])||0,W=X-z-G-Z,_=U-Y-Z+V,j=_>0?(X-Z)/_:null,L=Q>0?Y/Q:null,P=Q>0?$/Q:null,H=Q>0?Z/Q:null;return{name:J.name,player_id:J.player_id,PA:Q,stats:{H:X,HR:Z,BB:$,SO:Y,SF:V,HBP:E,singles:W,doubles:z,triples:G},rates:{kRate:L,bbRate:P,hrRate:H,BABIP:j}}})}function i(q){return q.map((J)=>{const Q=Number(J.IP)||0,U=Number(J.TBF)||0,X=Number(J.H)||0,Z=Number(J.HR)||0,$=Number(J.BB)||0,Y=Number(J.SO)||0,V=Number(J.HBP)||0,E=U>0?Y/U:null,z=U>0?$/U:null,G=U>0?Z/U:null,W=U-Y-Z-$-V,_=W>0?(X-Z)/W:null;return{name:J.name,player_id:J.player_id,TBF:U,stats:{IP:Q,H:X,HR:Z,BB:$,SO:Y,HBP:V},rates:{kRate:E,bbRate:z,hrRate:G,BABIP:_}}})}function w(q,J,Q,U){const X=q.map((Y)=>{const V=Q.find((E)=>E.player_id===Y);if(!V)throw new Error(`Lineup player not found: ${Y}`);return V}),Z=U.find((Y)=>Y.player_id===J);if(!Z)throw new Error(`Starting pitcher not found: ${J}`);const $=new Set;for(let Y of X){if($.has(Y.player_id))throw new Error(`Duplicate player in lineup: ${Y.player_id}`);$.add(Y.player_id)}if($.has(J))throw new Error(`Pitcher also appears in lineup: ${J}`);return{lineup:X,pitcher:Z}}function S(q,J){return(q+J)/2}function r(q,J){const Q=q.rates||{},U=J.rates||{},X=q.stats||{},Z=K(Q.kRate??0,"batter.kRate"),$=K(U.kRate??0,"pitcher.kRate"),Y=K(Q.bbRate??0,"batter.bbRate"),V=K(U.bbRate??0,"pitcher.bbRate"),E=K(Q.hrRate??0,"batter.hrRate"),z=K(U.hrRate??0,"pitcher.hrRate"),G=K(Q.BABIP??0.29,"batter.BABIP"),W=K(U.BABIP??0.29,"pitcher.BABIP"),_=Math.max(0,q.PA||0),j=Math.max(0,X.HBP??0),L=Math.max(0,X.singles??0),P=Math.max(0,X.doubles??0),H=Math.max(0,X.triples??0),h=K(S(Z,$),"K"),u=K(S(Y,V),"BB"),c=K(S(E,z),"HR"),Z0=K(S(G,W),"BABIP"),b=K(_>0?j/_:0,"HBP"),$0=h+u+b+c,p=Math.max(0,1-$0),x=Z0*p,V0=p-x,M=L+P+H,K0=M>0?L/M:0.7,z0=M>0?P/M:0.2,W0=M>0?H/M:0.1;return{K:K(h,"K"),BB:K(u,"BB"),HBP:K(b,"HBP"),HR:K(c,"HR"),"1B":K(x*K0,"1B"),"2B":K(x*z0,"2B"),"3B":K(x*W0,"3B"),Out:K(V0,"Out")}}function K(q,J){if(typeof q!=="number"||isNaN(q))return 0;if(q<0){if(J)console.warn(`[probabilityModel] Clamped negative value for ${J}: ${q} \u2192 0`);return 0}if(q>1){if(J)console.warn(`[probabilityModel] Clamped value >1 for ${J}: ${q} \u2192 1`);return 1}return q}function y(q){const{lineup:J,pitcher:Q}=q;return J.map((U)=>{const X=r(U,Q);return{batter_id:U.player_id,pitcher_id:Q.player_id,probabilities:X}})}function v(q){const J=Object.values(q).reduce((U,X)=>U+X,0);let Q=Math.random()*J;for(let[U,X]of Object.entries(q))if((Q-=X)<=0)return U;return Object.keys(q).pop()||""}function l(q){if(q==="Out"){const J=v(L0),Q=v(j0[J]);return`${J} to ${Q}`}return q}var L0={Groundout:0.45,Flyout:0.3,Lineout:0.15,Popout:0.1},j0={Groundout:{"1B":0.2,"2B":0.2,SS:0.25,"3B":0.2,P:0.15},Flyout:{LF:0.35,CF:0.45,RF:0.2},Lineout:{"1B":0.25,"2B":0.25,SS:0.25,"3B":0.25},Popout:{C:0.3,"1B":0.2,"2B":0.15,SS:0.2,"3B":0.15}};function a(){return{inning:1,top:!0,outs:0,bases:[0,0,0],lineupIndices:[0,0],score:[0,0]}}function s(q,J){let Q=0;const U=[0,0,0];for(let Z=2;Z>=0;Z--){if(!q[Z])continue;const $=Z+(J==="1B"?1:J==="2B"?2:J==="3B"?3:4);if($>=3)Q++;else U[$]=1}const X={"1B":0,"2B":1,"3B":2}[J];if(X!==void 0)U[X]=1;if(J==="HR")Q++;return[U,Q]}function t(q,J,Q,U,X){const Z=U||v,$=X||l,Y=Q.top?0:1,V=Y===0?q:J,E=Q.lineupIndices[Y],z=V[E%V.length],G=z.probabilities,W=Z(G),_=$(W);if(Q.lineupIndices[Y]++,W==="Out"||W==="K")Q.outs++;else if(W==="BB"||W==="HBP"){const[j,L]=s(Q.bases,"1B");Q.bases=j,Q.score[Y]+=L}else{const[j,L]=s(Q.bases,W);Q.bases=j,Q.score[Y]+=L}return{batter_id:z.batter_id,outcome:_}}async function f0(){return["CHC-2025.html","MIL-2025.html","PIT-2025.html"]}async function Q0(q){const Q=await(await fetch(`./data/${q}`)).text(),{batting:U,pitching:X}=m(Q),Z=U?g(U):[],$=X?g(X):[],Y=n(Z),V=i($);return{batters:Y,pitchers:V}}function D0(q,J){if(!R)return;R.innerHTML="";const Q=(U,X)=>{if(!U)return`<div><strong>${X}:</strong> Not loaded</div>`;const Z=U.pitchers&&U.pitchers[0]||{name:"N/A"};return`
      <div style="margin-bottom:1.5em;">
        <strong>${X} Lineup</strong>
        <table class="lineup-table">
          <thead><tr><th>#</th><th>Name</th><th>PA</th></tr></thead>
          <tbody>
            ${(U.batters||[]).slice(0,9).map(($,Y)=>`<tr><td>${Y+1}</td><td>${$.name||""}</td><td>${$.PA||""}</td></tr>`).join("")}
          </tbody>
        </table>
        <div><strong>Pitcher:</strong> ${Z.name}</div>
      </div>
    `};R.innerHTML=`
    <div style="display:flex;gap:2em;flex-wrap:wrap;">
      <div style="flex:1;min-width:250px;">${Q(q,"Home")}</div>
      <div style="flex:1;min-width:250px;">${Q(J,"Away")}</div>
    </div>
  `}function U0(){if(!I)return;if(!A||!k||!C){if(I.innerHTML="<em>Game not started.</em>",O)O.style.display="none";return}const q=A,{inning:J,top:Q,outs:U,bases:X,score:Z,lineupIndices:$}=q,Y=Q?0:1,V=Y===0?T:F,E=Y===0?C:k;if(!E){if(I.innerHTML="<em>Roster not loaded.</em>",O)O.style.display="none";return}const z=$[Y]%E.lineup.length,G=E.lineup[z],W=(Y===0?k:C).pitcher,_=["1B","2B","3B"].map((j,L)=>q.bases[L]?j:"").filter(Boolean).join(", ")||"Empty";if(I.innerHTML=`
    <div><strong>Inning:</strong> ${J} (${Q?"Top":"Bottom"})</div>
    <div><strong>Outs:</strong> ${U}</div>
    <div><strong>Bases:</strong> ${_}</div>
    <div><strong>Score:</strong> Away ${Z[0]} &ndash; Home ${Z[1]}</div>
    <div style="margin-top:1em;"><strong>At Bat:</strong> ${G.name} (vs ${W.name})</div>
  `,O)O.style.display=""}function X0(q,J=!1){if(!B)return;if(!q)return;if(J){const X=document.createElement("div");X.style.marginTop="1em",X.style.fontWeight="bold",X.textContent=`Inning ${q.inning} - ${q.top?"Top":"Bottom"}`,B.appendChild(X)}const Q=["1B","2B","3B"].map((X,Z)=>q.bases[Z]?X:"").filter(Boolean).join(", ")||"Empty",U=document.createElement("div");U.innerHTML=`<strong>Batter:</strong> ${q.batterName}<br><strong>Result:</strong> ${q.outcome}<br><strong>Outs:</strong> ${q.outs} &nbsp; <strong>Score:</strong> Away ${q.score[0]} \u2013 Home ${q.score[1]} &nbsp; <strong>Bases:</strong> ${Q}`,B.appendChild(U)}function k0(){if(!k||!C)return;F=y(k),T=y(C),A=a(),U0(),X0(null)}function C0(){if(!A||!F||!T)return;const q=A,J=q.top?0:1,Q=J===0?T:F,U=J===0?C:k;if(!U)return;const X=q.lineupIndices[J]%U.lineup.length,Z=U.lineup[X],$=t(T,F,q);let Y="",V=!1;if(q.outs>=3)if(q.outs=0,q.bases=[0,0,0],q.top)q.top=!1,Y="End of top half. Switching to bottom of inning.",V=!0;else q.top=!0,q.inning++,Y="End of inning. Advancing to next inning.",V=!0;else if(q.inning!==q0||q.top!==J0)V=!0;if(V)q0=q.inning,J0=q.top;X0({batterName:Z.name,outcome:$.outcome+(Y?`<br><em>${Y}</em>`:""),outs:q.outs,score:[...q.score],bases:[...q.bases],inning:q.inning,top:q.top},V),U0()}async function d(){if(!N||!f||!D)return;const q=N.value,J=f.value;if(!q||!J)return;D.textContent="Loading lineups...";try{const[Q,U]=await Promise.all([Q0(q),Q0(J)]);O0=Q,N0=U,k=Q&&Q.batters&&Q.pitchers?w(Q.batters.slice(0,9).map((X)=>X.player_id),Q.pitchers[0].player_id,Q.batters,Q.pitchers):null,C=U&&U.batters&&U.pitchers?w(U.batters.slice(0,9).map((X)=>X.player_id),U.pitchers[0].player_id,U.batters,U.pitchers):null,D0(Q,U),D.textContent="Lineups loaded. Ready to simulate!",k0()}catch(Q){D.textContent="Failed to load lineups."}}async function Y0(){if(!D)return;D.textContent="Loading teams...";const q=await f0();if(!q.length){D.textContent="No teams found in data folder.";return}for(let J of[N,f]){if(!J)continue;J.innerHTML="";for(let Q of q){const U=document.createElement("option");U.value=Q,U.textContent=Q.replace(".html",""),J.appendChild(U)}}if(N)N.value="CHC-2025.html";if(f)f.value="MIL-2025.html";if(D.textContent="Select home and away teams.",N&&f)d()}var N=document.getElementById("home-team-select"),f=document.getElementById("away-team-select"),e=document.getElementById("load-teams-btn"),D=document.getElementById("status"),R=document.getElementById("lineups-container"),I=document.getElementById("game-state-container"),O=document.getElementById("next-atbat-btn"),B=document.getElementById("atbat-result-container"),O0=null,N0=null,k=null,C=null,F=null,T=null,A=null,q0=1,J0=!0;if(e)e.addEventListener("click",Y0);if(N)N.addEventListener("change",d);if(f)f.addEventListener("change",d);if(O)O.addEventListener("click",C0);window.addEventListener("DOMContentLoaded",()=>{Y0()});
