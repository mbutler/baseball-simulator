function h0(q){let J=/<!--([\s\S]*?)-->/g,Q=[],U;while((U=J.exec(q))!==null)Q.push(U[1]);return Q}function d0(q,J){let Q=new DOMParser;for(let U of q)if(U.includes(`id="${J}"`))return Q.parseFromString(U,"text/html").querySelector(`table#${J}`)||null;return null}function W0(q){let J=document.createElement("div");J.style.display="none",document.body.appendChild(J),J.innerHTML=q;let Q=J.querySelector("table#players_standard_batting"),U=J.querySelector("table#players_standard_pitching"),X=h0(q),Y=d0(X,"players_standard_fielding");return J.remove(),{batting:Q,pitching:U,fielding:Y}}function G0(q){if(!q||!q.href)return null;let J=q.href.match(/\/players\/.\/([^/.]+)\.shtml/);return J?J[1]:null}function b0(q){return q.toLowerCase().replace(/[^a-z0-9]/g,"").slice(0,12)}function V0(q){if(!q)return[];let J=Array.from(q.querySelectorAll("tbody > tr")).filter((X)=>!X.classList.contains("thead")),Q=Array.from(q.querySelectorAll("thead tr th")).map((X)=>(X.textContent??"").trim()),U=[];for(let X of J){let Y=[X.querySelector("th"),...X.querySelectorAll("td")];if(Y.length!==Q.length)continue;let Z={};for(let V=0;V<Q.length;V++){let K=Q[V],z=Y[V];if(V===0){let N=z?.textContent?.trim()||"",W=z?.querySelector?.("a")||null,E=G0(W);if(/^\d+$/.test(N)){let O=X.querySelector("td");N=O?.textContent?.trim()||"(unknown)",W=O?.querySelector?.("a")||null,E=G0(W)||E}Z.name=N,Z.player_id=E||b0(N)}else{let N=z?.textContent?.trim()||"",W=Number(N.replace(/,/g,""));Z[K]=isNaN(W)?N:W}}U.push(Z)}return U}function E0(q){return q.map((J)=>{let Q=Number(J.PA)||0,U=Number(J.AB)||0,X=Number(J.H)||0,Y=Number(J.HR)||0,Z=Number(J.BB)||0,V=Number(J.SO)||0,K=Number(J.SF)||0,z=Number(J.HBP)||0,N=Number(J["2B"])||0,W=Number(J["3B"])||0,E=X-N-W-Y,O=U-V-Y+K,v=O>0?(X-Y)/O:null,H=Q>0?V/Q:null,C=Q>0?Z/Q:null,A=Q>0?Y/Q:null;return{name:J.name,player_id:J.player_id,PA:Q,stats:{H:X,HR:Y,BB:Z,SO:V,SF:K,HBP:z,singles:E,doubles:N,triples:W},rates:{kRate:H,bbRate:C,hrRate:A,BABIP:v}}})}function O0(q){return q.map((J)=>{let Q=Number(J.IP)||0,U=Number(J.TBF)||0,X=Number(J.H)||0,Y=Number(J.HR)||0,Z=Number(J.BB)||0,V=Number(J.SO)||0,K=Number(J.HBP)||0,z=U>0?V/U:null,N=U>0?Z/U:null,W=U>0?Y/U:null,E=U-V-Y-Z-K,O=E>0?(X-Y)/E:null;return{name:J.name,player_id:J.player_id,TBF:U,stats:{IP:Q,H:X,HR:Y,BB:Z,SO:V,HBP:K},rates:{kRate:z,bbRate:N,hrRate:W,BABIP:O}}})}function Z0(q,J,Q,U){let X=q.map((V)=>{let K=Q.find((z)=>z.player_id===V);if(!K)throw new Error(`Lineup player not found: ${V}`);return K}),Y=U.find((V)=>V.player_id===J);if(!Y)throw new Error(`Starting pitcher not found: ${J}`);let Z=new Set;for(let V of X){if(Z.has(V.player_id))throw new Error(`Duplicate player in lineup: ${V.player_id}`);Z.add(V.player_id)}if(Z.has(J))throw new Error(`Pitcher also appears in lineup: ${J}`);return{lineup:X,pitcher:Y}}function e(q,J){return(q+J)/2}function D0(q,J){let Q=q.rates||{},U=J.rates||{},X=q.stats||{},Y=G(Q.kRate??0,"batter.kRate"),Z=G(U.kRate??0,"pitcher.kRate"),V=G(Q.bbRate??0,"batter.bbRate"),K=G(U.bbRate??0,"pitcher.bbRate"),z=G(Q.hrRate??0,"batter.hrRate"),N=G(U.hrRate??0,"pitcher.hrRate"),W=G(Q.BABIP??0.29,"batter.BABIP"),E=G(U.BABIP??0.29,"pitcher.BABIP"),O=Math.max(0,q.PA||0),v=Math.max(0,X.HBP??0),H=Math.max(0,X.singles??0),C=Math.max(0,X.doubles??0),A=Math.max(0,X.triples??0),D=G(e(Y,Z),"K"),F=G(e(V,K),"BB"),R=G(e(z,N),"HR"),$0=G(e(W,E),"BABIP"),T=G(O>0?v/O:0,"HBP"),M=D+F+T+R,a=Math.max(0,1-M),B=$0*a,t=a-B,x=H+C+A,R0=x>0?H/x:0.7,B0=x>0?C/x:0.2,f0=x>0?A/x:0.1;return{K:G(D,"K"),BB:G(F,"BB"),HBP:G(T,"HBP"),HR:G(R,"HR"),"1B":G(B*R0,"1B"),"2B":G(B*B0,"2B"),"3B":G(B*f0,"3B"),Out:G(t,"Out")}}function G(q,J){if(typeof q!=="number"||isNaN(q))return 0;if(q<0){if(J)console.warn(`[probabilityModel] Clamped negative value for ${J}: ${q} → 0`);return 0}if(q>1){if(J)console.warn(`[probabilityModel] Clamped value >1 for ${J}: ${q} → 1`);return 1}return q}function K0(q){let{lineup:J,pitcher:Q}=q;return J.map((U)=>{let X=D0(U,Q);return{batter_id:U.player_id,pitcher_id:Q.player_id,probabilities:X}})}function i(q){let J=Object.values(q).reduce((U,X)=>U+X,0),Q=Math.random()*J;for(let[U,X]of Object.entries(q))if((Q-=X)<=0)return U;return Object.keys(q).pop()||""}var u0={Groundout:0.45,Flyout:0.3,Lineout:0.15,Popout:0.1},p0={Groundout:{"1B":0.2,"2B":0.2,SS:0.25,"3B":0.2,P:0.15},Flyout:{LF:0.35,CF:0.45,RF:0.2},Lineout:{"1B":0.25,"2B":0.25,SS:0.25,"3B":0.25},Popout:{C:0.3,"1B":0.2,"2B":0.15,SS:0.2,"3B":0.15}};function C0(q){if(q==="Out"){let J=i(u0),Q=i(p0[J]);return`${J} to ${Q}`}return q}function M0(){return{inning:1,top:!0,outs:0,bases:[0,0,0],lineupIndices:[0,0],score:[0,0]}}function _0(q,J){let Q=0,U=[0,0,0];for(let Y=2;Y>=0;Y--){if(!q[Y])continue;let Z=Y+(J==="1B"?1:J==="2B"?2:J==="3B"?3:4);if(Z>=3)Q++;else U[Z]=1}let X={"1B":0,"2B":1,"3B":2}[J];if(X!==void 0)U[X]=1;if(J==="HR")Q++;return[U,Q]}function T0(q,J,Q,U,X,Y,Z){let V=Y||i,K=Z||C0,z=Q.top?0:1,N=z===0?q:J,W=z===0?X:U,E=Array.isArray(W)?W:[],O=Q.lineupIndices[z],v=N[O%N.length],H=v.probabilities,C=V(H),A=K(C);Q.lineupIndices[z]++;let D=void 0,F="",R=!1,$0=!1;if(C==="Out"){let T=A.match(/to ([A-Z0-9]+)/);if(T){if(F=T[1],D=E.find((M)=>M.position===F),D&&D.stats){let M=Number(D.stats.E)||0,a=Number(D.stats.PO)||0,B=Number(D.stats.A)||0,t=a+B+M,x=t>0?M/t:0.01;if(Math.random()<x)R=!0}else if(Math.random()<0.01)R=!0}}if(C==="Out"&&/^Groundout to [A-Z0-9]+$/.test(A)&&Q.outs<2&&Q.bases[0]===1){if(Math.random()<0.25)return $0=!0,Q.bases[0]=0,Q.outs=Math.min(Q.outs+2,3),{batter_id:v.batter_id,outcome:"Grounded into double play",...D?{fielder:D,fielderPosition:F}:{}}}if(R){let[T,M]=_0(Q.bases,"1B");return Q.bases=T,Q.score[z]+=M,{batter_id:v.batter_id,outcome:`Error on ${F}`,fielder:D,fielderPosition:F}}if(C==="Out"||C==="K")Q.outs++;else if(C==="BB"||C==="HBP"){let[T,M]=_0(Q.bases,"1B");Q.bases=T,Q.score[z]+=M}else{let[T,M]=_0(Q.bases,C);Q.bases=T,Q.score[z]+=M}return{batter_id:v.batter_id,outcome:A,...D?{fielder:D,fielderPosition:F}:{}}}function q0(q,J,Q,U,X,Y,Z){let V=Z||Math.random;if(!J.bases[Y-1])return{success:!1,out:!1,description:`No runner on base ${Y} to steal from.`};let K=q===2?0.6:q===3?0.3:0.1;if(Q?.stats&&X?.stats){let N=Number(Q.stats.SPD||Q.stats.SB||50),W=Number(X.stats.ARM||X.stats["CS%"]||50);if(K=0.5+(N-W)/200,q===3)K-=0.2;if(q===4)K-=0.4;K=Math.max(0.05,Math.min(0.95,K))}if(V(1)<K){if(J.bases[Y-1]=0,q<=3)J.bases[q-1]=1;else J.score[J.top?0:1]+=1;return{success:!0,out:!1,description:`Runner successfully stole base ${q===4?"Home":q}`}}else return J.bases[Y-1]=0,J.outs++,{success:!1,out:!0,description:`Runner caught stealing base ${q===4?"Home":q}`}}function J0(q,J,Q,U,X,Y){let Z=Y||Math.random;if(!J.bases[q-1])return{success:!1,out:!1,error:!1,description:`No runner on base ${q} to pick off.`};let V=0.05,K=0.1;if(U?.stats&&Q?.stats){let N=Number(U.stats.PK||50),W=Number(Q.stats.SPD||50);V=0.03+(N-W)/1000,V=Math.max(0.01,Math.min(0.15,V))}if(X?.stats)K=0.05+Number(X.stats.E||0)/1000,K=Math.max(0.01,Math.min(0.2,K));let z=Z(1);if(z<V)return J.bases[q-1]=0,J.outs++,{success:!0,out:!0,error:!1,description:`Runner picked off at base ${q}`};else if(z<V+K){if(J.bases[q-1]=0,q<3)J.bases[q]=1;else J.score[J.top?0:1]+=1;return{success:!1,out:!1,error:!0,description:`Pickoff error: runner advances from base ${q}`}}else return{success:!1,out:!1,error:!1,description:`Pickoff attempt at base ${q} unsuccessful`}}var P=document.getElementById("home-team-select"),w=document.getElementById("away-team-select"),v0=document.getElementById("load-teams-btn"),y=document.getElementById("status"),j0=document.getElementById("lineups-container"),Q0=document.getElementById("game-state-container"),I=document.getElementById("next-atbat-btn"),k=document.getElementById("atbat-result-container"),L0=document.getElementById("customize-home-lineup-btn"),F0=document.getElementById("customize-away-lineup-btn"),l=document.getElementById("custom-lineup-modal"),k0=document.getElementById("close-lineup-modal"),H0=document.getElementById("lineup-modal-title"),A0=document.getElementById("custom-lineup-form"),n=document.getElementById("batting-order-list"),o=document.getElementById("pitcher-select"),L=document.getElementById("lineup-error"),f=document.getElementById("steal-2b-btn"),h=document.getElementById("steal-3b-btn"),d=document.getElementById("steal-home-btn"),b=document.getElementById("pickoff-1b-btn"),u=document.getElementById("pickoff-2b-btn"),p=document.getElementById("pickoff-3b-btn"),U0=null,X0=null,_=null,j=null,c=null,m=null,$=null,I0=1,P0=!0,r=null,z0=null,s=null,N0=null,w0=null;async function c0(){return["ARI-2025.html","ATL-2025.html","BAL-2025.html","BOS-2025.html","CHC-2025.html","CHW-2025.html","CIN-2025.html","CLE-2025.html","COL-2025.html","DET-2025.html","HOU-2025.html","KCR-2025.html","LAA-2025.html","LAD-2025.html","MIA-2025.html","MIL-2025.html","MIN-2025.html","NYM-2025.html","NYY-2025.html","OAK-2025.html","PHI-2025.html","PIT-2025.html","SDP-2025.html","SEA-2025.html","SFG-2025.html","STL-2025.html","TBR-2025.html","TEX-2025.html","TOR-2025.html","WSN-2025.html"]}async function x0(q){let Q=await(await fetch(`./data/${q}`)).text(),{batting:U,pitching:X}=W0(Q),Y=U?V0(U):[],Z=X?V0(X):[],V=E0(Y),K=O0(Z);return{batters:V,pitchers:K}}function y0(q,J){if(!j0)return;j0.innerHTML="";let Q=(U,X)=>{if(!U)return`<div><strong>${X}:</strong> Not loaded</div>`;let Y=U.lineup||U.batters||[],Z=U.pitcher||U.pitchers&&U.pitchers[0]||{name:"N/A"};return`
      <div style="margin-bottom:1.5em;">
        <strong>${X} Lineup</strong>
        <table class="lineup-table">
          <thead><tr><th>#</th><th>Name</th><th>PA</th></tr></thead>
          <tbody>
            ${(Y||[]).slice(0,9).map((V,K)=>`<tr><td>${K+1}</td><td>${V.name||""}</td><td>${V.PA||""}</td></tr>`).join("")}
          </tbody>
        </table>
        <div><strong>Pitcher:</strong> ${Z.name}</div>
      </div>
    `};j0.innerHTML=`
    <div style="display:flex;gap:2em;flex-wrap:wrap;">
      <div style="flex:1;min-width:250px;">${Q(q,"Home")}</div>
      <div style="flex:1;min-width:250px;">${Q(J,"Away")}</div>
    </div>
  `}function m0(){if(!Q0)return;if(!$||!_||!j){if(Q0.innerHTML="<em>Game not started.</em>",I)I.style.display="none";return}let q=$,{inning:J,top:Q,outs:U,bases:X,score:Y,lineupIndices:Z}=q,V=Q?0:1,K=V===0?m:c,z=V===0?j:_;if(!z){if(Q0.innerHTML="<em>Roster not loaded.</em>",I)I.style.display="none";return}let N=Z[V]%z.lineup.length,W=z.lineup[N],E=(V===0?_:j).pitcher,O=["1B","2B","3B"].map((v,H)=>q.bases[H]?v:"").filter(Boolean).join(", ")||"Empty";if(Q0.innerHTML=`
    <div><strong>Inning:</strong> ${J} (${Q?"Top":"Bottom"})</div>
    <div><strong>Outs:</strong> ${U}</div>
    <div><strong>Bases:</strong> ${O}</div>
    <div><strong>Score:</strong> Away ${Y[0]} &ndash; Home ${Y[1]}</div>
    <div style="margin-top:1em;"><strong>At Bat:</strong> ${W.name} (vs ${E.name})</div>
  `,I)I.style.display=""}function S(q,J=!1){if(!k)return;if(!q)return;if(J){let X=document.createElement("div");X.style.marginTop="1em",X.style.fontWeight="bold",X.textContent=`Inning ${q.inning} - ${q.top?"Top":"Bottom"}`,k.appendChild(X)}let Q=["1B","2B","3B"].map((X,Y)=>q.bases[Y]?X:"").filter(Boolean).join(", ")||"Empty",U=document.createElement("div");U.innerHTML=`<strong>Batter:</strong> ${q.batterName}<br><strong>Result:</strong> ${q.outcome}<br><strong>Outs:</strong> ${q.outs} &nbsp; <strong>Score:</strong> Away ${q.score[0]} – Home ${q.score[1]} &nbsp; <strong>Bases:</strong> ${Q}`,k.appendChild(U),k.appendChild(document.createElement("br"))}function l0(){if(!_||!j)return;c=K0(_),m=K0(j),$=M0(),g()}function i0(){if(!$||!c||!m)return;let q=$,J=q.top?0:1,Q=J===0?m:c,U=J===0?j:_;if(!U)return;let X=q.lineupIndices[J]%U.lineup.length,Y=U.lineup[X],Z=T0(m,c,q,[],[]);S({batterName:Y.name,outcome:Z.outcome,outs:q.outs,score:[...q.score],bases:[...q.bases],inning:q.inning,top:q.top});let V="",K=!1;if(q.outs>=3)if(q.outs=0,q.bases=[0,0,0],q.top)q.top=!1,V="End of top half. Switching to bottom of inning.",K=!0;else q.top=!0,q.inning++,V="End of inning. Advancing to next inning.",K=!0;if(K){if(k){let z=document.createElement("div");z.innerHTML=`<em>${V}</em>`,k.appendChild(z),I0=q.inning,P0=q.top;let N=document.createElement("div");N.style.marginTop="1em",N.style.fontWeight="bold",N.textContent=`Inning ${q.inning} - ${q.top?"Top":"Bottom"}`,k.appendChild(N)}}g()}async function Y0(){if(!P||!w||!y)return;let q=P.value,J=w.value;if(!q||!J)return;y.textContent="Loading lineups...";try{let[Q,U]=await Promise.all([x0(q),x0(J)]);U0=Q,X0=U,_=Q&&Q.batters&&Q.pitchers?Z0(r&&r.length===9?r:Q.batters.slice(0,9).map((X)=>X.player_id),z0||Q.pitchers[0].player_id,Q.batters,Q.pitchers):null,j=U&&U.batters&&U.pitchers?Z0(s&&s.length===9?s:U.batters.slice(0,9).map((X)=>X.player_id),N0||U.pitchers[0].player_id,U.batters,U.pitchers):null,y0(_,j),y.textContent="Lineups loaded. Ready to simulate!",l0()}catch(Q){y.textContent="Failed to load lineups."}}async function g0(){if(!y)return;y.textContent="Loading teams...";let q=await c0();if(!q.length){y.textContent="No teams found in data folder.";return}for(let J of[P,w]){if(!J)continue;J.innerHTML="";for(let Q of q){let U=document.createElement("option");U.value=Q,U.textContent=Q.replace(".html",""),J.appendChild(U)}}if(P)P.value="CHC-2025.html";if(w)w.value="MIL-2025.html";if(y.textContent="Select home and away teams.",P&&w)Y0()}if(v0)v0.addEventListener("click",g0);if(P)P.addEventListener("change",Y0);if(w)w.addEventListener("change",Y0);if(I)I.addEventListener("click",i0);if(L0)L0.addEventListener("click",()=>{if(!U0)return;S0("home",U0.batters,U0.pitchers,r,z0)});if(F0)F0.addEventListener("click",()=>{if(!X0)return;S0("away",X0.batters,X0.pitchers,s,N0)});if(k0)k0.addEventListener("click",()=>{if(l)l.style.display="none"});if(A0)A0.addEventListener("submit",(q)=>{if(q.preventDefault(),!n||!o)return;let J=[],Q=n.querySelectorAll("select");for(let X of Q){if(!X.value){if(L)L.textContent="Please select a player for every lineup slot.";return}J.push(X.value)}if(new Set(J).size!==J.length){if(L)L.textContent="No duplicate players allowed in the lineup.";return}let U=o.value;if(!U){if(L)L.textContent="Please select a starting pitcher.";return}if(J.includes(U)){if(L)L.textContent="Pitcher cannot also be in the batting lineup.";return}if(w0==="home")r=J,z0=U;else s=J,N0=U;if(l)l.style.display="none";if(c=null,m=null,$=null,I0=1,P0=!0,k)k.innerHTML="";y0(_,j),Y0()});window.addEventListener("DOMContentLoaded",()=>{g0()});function S0(q,J,Q,U,X){if(w0=q,!l||!H0||!n||!o)return;if(H0.textContent=`Customize ${q==="home"?"Home":"Away"} Lineup`,L)L.textContent="";l.style.display="flex",n.innerHTML="";for(let Y=0;Y<9;Y++){let Z=document.createElement("li"),V=document.createElement("select");if(V.name=`batter${Y}`,V.required=!0,V.innerHTML='<option value="">-- Select --</option>'+J.map((K)=>`<option value="${K.player_id}">${K.name} (${K.PA} PA)</option>`).join(""),U&&U[Y])V.value=U[Y];Z.appendChild(V),n.appendChild(Z)}if(o.innerHTML='<option value="">-- Select --</option>'+Q.map((Y)=>`<option value="${Y.player_id}">${Y.name} (${Y.stats&&Y.stats.IP?Y.stats.IP:""} IP)</option>`).join(""),X)o.value=X}function n0(){if(!$)return;if(f)(f instanceof HTMLButtonElement?f:f).disabled=!$.bases[0];if(h)(h instanceof HTMLButtonElement?h:h).disabled=!$.bases[1];if(d)(d instanceof HTMLButtonElement?d:d).disabled=!$.bases[2];if(b)(b instanceof HTMLButtonElement?b:b).disabled=!$.bases[0];if(u)(u instanceof HTMLButtonElement?u:u).disabled=!$.bases[1];if(p)(p instanceof HTMLButtonElement?p:p).disabled=!$.bases[2]}function g(){m0(),n0()}if(f)f.addEventListener("click",()=>{if(!$||!_||!j)return;let q=$.top?0:1,Q=(q===0?j:_).lineup.find((Z)=>!0)||{},U=(q===0?_:j).pitcher,X=(q===0?_:j).lineup[0]||{},Y=q0(2,$,Q,U,X,1);S({batterName:"Runner",outcome:Y.description,outs:$.outs,score:[...$.score],bases:[...$.bases],inning:$.inning,top:$.top}),g()});if(h)h.addEventListener("click",()=>{if(!$||!_||!j)return;let q=$.top?0:1,Q=(q===0?j:_).lineup.find((Z)=>!0)||{},U=(q===0?_:j).pitcher,X=(q===0?_:j).lineup[0]||{},Y=q0(3,$,Q,U,X,2);S({batterName:"Runner",outcome:Y.description,outs:$.outs,score:[...$.score],bases:[...$.bases],inning:$.inning,top:$.top}),g()});if(d)d.addEventListener("click",()=>{if(!$||!_||!j)return;let q=$.top?0:1,Q=(q===0?j:_).lineup.find((Z)=>!0)||{},U=(q===0?_:j).pitcher,X=(q===0?_:j).lineup[0]||{},Y=q0(4,$,Q,U,X,3);S({batterName:"Runner",outcome:Y.description,outs:$.outs,score:[...$.score],bases:[...$.bases],inning:$.inning,top:$.top}),g()});if(b)b.addEventListener("click",()=>{if(!$||!_||!j)return;let q=$.top?0:1,Q=(q===0?j:_).lineup.find((Z)=>!0)||{},U=(q===0?_:j).pitcher,X=(q===0?_:j).lineup[0]||{},Y=J0(1,$,Q,U,X);S({batterName:"Runner",outcome:Y.description,outs:$.outs,score:[...$.score],bases:[...$.bases],inning:$.inning,top:$.top}),g()});if(u)u.addEventListener("click",()=>{if(!$||!_||!j)return;let q=$.top?0:1,Q=(q===0?j:_).lineup.find((Z)=>!0)||{},U=(q===0?_:j).pitcher,X=(q===0?_:j).lineup[0]||{},Y=J0(2,$,Q,U,X);S({batterName:"Runner",outcome:Y.description,outs:$.outs,score:[...$.score],bases:[...$.bases],inning:$.inning,top:$.top}),g()});if(p)p.addEventListener("click",()=>{if(!$||!_||!j)return;let q=$.top?0:1,Q=(q===0?j:_).lineup.find((Z)=>!0)||{},U=(q===0?_:j).pitcher,X=(q===0?_:j).lineup[0]||{},Y=J0(3,$,Q,U,X);S({batterName:"Runner",outcome:Y.description,outs:$.outs,score:[...$.score],bases:[...$.bases],inning:$.inning,top:$.top}),g()});
