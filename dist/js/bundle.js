function I(X){const J=/<!--([\s\S]*?)-->/g,Q=[];let U;while((U=J.exec(X))!==null)Q.push(U[1]);return Q}function g(X,J){const Q=new DOMParser;for(let U of X)if(U.includes(`id="${J}"`))return Q.parseFromString(U,"text/html").querySelector(`table#${J}`)||null;return null}function j(X){const J=document.createElement("div");J.style.display="none",document.body.appendChild(J),J.innerHTML=X;const Q=J.querySelector("table#players_standard_batting"),U=J.querySelector("table#players_standard_pitching"),V=I(X),Z=g(V,"players_standard_fielding");return J.remove(),{batting:Q,pitching:U,fielding:Z}}function M(X){if(!X||!X.href)return null;const J=X.href.match(/\/players\/.\/([^/.]+)\.shtml/);return J?J[1]:null}function R(X){return X.toLowerCase().replace(/[^a-z0-9]/g,"").slice(0,12)}function v(X){if(!X)return[];const J=Array.from(X.querySelectorAll("tbody > tr")).filter((V)=>!V.classList.contains("thead")),Q=Array.from(X.querySelectorAll("thead tr th")).map((V)=>V.textContent.trim()),U=[];for(let V of J){const Z=[V.querySelector("th"),...V.querySelectorAll("td")];if(Z.length!==Q.length)continue;const $={};for(let Y=0;Y<Q.length;Y++){const D=Q[Y],q=Z[Y];if(Y===0){let _=q.textContent.trim(),K=q.querySelector("a"),N=M(K);if(/^\d+$/.test(_)){const W=V.querySelector("td");_=W?.textContent.trim()||"(unknown)",K=W?.querySelector("a"),N=M(K)||N}$.name=_,$.player_id=N||R(_)}else{const _=q.textContent.trim(),K=Number(_.replace(/,/g,""));$[D]=isNaN(K)?_:K}}U.push($)}return U}function A(X){return X.map((J)=>{const Q=Number(J.PA)||0,U=Number(J.AB)||0,V=Number(J.H)||0,Z=Number(J.HR)||0,$=Number(J.BB)||0,Y=Number(J.SO)||0,D=Number(J.SF)||0,q=Number(J.HBP)||0,_=Number(J["2B"])||0,K=Number(J["3B"])||0,N=V-_-K-Z,W=U-Y-Z+D,L=W>0?(V-Z)/W:null,G=Q>0?Y/Q:null,z=Q>0?$/Q:null,E=Q>0?Z/Q:null;return{name:J.name,player_id:J.player_id,PA:Q,stats:{H:V,HR:Z,BB:$,SO:Y,SF:D,HBP:q,singles:N,doubles:_,triples:K},rates:{kRate:G,bbRate:z,hrRate:E,BABIP:L}}})}function x(X){return X.map((J)=>{const Q=Number(J.IP)||0,U=Number(J.TBF)||0,V=Number(J.H)||0,Z=Number(J.HR)||0,$=Number(J.BB)||0,Y=Number(J.SO)||0,D=Number(J.HBP)||0,q=U>0?Y/U:null,_=U>0?$/U:null,K=U>0?Z/U:null,N=U-Y-Z-$-D,W=N>0?(V-Z)/N:null;return{name:J.name,player_id:J.player_id,TBF:U,stats:{IP:Q,H:V,HR:Z,BB:$,SO:Y,HBP:D},rates:{kRate:q,bbRate:_,hrRate:K,BABIP:W}}})}function C(X,J,Q,U){const V=X.map((Y)=>{const D=Q.find((q)=>q.player_id===Y);if(!D)throw new Error(`Lineup player not found: ${Y}`);return D}),Z=U.find((Y)=>Y.player_id===J);if(!Z)throw new Error(`Starting pitcher not found: ${J}`);const $=new Set;for(let Y of V){if($.has(Y.player_id))throw new Error(`Duplicate player in lineup: ${Y.player_id}`);$.add(Y.player_id)}if($.has(J))throw new Error(`Pitcher also appears in lineup: ${J}`);return{lineup:V,pitcher:Z}}function f(X,J){return(X+J)/2}function k(X,J){const Q=X.rates||{},U=J.rates||{},V=X.stats||{},Z=f(Q.kRate??0,U.kRate??0),$=f(Q.bbRate??0,U.bbRate??0),Y=f(Q.hrRate??0,U.hrRate??0),D=f(Q.BABIP??0.29,U.BABIP??0.29),q=(V.HBP??0)/(X.PA||1),_=Z+$+q+Y,K=Math.max(0,1-_),N=D*K,W=K-N,L=(V.singles??0)+(V.doubles??0)+(V.triples??0),G=L>0?(V.singles??0)/L:0.7,z=L>0?(V.doubles??0)/L:0.2,E=L>0?(V.triples??0)/L:0.1;return{K:Z,BB:$,HBP:q,HR:Y,"1B":N*G,"2B":N*z,"3B":N*E,Out:W}}function F(X){const{lineup:J,pitcher:Q}=X;return J.map((U)=>{const V=k(U,Q);return{batter_id:U.player_id,pitcher_id:Q.player_id,probabilities:V}})}function O(X){const J=Object.values(X).reduce((U,V)=>U+V,0);let Q=Math.random()*J;for(let[U,V]of Object.entries(X))if((Q-=V)<=0)return U;return Object.keys(X).pop()}function y(X){if(X==="Out"){const J=O(B),Q=O(d[J]);return`${J} to ${Q}`}return X}var B={Groundout:0.45,Flyout:0.3,Lineout:0.15,Popout:0.1},d={Groundout:{"1B":0.2,"2B":0.2,SS:0.25,"3B":0.2,P:0.15},Flyout:{LF:0.35,CF:0.45,RF:0.2},Lineout:{"1B":0.25,"2B":0.25,SS:0.25,"3B":0.25},Popout:{C:0.3,"1B":0.2,"2B":0.15,SS:0.2,"3B":0.15}};function T(){return{inning:1,top:!0,outs:0,bases:[0,0,0],lineupIndices:[0,0],score:[0,0]}}function S(X,J){let Q=0;const U=[0,0,0];for(let V=2;V>=0;V--){if(!X[V])continue;const Z=V+(J==="1B"?1:J==="2B"?2:J==="3B"?3:4);if(Z>=4)Q++;else U[Z-1]=1}if(["1B","2B","3B"].includes(J)){const V={"1B":0,"2B":1,"3B":2}[J];U[V]=1}return[U,Q]}function w(X,J,Q){const U=Q.top?0:1,V=U===0?X:J,Z=Q.lineupIndices[U],$=V[Z%V.length],Y=O($.probabilities),D=y(Y);if(Q.lineupIndices[U]++,Y==="Out"||Y==="K")Q.outs++;else if(Y==="BB"||Y==="HBP"){const[q,_]=S(Q.bases,"1B");Q.bases=q,Q.score[U]+=_}else{const[q,_]=S(Q.bases,Y);Q.bases=q,Q.score[U]+=_}if(Q.outs>=3){if(Q.outs=0,Q.bases=[0,0,0],Q.top=!Q.top,Q.top)Q.inning++}return{batter_id:$.batter_id,outcome:D}}function P(X,J,Q=5){if(!X){console.log(`${J}: \u274C missing`);return}const U=X.querySelectorAll("tbody tr");console.log(`\uD83D\uDCCA ${J} preview (${Math.min(U.length,Q)} rows):`);for(let V=0;V<Math.min(U.length,Q);V++){const Z=U[V],$=Z.querySelector("th"),Y=$?$.textContent.trim():"(no name)",D=Array.from(Z.querySelectorAll("td")).map((q)=>q.textContent.trim());console.log(`   - ${V+1}: [${Y}, ${D.slice(0,4).join(", ")} ...]`)}}async function u(){try{const J=await(await fetch("./data/CHC-2025.html")).text();console.log("\uD83C\uDF10 Loaded team HTML");const{batting:Q,pitching:U,fielding:V}=j(J);console.log("\uD83E\uDDEA Table detection:"),console.log("   batting:",Q?"\u2705 found":"\u274C missing"),console.log("   pitching:",U?"\u2705 found":"\u274C missing"),console.log("   fielding:",V?"\u2705 found":"\u274C missing"),P(Q,"Batting"),P(U,"Pitching");const Z=v(Q),$=v(U),Y=A(Z),D=x($),q=Y.map((z)=>z.player_id).filter((z,E,H)=>z&&H.indexOf(z)===E).slice(0,9),_=D.find((z)=>z.player_id)?.player_id,K=C(q,_,Y,D),N=C(q,_,Y,D),W=F(K),L=F(N),G=T();console.log("\u26BE Starting simulation...");while(G.inning<=9||G.score[0]===G.score[1]){const z=w(L,W,G);console.log(`Inning ${G.inning} ${G.top?"\u2191":"\u2193"} \u2014 ${z.batter_id}: ${z.outcome}`)}console.log(`\uD83C\uDFC1 Final Score: Away ${G.score[0]} \u2014 Home ${G.score[1]}`)}catch(X){console.error("\u274C Error during simulation:",X)}}u();
