function gM(q){let z=/<!--([\s\S]*?)-->/g,J=[],Q;while((Q=z.exec(q))!==null)J.push(Q[1]);return J}function nM(q,z){let J=new DOMParser;for(let Q of q)if(Q.includes(`id="${z}"`))return J.parseFromString(Q,"text/html").querySelector(`table#${z}`);return null}function kM(q){let z=document.createElement("div");z.style.display="none",document.body.appendChild(z),z.innerHTML=q;let J=z.querySelector("table#players_standard_batting"),Q=z.querySelector("table#players_standard_pitching"),X=gM(q),$=nM(X,"players_standard_fielding");return z.remove(),{batting:J,pitching:Q,fielding:$}}function GM(q){if(!q||!q.href)return null;let z=q.href.match(/\/players\/.\/([^/.]+)\.shtml/);return z?z[1]:null}function bM(q){return q.toLowerCase().replace(/[^a-z0-9]/g,"").slice(0,12)}function YM(q){if(!q)return[];console.log("Table id:",q?.id);let z=Array.from(q.querySelectorAll("thead tr"));console.log("Header rows:",z.map((Z)=>Z.textContent));let J=z[z.length-1],Q=Array.from(J.querySelectorAll("th")).map((Z)=>(Z.textContent??"").trim());console.log("Header cells:",Q);let X=Array.from(q.querySelectorAll("tbody > tr")).filter((Z)=>!Z.classList.contains("thead"));console.log("First data row:",X[0]?.innerHTML);let $=[];for(let Z of X){let Y=[Z.querySelector("th"),...Z.querySelectorAll("td")];if(Y.length!==Q.length)continue;let N={};for(let V=0;V<Q.length;V++){let K=Q[V],E=Y[V];if(V===0){let T=E?.textContent?.trim()||"",D=E?.querySelector?.("a"),C=GM(D);if(/^\d+$/.test(T)){let R=Z.querySelector("td");T=R?.textContent?.trim()||"(unknown)",D=R?.querySelector?.("a"),C=GM(D)||C}N.name=T,N.player_id=C||bM(T)}else{let T=E?.textContent?.trim()||"",D=Number(T.replace(/,/g,""));N[K]=isNaN(D)?T:D}}$.push(N)}return $}function SM(q){if(typeof q!=="string")return"";let z=q.replace("*","").split("/")[0];return{"1":"P","2":"C","3":"1B","4":"2B","5":"3B","6":"SS","7":"LF","8":"CF","9":"RF",DH:"DH"}[z]||z}function xM(q){return q.map((z)=>{let J=Number(z.PA)||0,Q=Number(z.AB)||0,X=Number(z.H)||0,$=Number(z.HR)||0,Z=Number(z.BB)||0,Y=Number(z.SO)||0,N=Number(z.SF)||0,V=Number(z.HBP)||0,K=Number(z["2B"])||0,E=Number(z["3B"])||0,T=X-K-E-$,D=Q-Y-$+N,C=D>0?(X-$)/D:null,R=J>0?Y/J:null,x=J>0?Z/J:null,_=J>0?$/J:null,v=Number(z.b_runs_baserunning)||null,U=null;if(v!==null)U=Math.max(0,Math.min(100,50+v*10));else{let y=Number(z["3B"])||0,I=Number(z["2B"])||0;U=Math.max(30,Math.min(80,50+y*5+I*1))}return{name:z.name,player_id:z.player_id,PA:J,stats:{H:X,HR:$,BB:Z,SO:Y,SF:N,HBP:V,singles:T,doubles:K,triples:E},rates:{kRate:R,bbRate:x,hrRate:_,BABIP:C},baserunning:{runsBaserunning:v,speed:U}}})}function FM(q){return q.map((z)=>{let J=Number(z.IP)||0,Q=Number(z.TBF)||0,X=Number(z.H)||0,$=Number(z.HR)||0,Z=Number(z.BB)||0,Y=Number(z.SO)||0,N=Number(z.HBP)||0,V=Q>0?Y/Q:null,K=Q>0?Z/Q:null,E=Q>0?$/Q:null,T=Q-Y-$-Z-N,D=T>0?(X-$)/T:null;return{name:z.name,player_id:z.player_id,TBF:Q,stats:{IP:J,H:X,HR:$,BB:Z,SO:Y,HBP:N},rates:{kRate:V,bbRate:K,hrRate:E,BABIP:D}}})}function wM(q){return q.map((z)=>{let J=z.Pos||z.Position||z.position||z.POS||z["Primary Pos"]||"",Q=SM(J),X=Number(z.f_sb_catcher_only)||0,$=Number(z.f_cs_catcher_only)||0,Z=Number(z.f_cs_perc_catcher_only)||null,Y=Number(z.f_pickoffs_catcher_only)||0,N=null;if(Z!==null)N=Math.max(0,Math.min(100,50+(Z-25)*2));else if(X>0||$>0){let V=X>0?$/($+X):0.25;N=Math.max(20,Math.min(80,50+(V-0.25)*100))}else N=50;return{name:z.name,player_id:z.player_id,position:Q,stats:{...z,sbAllowed:X,cs:$,csPct:Z,pickoffs:Y,armStrength:N}}})}function r(q,z,J,Q){let X=q.map((Y)=>{let N=J.find((V)=>V.player_id===Y);if(!N)throw new Error(`Lineup player not found: ${Y}`);return N}),$=Q.find((Y)=>Y.player_id===z);if(!$)throw new Error(`Starting pitcher not found: ${z}`);let Z=new Set;for(let Y of X){if(Z.has(Y.player_id))throw new Error(`Duplicate player in lineup: ${Y.player_id}`);Z.add(Y.player_id)}if(Z.has(z))throw new Error(`Pitcher also appears in lineup: ${z}`);return{lineup:X,pitcher:$}}function mM(q,z){return(q+z)/2}function S(q,z){return q==null||isNaN(q)||q===0?z:q}var ZM=0.22,$M=0.08,NM=0.03;function PM(q,z){let J=q.rates||{},Q=z.rates||{},X=q.stats||{},$=H(S(J.kRate,ZM),"batter.kRate"),Z=H(S(Q.kRate,ZM),"pitcher.kRate"),Y=H(S(J.bbRate,$M),"batter.bbRate"),N=H(S(Q.bbRate,$M),"pitcher.bbRate"),V=H(S(J.hrRate,NM),"batter.hrRate"),K=H(S(Q.hrRate,NM),"pitcher.hrRate"),E=H(J.BABIP??0.29,"batter.BABIP"),T=H(Q.BABIP??0.29,"pitcher.BABIP"),D=Math.max(0,q.PA||0),C=Math.max(0,X.HBP??0),R=Math.max(0,X.singles??0),x=Math.max(0,X.doubles??0),_=Math.max(0,X.triples??0),v=H(ZM>0?$*Z/ZM:0,"K"),U=H($M>0?Y*N/$M:0,"BB"),y=H(NM>0?V*K/NM:0,"HR"),I=H(mM(E,T),"BABIP"),W=H(D>0?C/D:0,"HBP"),B=v+U+W+y,g=Math.max(0,1-B),n=I*g,LM=g-n,j=R+x+_,L=j>0?R/j:0.7,O=j>0?x/j:0.2,h=j>0?_/j:0.1;return{K:H(v,"K"),BB:H(U,"BB"),HBP:H(W,"HBP"),HR:H(y,"HR"),"1B":H(n*L,"1B"),"2B":H(n*O,"2B"),"3B":H(n*h,"3B"),Out:H(LM,"Out")}}function H(q,z){if(typeof q!=="number"||isNaN(q))return 0;if(q<0){if(z)console.warn(`[probabilityModel] Clamped negative value for ${z}: ${q} → 0`);return 0}if(q>1){if(z)console.warn(`[probabilityModel] Clamped value >1 for ${z}: ${q} → 1`);return 1}return q}function a(q){let{lineup:z,pitcher:J}=q;return z.map((Q)=>{let X=PM(Q,J);return{batter_id:Q.player_id,pitcher_id:J.player_id,probabilities:X}})}function t(q){let z=Object.values(q).reduce((Q,X)=>Q+X,0),J=Math.random()*z;for(let[Q,X]of Object.entries(q))if((J-=X)<=0)return Q;return Object.keys(q).pop()||""}var iM={Groundout:0.48,Flyout:0.32,Lineout:0.12,Popout:0.08},oM={Groundout:{"1B":0.1,"2B":0.27,SS:0.32,"3B":0.16,P:0.15},Flyout:{LF:0.28,CF:0.48,RF:0.24},Lineout:{"1B":0.28,"2B":0.18,SS:0.18,"3B":0.28,LF:0.04,CF:0.02,RF:0.02},Popout:{C:0.3,"1B":0.18,"2B":0.08,SS:0.18,"3B":0.18,LF:0.04,RF:0.04}};function AM(q){if(q==="Out"){let z=t(iM),J=t(oM[z]);return`${z} to ${J}`}return q}function RM(){return{inning:1,top:!0,outs:0,bases:[null,null,null],lineupIndices:[0,0],score:[0,0],pitcherFatigue:[{battersFaced:0},{battersFaced:0}]}}function jM(q){let z=[];if(q[0])z.push(0);if(q[1]&&q[0])z.push(1);if(q[2]&&q[1]&&q[0])z.push(2);return z}function UM(q,z,J){let Q=0,X=[null,null,null];for(let Z=2;Z>=0;Z--){if(!q[Z])continue;let Y=Z+(z==="1B"?1:z==="2B"?2:z==="3B"?3:4);if(Y>=3)Q++;else X[Y]=q[Z]}let $={"1B":0,"2B":1,"3B":2}[z];if($!==void 0)X[$]=J;if(z==="HR")Q++;return[X,Q]}function BM(q,z,J,Q,X,$,Z,Y,N){let V=Y||t,K=N||AM,E=J.top?0:1,T=E===0?q:z,D=E===0?$:Z,C=E===0?X:Q,R=Array.isArray(C)?C:[],x=J.lineupIndices[E],_=T[x%T.length],v=D.lineup[x%D.lineup.length],U=_.probabilities;if(J.pitcherFatigue&&J.pitcherFatigue[1-E]){J.pitcherFatigue[1-E].battersFaced++;let j=J.pitcherFatigue[1-E].battersFaced;if(j>18){let O=Math.min((j-18)*0.005,0.05);U={...U};let h=U.Out;if(U.BB)U.BB+=O;if(U["1B"])U["1B"]+=O;if(U.Out){if(U.Out-=O,U.Out<0.5*h)U.Out=0.5*h}let s=Object.values(U).reduce((b,dM)=>b+dM,0);Object.keys(U).forEach((b)=>U[b]=Math.max(0,U[b]/s))}}let y=V(U),I=K(y);J.lineupIndices[E]++;let W=void 0,B="",g=!1,n=!1,LM=!1;if(y==="Out"){let j=I.match(/to ([A-Z0-9]+)/);if(j){if(B=j[1],W=R.find((L)=>L.position===B),W&&W.stats){let L=Number(W.stats.E)||0,O=Number(W.stats.PO)||0,h=Number(W.stats.A)||0,s=O+h+L,b=s>0?L/s:0.01;if(Math.random()<b)g=!0}else if(Math.random()<0.01)g=!0}}if(g){let[j,L]=UM(J.bases,"1B",v);return J.bases=j,J.score[E]+=L,{batter_id:_.batter_id,outcome:`Error on ${B}`,fielder:W,fielderPosition:B}}if(y==="Out"&&/^Groundout to [A-Z0-9]+$/.test(I)&&J.outs===0){let j=jM(J.bases);if(j.length>=2){if(Math.random()<0.01){LM=!0;let L=j.slice().sort((O,h)=>h-O);for(let O=0;O<2&&O<L.length;O++)J.bases[L[O]]=null;return J.outs=3,{batter_id:_.batter_id,outcome:"Grounded into triple play",...W?{fielder:W,fielderPosition:B}:{}}}}}if(y==="Out"&&/^Groundout to [A-Z0-9]+$/.test(I)&&J.outs<2){let j=jM(J.bases);if(j.length>=1){if(Math.random()<0.25){n=!0;let L=Math.max(...j);return J.bases[L]=null,J.outs=Math.min(J.outs+2,3),{batter_id:_.batter_id,outcome:"Grounded into double play",...W?{fielder:W,fielderPosition:B}:{}}}}}if(y==="Out"&&/^Groundout to [A-Z0-9]+$/.test(I)){J.outs++;let j=jM(J.bases);for(let L of j.slice().sort((O,h)=>h-O))if(J.bases[L])if(L===2)J.bases[L]=null,J.score[E]+=1;else J.bases[L+1]=J.bases[L],J.bases[L]=null,console.log("Advancing forced runner from",L,"to",L+1,"Bases:",J.bases);return{batter_id:_.batter_id,outcome:I,...W?{fielder:W,fielderPosition:B}:{}}}if(y==="Out"||y==="K")J.outs++;else if(y==="BB"||y==="HBP"){let[j,L]=UM(J.bases,"1B",v);J.bases=j,J.score[E]+=L}else{let[j,L]=UM(J.bases,y,v);J.bases=j,J.score[E]+=L}return{batter_id:_.batter_id,outcome:I,...W?{fielder:W,fielderPosition:B}:{}}}function VM(q,z,J,Q,X,$,Z){let Y=Z||Math.random;if(!z.bases[$-1])return{success:!1,out:!1,description:`No runner on base ${$} to steal from.`};let N=q===2?0.6:q===3?0.3:0.1;if(J?.baserunning&&X?.stats){let K=J.baserunning.speed||50,E=X.stats.armStrength||50;if(console.log("Runner speed:",K,"Catcher arm:",E),N=0.5+(K-E)/200,q===3)N-=0.2;if(q===4)N-=0.4;N=Math.max(0.05,Math.min(0.95,N))}if(Y(1)<N){let K=z.bases[$-1];if(z.bases[$-1]=null,q<=3)z.bases[q-1]=K;else z.score[z.top?0:1]+=1;return{success:!0,out:!1,description:`Runner successfully stole base ${q===4?"Home":q}`}}else return z.bases[$-1]=null,z.outs++,{success:!1,out:!0,description:`Runner caught stealing base ${q===4?"Home":q}`}}function EM(q,z,J,Q,X,$){let Z=$||Math.random;if(!z.bases[q-1])return{success:!1,out:!1,error:!1,description:`No runner on base ${q} to pick off.`};let Y=0.05,N=0.1;if(Q?.stats&&J?.baserunning){let K=Q.stats.pickoffs||0,E=J.baserunning.speed||50;Y=0.03+K*0.02-(E-50)/1000,Y=Math.max(0.01,Math.min(0.15,Y))}if(X?.stats)N=0.05+(1-(X.stats.FP||0.985))*2,N=Math.max(0.01,Math.min(0.2,N));let V=Z(1);if(V<Y)return z.bases[q-1]=null,z.outs++,{success:!0,out:!0,error:!1,description:`Runner picked off at base ${q}`};else if(V<Y+N){let K=z.bases[q-1];if(z.bases[q-1]=null,q<3)z.bases[q]=K;else z.score[z.top?0:1]+=1;return{success:!1,out:!1,error:!0,description:`Pickoff error: runner advances from base ${q}`}}else return{success:!1,out:!1,error:!1,description:`Pickoff attempt at base ${q} unsuccessful`}}function HM(q,z){let{inning:J,top:Q,outs:X,score:$}=q,[Z,Y]=$;if(J<9)return!1;if(Q&&X===3){if(Y>Z)return z("Home",$,J,!0),!0;return!1}if(!Q&&X===3)if(Z>Y)return z("Away",$,J,!1),!0;else if(Y>Z)return z("Home",$,J,!1),!0;else return!1;if(!Q&&X<3&&Y>Z)return z("Home",$,J,!1),!0;return!1}var f=document.getElementById("home-team-select"),p=document.getElementById("away-team-select"),TM=document.getElementById("load-teams-btn"),F=document.getElementById("status"),KM=document.getElementById("lineups-container"),e=document.getElementById("game-state-container"),k=document.getElementById("next-atbat-btn"),l=document.getElementById("atbat-result-container"),WM=document.getElementById("customize-home-lineup-btn"),DM=document.getElementById("customize-away-lineup-btn"),d=document.getElementById("custom-lineup-modal"),yM=document.getElementById("close-lineup-modal"),OM=document.getElementById("lineup-modal-title"),CM=document.getElementById("custom-lineup-form"),m=document.getElementById("batting-order-list"),i=document.getElementById("pitcher-select"),w=document.getElementById("lineup-error"),MM=document.getElementById("steal-2b-btn"),qM=document.getElementById("steal-3b-btn"),zM=document.getElementById("steal-home-btn"),JM=document.getElementById("pickoff-1b-btn"),QM=document.getElementById("pickoff-2b-btn"),XM=document.getElementById("pickoff-3b-btn"),_M=document.getElementById("simulate-full-game-btn");function vM(q,z){if(!KM)return;KM.innerHTML="";let J=(Q,X)=>{if(!Q)return`<div><strong>${X}:</strong> Not loaded</div>`;let $=Q.lineup||Q.batters||[],Z=Q.pitcher||Q.pitchers&&Q.pitchers[0]||{name:"N/A"};return`
      <div style="margin-bottom:1.5em;">
        <strong>${X} Lineup</strong>
        <table class="lineup-table">
          <thead><tr><th>#</th><th>Name</th><th>PA</th></tr></thead>
          <tbody>
            ${($||[]).slice(0,9).map((Y,N)=>`<tr><td>${N+1}</td><td>${Y.name||""}${Y.position?` <span class='pos-label'>(${Y.position})</span>`:""}</td><td>${Y.PA||""}</td></tr>`).join("")}
          </tbody>
        </table>
        <div><strong>Pitcher:</strong> ${Z.name}</div>
      </div>
    `};KM.innerHTML=`
    <div style="display:flex;gap:2em;flex-wrap:wrap;">
      <div style="flex:1;min-width:250px;">${J(q,"Home")}</div>
      <div style="flex:1;min-width:250px;">${J(z,"Away")}</div>
    </div>
  `}function G(q,z,J,Q,X,$,Z){if(!e)return;if(!q||!z||!J){if(e.innerHTML="<em>Game not started.</em>",k)k.style.display="none";return}let Y=q,{inning:N,top:V,outs:K,bases:E,score:T,lineupIndices:D}=Y,C=V?0:1,R=C===0?X:Q,x=C===0?J:z;if(!x){if(e.innerHTML="<em>Roster not loaded.</em>",k)k.style.display="none";return}let _=D[C]%x.lineup.length,v=x.lineup[_],U=(C===0?z:J).pitcher,y=["1B","2B","3B"].map((I,W)=>Y.bases[W]?I:"").filter(Boolean).join(", ")||"Empty";if(e.innerHTML=`
    <div><strong>Inning:</strong> ${N} (${V?"Top":"Bottom"})</div>
    <div><strong>Outs:</strong> ${K}</div>
    <div><strong>Bases:</strong> ${y}</div>
    <div><strong>Score:</strong> Away ${T[0]} &ndash; Home ${T[1]}</div>
    <div style="margin-top:1em;"><strong>At Bat:</strong> ${v.name} (vs ${U.name})</div>
  `,k)k.style.display=""}function c(q,z,J){if(!l)return;if(!q)return;z.push(q),J()}function P(q){if(!l)return;l.innerHTML="";let z=null,J=null;for(let Q of q){if(Q.inning!==z||Q.top!==J){let Z=document.createElement("div");Z.style.marginTop="1em",Z.style.fontWeight="bold",Z.textContent=`Inning ${Q.inning} - ${Q.top?"Top":"Bottom"}`,l.appendChild(Z),z=Q.inning,J=Q.top}let X=["1B","2B","3B"].map((Z,Y)=>Q.bases[Y]?Z:"").filter(Boolean).join(", ")||"Empty",$=document.createElement("div");$.innerHTML=`<strong>${Q.batterName}:</strong> ${Q.outcome} <span style="color:#888">(Outs: ${Q.outs}, Score: Away ${Q.score[0]} – Home ${Q.score[1]}, Bases: ${X})</span>`,l.appendChild($)}}function A(q,z){q(),z()}var M={loadedHome:null,loadedAway:null,homeRoster:null,awayRoster:null,homeFielders:null,awayFielders:null,homeMatchups:null,awayMatchups:null,gameState:null,lastRenderedInning:1,lastRenderedTop:!0,customHomeLineup:null,customHomePitcher:null,customAwayLineup:null,customAwayPitcher:null,editingTeam:null,atBatLog:[]};async function sM(){return["ARI-2025.html","ATL-2025.html","BAL-2025.html","BOS-2025.html","CHC-2025.html","CHW-2025.html","CIN-2025.html","CLE-2025.html","COL-2025.html","DET-2025.html","HOU-2025.html","KCR-2025.html","LAA-2025.html","LAD-2025.html","MIA-2025.html","MIL-2025.html","MIN-2025.html","NYM-2025.html","NYY-2025.html","OAK-2025.html","PHI-2025.html","PIT-2025.html","SDP-2025.html","SEA-2025.html","SFG-2025.html","STL-2025.html","TBR-2025.html","TEX-2025.html","TOR-2025.html","WSN-2025.html"]}async function hM(q){let J=await(await fetch(`./data/${q}`)).text(),{batting:Q,pitching:X,fielding:$}=kM(J),Z=Q?YM(Q):[],Y=X?YM(X):[],N=$?YM($):[],V=xM(Z),K=FM(Y),E=wM(N);return{batters:V,pitchers:K,fielders:E}}function o(q,z){let J=q.find((X)=>X.position===z);if(J)return J;let Q=q.find((X)=>X.positions&&X.positions.includes(z));if(Q)return Q;return q.find((X)=>X.stats)||{stats:{armStrength:50,FP:0.985}}}function uM(q,z,J,Q){let X=document.querySelector(".sticky-action-bar");if(X)X.querySelectorAll("button").forEach((Z)=>{Z.disabled=!0,Z.classList.add("disabled-greyed")});if(F)F.textContent=`Game Over: ${q} wins! Final Score: Away ${z[0]} – Home ${z[1]} (${J}${Q?" Top":" Bottom"})`;if(l){let $=document.createElement("div");$.style.marginTop="1em",$.style.fontWeight="bold",$.style.color="#b00",$.textContent=`Game Over: ${q} wins! Final Score: Away ${z[0]} – Home ${z[1]} (${J}${Q?" Top":" Bottom"})`,l.appendChild($)}}function fM(){if(!M.homeRoster||!M.awayRoster)return;M.homeMatchups=a(M.homeRoster),M.awayMatchups=a(M.awayRoster),M.gameState=RM(),M.atBatLog=[],P(M.atBatLog),A(()=>G(M.gameState,M.homeRoster,M.awayRoster,M.homeMatchups,M.awayMatchups,M.lastRenderedInning,M.lastRenderedTop),u)}function pM(){if(!M.gameState||!M.homeMatchups||!M.awayMatchups||!M.homeRoster||!M.awayRoster)return;let q=M.gameState,z=q.top?0:1,J=z===0?M.awayRoster:M.homeRoster,Q=q.lineupIndices[z]%J.lineup.length,X=J.lineup[Q],$=BM(M.awayMatchups,M.homeMatchups,q,[],[],M.awayRoster,M.homeRoster);if(c({batterName:X.name,outcome:$.outcome,outs:q.outs,score:[...q.score],bases:q.bases.map((V)=>V?1:0),inning:q.inning,top:q.top},M.atBatLog,()=>P(M.atBatLog)),HM({inning:q.inning,top:q.top,score:q.score,outs:q.outs},uM)){A(()=>G(M.gameState,M.homeRoster,M.awayRoster,M.homeMatchups,M.awayMatchups,M.lastRenderedInning,M.lastRenderedTop),u);return}let Y="",N=!1;if(q.outs>=3){if(q.bases=[null,null,null],q.outs=0,q.top)q.top=!1,Y="End of top half. Switching to bottom of inning.";else q.top=!0,q.inning++,Y="End of inning. Advancing to next inning.";N=!0}if(N){if(HM({inning:q.inning,top:q.top,score:q.score,outs:q.outs},uM)){A(()=>G(M.gameState,M.homeRoster,M.awayRoster,M.homeMatchups,M.awayMatchups,M.lastRenderedInning,M.lastRenderedTop),u);return}}if(Y)c({batterName:"System",outcome:Y,outs:q.outs,score:[...q.score],bases:q.bases.map((V)=>V?1:0),inning:q.inning,top:q.top},M.atBatLog,()=>P(M.atBatLog));A(()=>G(M.gameState,M.homeRoster,M.awayRoster,M.homeMatchups,M.awayMatchups,M.lastRenderedInning,M.lastRenderedTop),u)}function rM(){if(!M.gameState||!M.homeMatchups||!M.awayMatchups)fM();while(M.gameState&&k&&!k.disabled)pM()}async function IM(){if(!f||!p||!F)return;let q=f.value,z=p.value;if(!q||!z)return;F.textContent="Loading lineups...";try{let[J,Q]=await Promise.all([hM(q),hM(z)]);M.loadedHome=J,M.loadedAway=Q,M.homeFielders=J.fielders,M.awayFielders=Q.fielders;let X=J.batters.map((Z)=>{let Y=J.fielders.find((N)=>N.player_id===Z.player_id);if(Y)return{...Z,...Y,stats:{...Z.stats,...Y.stats},position:Y.position};return Z}),$=Q.batters.map((Z)=>{let Y=Q.fielders.find((N)=>N.player_id===Z.player_id);if(Y)return{...Z,...Y,stats:{...Z.stats,...Y.stats},position:Y.position};return Z});M.homeRoster=J&&J.batters&&J.pitchers?r(M.customHomeLineup&&M.customHomeLineup.length===9?M.customHomeLineup:X.slice(0,9).map((Z)=>Z.player_id),M.customHomePitcher||J.pitchers[0].player_id,X,J.pitchers):null,M.awayRoster=Q&&Q.batters&&Q.pitchers?r(M.customAwayLineup&&M.customAwayLineup.length===9?M.customAwayLineup:$.slice(0,9).map((Z)=>Z.player_id),M.customAwayPitcher||Q.pitchers[0].player_id,$,Q.pitchers):null,vM(M.homeRoster,M.awayRoster),M.atBatLog=[],P(M.atBatLog),F.textContent="Lineups loaded. Ready to simulate!",fM()}catch(J){F.textContent="Failed to load lineups."}}async function lM(){if(!F)return;F.textContent="Loading teams...";let q=await sM();if(!q.length){F.textContent="No teams found in data folder.";return}for(let z of[f,p]){if(!z)continue;z.innerHTML="";for(let J of q){let Q=document.createElement("option");Q.value=J,Q.textContent=J.replace(".html",""),z.appendChild(Q)}}if(f)f.value="CHC-2025.html";if(p)p.value="MIL-2025.html";if(F.textContent="Select home and away teams.",f&&p)IM()}function aM(){if(!M.loadedHome||!M.loadedAway)return;let q=M.loadedHome&&M.loadedHome.batters&&M.loadedHome.fielders?M.loadedHome.batters.map((J)=>{let Q=M.loadedHome.fielders.find((X)=>X.player_id===J.player_id);if(Q)return{...J,...Q,stats:{...J.stats,...Q.stats},position:Q.position};return J}):[],z=M.loadedAway&&M.loadedAway.batters&&M.loadedAway.fielders?M.loadedAway.batters.map((J)=>{let Q=M.loadedAway.fielders.find((X)=>X.player_id===J.player_id);if(Q)return{...J,...Q,stats:{...J.stats,...Q.stats},position:Q.position};return J}):[];if(M.homeRoster=M.loadedHome&&M.loadedHome.batters&&M.loadedHome.pitchers?r(M.customHomeLineup&&M.customHomeLineup.length===9?M.customHomeLineup:q.slice(0,9).map((J)=>J.player_id),M.customHomePitcher||M.loadedHome.pitchers[0].player_id,q,M.loadedHome.pitchers):null,M.awayRoster=M.loadedAway&&M.loadedAway.batters&&M.loadedAway.pitchers?r(M.customAwayLineup&&M.customAwayLineup.length===9?M.customAwayLineup:z.slice(0,9).map((J)=>J.player_id),M.customAwayPitcher||M.loadedAway.pitchers[0].player_id,z,M.loadedAway.pitchers):null,M.homeRoster&&M.awayRoster)M.homeMatchups=a({lineup:M.homeRoster.lineup,pitcher:M.awayRoster.pitcher}),M.awayMatchups=a({lineup:M.awayRoster.lineup,pitcher:M.homeRoster.pitcher});vM(M.homeRoster,M.awayRoster),G(M.gameState,M.homeRoster,M.awayRoster,M.homeMatchups,M.awayMatchups,M.lastRenderedInning,M.lastRenderedTop)}function cM(q,z,J,Q,X){if(M.editingTeam=q,!d||!OM||!m||!i)return;if(OM.textContent=`Customize ${q==="home"?"Home":"Away"} Lineup`,w)w.textContent="";d.style.display="flex";let $=Q,Z=X;if(q==="home"&&M.homeRoster)$=M.homeRoster.lineup?M.homeRoster.lineup.map((Y)=>Y.player_id):Q,Z=M.homeRoster.pitcher?M.homeRoster.pitcher.player_id:X;else if(q==="away"&&M.awayRoster)$=M.awayRoster.lineup?M.awayRoster.lineup.map((Y)=>Y.player_id):Q,Z=M.awayRoster.pitcher?M.awayRoster.pitcher.player_id:X;m.innerHTML="";for(let Y=0;Y<9;Y++){let N=document.createElement("li"),V=document.createElement("select");if(V.name=`batter${Y}`,V.required=!0,V.innerHTML='<option value="">-- Select --</option>'+z.map((K)=>`<option value="${K.player_id}">${K.name} (${K.PA} PA)</option>`).join(""),$&&$[Y])V.value=$[Y];N.appendChild(V),m.appendChild(N)}if(i.innerHTML='<option value="">-- Select --</option>'+J.map((Y)=>`<option value="${Y.player_id}">${Y.name} (${Y.stats&&Y.stats.IP?Y.stats.IP:""} IP)</option>`).join(""),Z)i.value=Z}function u(){if(!M.gameState)return;if(MM)MM.disabled=!M.gameState.bases[0];if(qM)qM.disabled=!M.gameState.bases[1];if(zM)zM.disabled=!M.gameState.bases[2];if(JM)JM.disabled=!M.gameState.bases[0];if(QM)QM.disabled=!M.gameState.bases[1];if(XM)XM.disabled=!M.gameState.bases[2]}if(TM)TM.addEventListener("click",lM);if(f)f.addEventListener("change",IM);if(p)p.addEventListener("change",IM);if(k)k.addEventListener("click",pM);if(WM)WM.addEventListener("click",()=>{if(!M.loadedHome)return;cM("home",M.loadedHome.batters,M.loadedHome.pitchers,M.customHomeLineup,M.customHomePitcher)});if(DM)DM.addEventListener("click",()=>{if(!M.loadedAway)return;cM("away",M.loadedAway.batters,M.loadedAway.pitchers,M.customAwayLineup,M.customAwayPitcher)});if(yM)yM.addEventListener("click",()=>{if(d)d.style.display="none"});if(CM)CM.addEventListener("submit",(q)=>{if(q.preventDefault(),!m||!i)return;let z=[],J=m.querySelectorAll("select");for(let X of J){if(!X.value){if(w)w.textContent="Please select a player for every lineup slot.";return}z.push(X.value)}if(new Set(z).size!==z.length){if(w)w.textContent="No duplicate players allowed in the lineup.";return}let Q=i.value;if(!Q){if(w)w.textContent="Please select a starting pitcher.";return}if(z.includes(Q)){if(w)w.textContent="Pitcher cannot also be in the batting lineup.";return}if(M.editingTeam==="home")M.customHomeLineup=z,M.customHomePitcher=Q;else M.customAwayLineup=z,M.customAwayPitcher=Q;if(d)d.style.display="none";aM()});window.addEventListener("DOMContentLoaded",()=>{lM()});if(MM)MM.addEventListener("click",()=>{if(!M.gameState||!M.homeRoster||!M.awayRoster)return;let q=M.gameState.top?0:1,z=q===0?M.awayRoster:M.homeRoster,J=q===0?M.homeRoster:M.awayRoster,Q=q===0?M.homeFielders:M.awayFielders,X=M.gameState.bases[0];if(!X)return;let $=Q?o(Q,"C"):{stats:{armStrength:50}},Z=J.pitcher,Y=VM(2,M.gameState,X,Z,$,1);c({batterName:X.name,outcome:Y.description,outs:M.gameState.outs,score:[...M.gameState.score],bases:M.gameState.bases.map((N)=>N?1:0),inning:M.gameState.inning,top:M.gameState.top},M.atBatLog,()=>P(M.atBatLog)),A(()=>G(M.gameState,M.homeRoster,M.awayRoster,M.homeMatchups,M.awayMatchups,M.lastRenderedInning,M.lastRenderedTop),u)});if(qM)qM.addEventListener("click",()=>{if(!M.gameState||!M.homeRoster||!M.awayRoster)return;let q=M.gameState.top?0:1,z=q===0?M.awayRoster:M.homeRoster,J=q===0?M.homeRoster:M.awayRoster,Q=q===0?M.homeFielders:M.awayFielders,X=M.gameState.bases[1];if(!X)return;let $=Q?o(Q,"C"):{stats:{armStrength:50}},Z=J.pitcher,Y=VM(3,M.gameState,X,Z,$,2);c({batterName:X.name,outcome:Y.description,outs:M.gameState.outs,score:[...M.gameState.score],bases:M.gameState.bases.map((N)=>N?1:0),inning:M.gameState.inning,top:M.gameState.top},M.atBatLog,()=>P(M.atBatLog)),A(()=>G(M.gameState,M.homeRoster,M.awayRoster,M.homeMatchups,M.awayMatchups,M.lastRenderedInning,M.lastRenderedTop),u)});if(zM)zM.addEventListener("click",()=>{if(!M.gameState||!M.homeRoster||!M.awayRoster)return;let q=M.gameState.top?0:1,z=q===0?M.awayRoster:M.homeRoster,J=q===0?M.homeRoster:M.awayRoster,Q=q===0?M.homeFielders:M.awayFielders,X=M.gameState.bases[2];if(!X)return;let $=Q?o(Q,"C"):{stats:{armStrength:50}},Z=J.pitcher,Y=VM(4,M.gameState,X,Z,$,3);c({batterName:X.name,outcome:Y.description,outs:M.gameState.outs,score:[...M.gameState.score],bases:M.gameState.bases.map((N)=>N?1:0),inning:M.gameState.inning,top:M.gameState.top},M.atBatLog,()=>P(M.atBatLog)),A(()=>G(M.gameState,M.homeRoster,M.awayRoster,M.homeMatchups,M.awayMatchups,M.lastRenderedInning,M.lastRenderedTop),u)});if(JM)JM.addEventListener("click",()=>{if(!M.gameState||!M.homeRoster||!M.awayRoster)return;let q=M.gameState.top?0:1,z=q===0?M.awayRoster:M.homeRoster,J=q===0?M.homeRoster:M.awayRoster,Q=q===0?M.homeFielders:M.awayFielders,X=M.gameState.bases[0];if(!X)return;let $=Q?o(Q,"1B"):{stats:{FP:0.985}},Z=J.pitcher,Y=EM(1,M.gameState,X,Z,$);c({batterName:X.name,outcome:Y.description,outs:M.gameState.outs,score:[...M.gameState.score],bases:M.gameState.bases.map((N)=>N?1:0),inning:M.gameState.inning,top:M.gameState.top},M.atBatLog,()=>P(M.atBatLog)),A(()=>G(M.gameState,M.homeRoster,M.awayRoster,M.homeMatchups,M.awayMatchups,M.lastRenderedInning,M.lastRenderedTop),u)});if(QM)QM.addEventListener("click",()=>{if(!M.gameState||!M.homeRoster||!M.awayRoster)return;let q=M.gameState.top?0:1,z=q===0?M.awayRoster:M.homeRoster,J=q===0?M.homeRoster:M.awayRoster,Q=q===0?M.homeFielders:M.awayFielders,X=M.gameState.bases[1];if(!X)return;let $=Q?o(Q,"2B"):{stats:{FP:0.985}},Z=J.pitcher,Y=EM(2,M.gameState,X,Z,$);c({batterName:X.name,outcome:Y.description,outs:M.gameState.outs,score:[...M.gameState.score],bases:M.gameState.bases.map((N)=>N?1:0),inning:M.gameState.inning,top:M.gameState.top},M.atBatLog,()=>P(M.atBatLog)),A(()=>G(M.gameState,M.homeRoster,M.awayRoster,M.homeMatchups,M.awayMatchups,M.lastRenderedInning,M.lastRenderedTop),u)});if(XM)XM.addEventListener("click",()=>{if(!M.gameState||!M.homeRoster||!M.awayRoster)return;let q=M.gameState.top?0:1,z=q===0?M.awayRoster:M.homeRoster,J=q===0?M.homeRoster:M.awayRoster,Q=q===0?M.homeFielders:M.awayFielders,X=M.gameState.bases[2];if(!X)return;let $=Q?o(Q,"3B"):{stats:{FP:0.985}},Z=J.pitcher,Y=EM(3,M.gameState,X,Z,$);c({batterName:X.name,outcome:Y.description,outs:M.gameState.outs,score:[...M.gameState.score],bases:M.gameState.bases.map((N)=>N?1:0),inning:M.gameState.inning,top:M.gameState.top},M.atBatLog,()=>P(M.atBatLog)),A(()=>G(M.gameState,M.homeRoster,M.awayRoster,M.homeMatchups,M.awayMatchups,M.lastRenderedInning,M.lastRenderedTop),u)});if(_M)_M.addEventListener("click",rM);
