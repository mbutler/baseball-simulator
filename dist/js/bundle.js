function N0(J){const q=/<!--([\s\S]*?)-->/g,Q=[];let U;while((U=q.exec(J))!==null)Q.push(U[1]);return Q}function W0(J,q){const Q=new DOMParser;for(let U of J)if(U.includes(`id="${q}"`))return Q.parseFromString(U,"text/html").querySelector(`table#${q}`)||null;return null}function n(J){const q=document.createElement("div");q.style.display="none",document.body.appendChild(q),q.innerHTML=J;const Q=q.querySelector("table#players_standard_batting"),U=q.querySelector("table#players_standard_pitching"),X=N0(J),Z=W0(X,"players_standard_fielding");return q.remove(),{batting:Q,pitching:U,fielding:Z}}function i(J){if(!J||!J.href)return null;const q=J.href.match(/\/players\/.\/([^/.]+)\.shtml/);return q?q[1]:null}function E0(J){return J.toLowerCase().replace(/[^a-z0-9]/g,"").slice(0,12)}function g(J){if(!J)return[];const q=Array.from(J.querySelectorAll("tbody > tr")).filter((X)=>!X.classList.contains("thead")),Q=Array.from(J.querySelectorAll("thead tr th")).map((X)=>(X.textContent??"").trim()),U=[];for(let X of q){const Z=[X.querySelector("th"),...X.querySelectorAll("td")];if(Z.length!==Q.length)continue;const $={};for(let Y=0;Y<Q.length;Y++){const V=Q[Y],W=Z[Y];if(Y===0){let z=W?.textContent?.trim()||"",E=W?.querySelector?.("a")||null,N=i(E);if(/^\d+$/.test(z)){const G=X.querySelector("td");z=G?.textContent?.trim()||"(unknown)",E=G?.querySelector?.("a")||null,N=i(E)||N}$.name=z,$.player_id=N||E0(z)}else{const z=W?.textContent?.trim()||"",E=Number(z.replace(/,/g,""));$[V]=isNaN(E)?z:E}}U.push($)}return U}function o(J){return J.map((q)=>{const Q=Number(q.PA)||0,U=Number(q.AB)||0,X=Number(q.H)||0,Z=Number(q.HR)||0,$=Number(q.BB)||0,Y=Number(q.SO)||0,V=Number(q.SF)||0,W=Number(q.HBP)||0,z=Number(q["2B"])||0,E=Number(q["3B"])||0,N=X-z-E-Z,G=U-Y-Z+V,f=G>0?(X-Z)/G:null,_=Q>0?Y/Q:null,A=Q>0?$/Q:null,P=Q>0?Z/Q:null;return{name:q.name,player_id:q.player_id,PA:Q,stats:{H:X,HR:Z,BB:$,SO:Y,SF:V,HBP:W,singles:N,doubles:z,triples:E},rates:{kRate:_,bbRate:A,hrRate:P,BABIP:f}}})}function r(J){return J.map((q)=>{const Q=Number(q.IP)||0,U=Number(q.TBF)||0,X=Number(q.H)||0,Z=Number(q.HR)||0,$=Number(q.BB)||0,Y=Number(q.SO)||0,V=Number(q.HBP)||0,W=U>0?Y/U:null,z=U>0?$/U:null,E=U>0?Z/U:null,N=U-Y-Z-$-V,G=N>0?(X-Z)/N:null;return{name:q.name,player_id:q.player_id,TBF:U,stats:{IP:Q,H:X,HR:Z,BB:$,SO:Y,HBP:V},rates:{kRate:W,bbRate:z,hrRate:E,BABIP:G}}})}function w(J,q,Q,U){const X=J.map((Y)=>{const V=Q.find((W)=>W.player_id===Y);if(!V)throw new Error(`Lineup player not found: ${Y}`);return V}),Z=U.find((Y)=>Y.player_id===q);if(!Z)throw new Error(`Starting pitcher not found: ${q}`);const $=new Set;for(let Y of X){if($.has(Y.player_id))throw new Error(`Duplicate player in lineup: ${Y.player_id}`);$.add(Y.player_id)}if($.has(q))throw new Error(`Pitcher also appears in lineup: ${q}`);return{lineup:X,pitcher:Z}}function x(J,q){return(J+q)/2}function l(J,q){const Q=J.rates||{},U=q.rates||{},X=J.stats||{},Z=K(Q.kRate??0,"batter.kRate"),$=K(U.kRate??0,"pitcher.kRate"),Y=K(Q.bbRate??0,"batter.bbRate"),V=K(U.bbRate??0,"pitcher.bbRate"),W=K(Q.hrRate??0,"batter.hrRate"),z=K(U.hrRate??0,"pitcher.hrRate"),E=K(Q.BABIP??0.29,"batter.BABIP"),N=K(U.BABIP??0.29,"pitcher.BABIP"),G=Math.max(0,J.PA||0),f=Math.max(0,X.HBP??0),_=Math.max(0,X.singles??0),A=Math.max(0,X.doubles??0),P=Math.max(0,X.triples??0),u=K(x(Z,$),"K"),b=K(x(Y,V),"BB"),c=K(x(W,z),"HR"),Y0=K(x(E,N),"BABIP"),p=K(G>0?f/G:0,"HBP"),Z0=u+b+p+c,m=Math.max(0,1-Z0),I=Y0*m,$0=m-I,C=_+A+P,V0=C>0?_/C:0.7,K0=C>0?A/C:0.2,z0=C>0?P/C:0.1;return{K:K(u,"K"),BB:K(b,"BB"),HBP:K(p,"HBP"),HR:K(c,"HR"),"1B":K(I*V0,"1B"),"2B":K(I*K0,"2B"),"3B":K(I*z0,"3B"),Out:K($0,"Out")}}function K(J,q){if(typeof J!=="number"||isNaN(J))return 0;if(J<0){if(q)console.warn(`[probabilityModel] Clamped negative value for ${q}: ${J} \u2192 0`);return 0}if(J>1){if(q)console.warn(`[probabilityModel] Clamped value >1 for ${q}: ${J} \u2192 1`);return 1}return J}function y(J){const{lineup:q,pitcher:Q}=J;return q.map((U)=>{const X=l(U,Q);return{batter_id:U.player_id,pitcher_id:Q.player_id,probabilities:X}})}function M(J){const q=Object.values(J).reduce((U,X)=>U+X,0);let Q=Math.random()*q;for(let[U,X]of Object.entries(J))if((Q-=X)<=0)return U;return Object.keys(J).pop()||""}function s(J){if(J==="Out"){const q=M(G0),Q=M(_0[q]);return`${q} to ${Q}`}return J}var G0={Groundout:0.45,Flyout:0.3,Lineout:0.15,Popout:0.1},_0={Groundout:{"1B":0.2,"2B":0.2,SS:0.25,"3B":0.2,P:0.15},Flyout:{LF:0.35,CF:0.45,RF:0.2},Lineout:{"1B":0.25,"2B":0.25,SS:0.25,"3B":0.25},Popout:{C:0.3,"1B":0.2,"2B":0.15,SS:0.2,"3B":0.15}};function t(){return{inning:1,top:!0,outs:0,bases:[0,0,0],lineupIndices:[0,0],score:[0,0]}}function a(J,q){let Q=0;const U=[0,0,0];for(let Z=2;Z>=0;Z--){if(!J[Z])continue;const $=Z+(q==="1B"?1:q==="2B"?2:q==="3B"?3:4);if($>=3)Q++;else U[$]=1}const X={"1B":0,"2B":1,"3B":2}[q];if(X!==void 0)U[X]=1;if(q==="HR")Q++;return[U,Q]}function e(J,q,Q,U,X){const Z=U||M,$=X||s,Y=Q.top?0:1,V=Y===0?J:q,W=Q.lineupIndices[Y],z=V[W%V.length],E=z.probabilities,N=Z(E),G=$(N);if(Q.lineupIndices[Y]++,N==="Out"||N==="K")Q.outs++;else if(N==="BB"||N==="HBP"){const[f,_]=a(Q.bases,"1B");Q.bases=f,Q.score[Y]+=_}else{const[f,_]=a(Q.bases,N);Q.bases=f,Q.score[Y]+=_}return{batter_id:z.batter_id,outcome:G}}async function L0(){return["CHC-2025.html","MIL-2025.html","PIT-2025.html"]}async function Q0(J){const Q=await(await fetch(`./data/${J}`)).text(),{batting:U,pitching:X}=n(Q),Z=U?g(U):[],$=X?g(X):[],Y=o(Z),V=r($);return{batters:Y,pitchers:V}}function O0(J,q){if(!R)return;R.innerHTML="";const Q=(U,X)=>{if(!U)return`<div><strong>${X}:</strong> Not loaded</div>`;const Z=U.pitchers&&U.pitchers[0]||{name:"N/A"};return`
      <div style="margin-bottom:1.5em;">
        <strong>${X} Lineup</strong>
        <table class="lineup-table">
          <thead><tr><th>#</th><th>Name</th><th>PA</th></tr></thead>
          <tbody>
            ${(U.batters||[]).slice(0,9).map(($,Y)=>`<tr><td>${Y+1}</td><td>${$.name||""}</td><td>${$.PA||""}</td></tr>`).join("")}
          </tbody>
        </table>
        <div><strong>Pitcher:</strong> ${Z.name}</div>
      </div>
    `};R.innerHTML=`
    <div style="display:flex;gap:2em;flex-wrap:wrap;">
      <div style="flex:1;min-width:250px;">${Q(J,"Home")}</div>
      <div style="flex:1;min-width:250px;">${Q(q,"Away")}</div>
    </div>
  `}function U0(){if(!S)return;if(!H||!v||!k){if(S.innerHTML="<em>Game not started.</em>",j)j.style.display="none";return}const J=H,{inning:q,top:Q,outs:U,bases:X,score:Z,lineupIndices:$}=J,Y=Q?0:1,V=Y===0?T:F,W=Y===0?k:v;if(!W){if(S.innerHTML="<em>Roster not loaded.</em>",j)j.style.display="none";return}const z=$[Y]%W.lineup.length,E=W.lineup[z],N=(Y===0?v:k).pitcher,G=["1B","2B","3B"].map((f,_)=>J.bases[_]?f:"").filter(Boolean).join(", ")||"Empty";if(S.innerHTML=`
    <div><strong>Inning:</strong> ${q} (${Q?"Top":"Bottom"})</div>
    <div><strong>Outs:</strong> ${U}</div>
    <div><strong>Bases:</strong> ${G}</div>
    <div><strong>Score:</strong> Away ${Z[0]} &ndash; Home ${Z[1]}</div>
    <div style="margin-top:1em;"><strong>At Bat:</strong> ${E.name} (vs ${N.name})</div>
  `,j)j.style.display=""}function d(J,q=!1){if(!B)return;if(q||!J){B.innerHTML="";return}const Q=document.createElement("div");Q.innerHTML=`<strong>Batter:</strong> ${J.batterName}<br><strong>Result:</strong> ${J.outcome}`,B.appendChild(Q)}function D0(){if(!v||!k)return;F=y(v),T=y(k),H=t(),U0(),d(null)}function v0(){if(!H||!F||!T)return;const J=H,q=J.top?0:1,Q=q===0?T:F,U=q===0?k:v;if(!U)return;const X=J.lineupIndices[q]%U.lineup.length,Z=U.lineup[X],$=e(T,F,J);let Y="",V=!1;if(J.outs>=3)if(J.outs=0,J.bases=[0,0,0],J.top)J.top=!1,Y="End of top half. Switching to bottom of inning.";else J.top=!0,J.inning++,Y="End of inning. Advancing to next inning.",V=!0;if(V||J.inning!==J0)d(null,!0),J0=J.inning;d({batterName:Z.name,outcome:$.outcome+(Y?`<br><em>${Y}</em>`:"")}),U0()}async function h(){if(!L||!O||!D)return;const J=L.value,q=O.value;if(!J||!q)return;D.textContent="Loading lineups...";try{const[Q,U]=await Promise.all([Q0(J),Q0(q)]);f0=Q,j0=U,v=Q&&Q.batters&&Q.pitchers?w(Q.batters.slice(0,9).map((X)=>X.player_id),Q.pitchers[0].player_id,Q.batters,Q.pitchers):null,k=U&&U.batters&&U.pitchers?w(U.batters.slice(0,9).map((X)=>X.player_id),U.pitchers[0].player_id,U.batters,U.pitchers):null,O0(Q,U),D.textContent="Lineups loaded. Ready to simulate!",D0()}catch(Q){D.textContent="Failed to load lineups."}}async function X0(){if(!D)return;D.textContent="Loading teams...";const J=await L0();if(!J.length){D.textContent="No teams found in data folder.";return}for(let q of[L,O]){if(!q)continue;q.innerHTML="";for(let Q of J){const U=document.createElement("option");U.value=Q,U.textContent=Q.replace(".html",""),q.appendChild(U)}}if(L)L.value="CHC-2025.html";if(O)O.value="MIL-2025.html";if(D.textContent="Select home and away teams.",L&&O)h()}var L=document.getElementById("home-team-select"),O=document.getElementById("away-team-select"),q0=document.getElementById("load-teams-btn"),D=document.getElementById("status"),R=document.getElementById("lineups-container"),S=document.getElementById("game-state-container"),j=document.getElementById("next-atbat-btn"),B=document.getElementById("atbat-result-container"),f0=null,j0=null,v=null,k=null,F=null,T=null,H=null,J0=1;if(q0)q0.addEventListener("click",X0);if(L)L.addEventListener("change",h);if(O)O.addEventListener("change",h);if(j)j.addEventListener("click",v0);window.addEventListener("DOMContentLoaded",()=>{X0()});
