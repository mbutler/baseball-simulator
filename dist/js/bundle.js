function I0(q){const J=/<!--([\s\S]*?)-->/g,U=[];let Q;while((Q=J.exec(q))!==null)U.push(Q[1]);return U}function H0(q,J){const U=new DOMParser;for(let Q of q)if(Q.includes(`id="${J}"`))return U.parseFromString(Q,"text/html").querySelector(`table#${J}`)||null;return null}function q0(q){const J=document.createElement("div");J.style.display="none",document.body.appendChild(J),J.innerHTML=q;const U=J.querySelector("table#players_standard_batting"),Q=J.querySelector("table#players_standard_pitching"),X=I0(q),Y=H0(X,"players_standard_fielding");return J.remove(),{batting:U,pitching:Q,fielding:Y}}function J0(q){if(!q||!q.href)return null;const J=q.href.match(/\/players\/.\/([^/.]+)\.shtml/);return J?J[1]:null}function S0(q){return q.toLowerCase().replace(/[^a-z0-9]/g,"").slice(0,12)}function m(q){if(!q)return[];const J=Array.from(q.querySelectorAll("tbody > tr")).filter((X)=>!X.classList.contains("thead")),U=Array.from(q.querySelectorAll("thead tr th")).map((X)=>(X.textContent??"").trim()),Q=[];for(let X of J){const Y=[X.querySelector("th"),...X.querySelectorAll("td")];if(Y.length!==U.length)continue;const $={};for(let Z=0;Z<U.length;Z++){const V=U[Z],G=Y[Z];if(Z===0){let K=G?.textContent?.trim()||"",z=G?.querySelector?.("a")||null,_=J0(z);if(/^\d+$/.test(K)){const j=X.querySelector("td");K=j?.textContent?.trim()||"(unknown)",z=j?.querySelector?.("a")||null,_=J0(z)||_}$.name=K,$.player_id=_||S0(K)}else{const K=G?.textContent?.trim()||"",z=Number(K.replace(/,/g,""));$[V]=isNaN(z)?K:z}}Q.push($)}return Q}function Q0(q){return q.map((J)=>{const U=Number(J.PA)||0,Q=Number(J.AB)||0,X=Number(J.H)||0,Y=Number(J.HR)||0,$=Number(J.BB)||0,Z=Number(J.SO)||0,V=Number(J.SF)||0,G=Number(J.HBP)||0,K=Number(J["2B"])||0,z=Number(J["3B"])||0,_=X-K-z-Y,j=Q-Z-Y+V,E=j>0?(X-Y)/j:null,N=U>0?Z/U:null,y=U>0?$/U:null,R=U>0?Y/U:null;return{name:J.name,player_id:J.player_id,PA:U,stats:{H:X,HR:Y,BB:$,SO:Z,SF:V,HBP:G,singles:_,doubles:K,triples:z},rates:{kRate:N,bbRate:y,hrRate:R,BABIP:E}}})}function U0(q){return q.map((J)=>{const U=Number(J.IP)||0,Q=Number(J.TBF)||0,X=Number(J.H)||0,Y=Number(J.HR)||0,$=Number(J.BB)||0,Z=Number(J.SO)||0,V=Number(J.HBP)||0,G=Q>0?Z/Q:null,K=Q>0?$/Q:null,z=Q>0?Y/Q:null,_=Q-Z-Y-$-V,j=_>0?(X-Y)/_:null;return{name:J.name,player_id:J.player_id,TBF:Q,stats:{IP:U,H:X,HR:Y,BB:$,SO:Z,HBP:V},rates:{kRate:G,bbRate:K,hrRate:z,BABIP:j}}})}function p(q,J,U,Q){const X=q.map((Z)=>{const V=U.find((G)=>G.player_id===Z);if(!V)throw new Error(`Lineup player not found: ${Z}`);return V}),Y=Q.find((Z)=>Z.player_id===J);if(!Y)throw new Error(`Starting pitcher not found: ${J}`);const $=new Set;for(let Z of X){if($.has(Z.player_id))throw new Error(`Duplicate player in lineup: ${Z.player_id}`);$.add(Z.player_id)}if($.has(J))throw new Error(`Pitcher also appears in lineup: ${J}`);return{lineup:X,pitcher:Y}}function d(q,J){return(q+J)/2}function X0(q,J){const U=q.rates||{},Q=J.rates||{},X=q.stats||{},Y=W(U.kRate??0,"batter.kRate"),$=W(Q.kRate??0,"pitcher.kRate"),Z=W(U.bbRate??0,"batter.bbRate"),V=W(Q.bbRate??0,"pitcher.bbRate"),G=W(U.hrRate??0,"batter.hrRate"),K=W(Q.hrRate??0,"pitcher.hrRate"),z=W(U.BABIP??0.29,"batter.BABIP"),_=W(Q.BABIP??0.29,"pitcher.BABIP"),j=Math.max(0,q.PA||0),E=Math.max(0,X.HBP??0),N=Math.max(0,X.singles??0),y=Math.max(0,X.doubles??0),R=Math.max(0,X.triples??0),l=W(d(Y,$),"K"),s=W(d(Z,V),"BB"),a=W(d(G,K),"HR"),T0=W(d(z,_),"BABIP"),t=W(j>0?E/j:0,"HBP"),L0=l+s+t+a,e=Math.max(0,1-L0),B=T0*e,M0=e-B,L=N+y+R,x0=L>0?N/L:0.7,A0=L>0?y/L:0.2,P0=L>0?R/L:0.1;return{K:W(l,"K"),BB:W(s,"BB"),HBP:W(t,"HBP"),HR:W(a,"HR"),"1B":W(B*x0,"1B"),"2B":W(B*A0,"2B"),"3B":W(B*P0,"3B"),Out:W(M0,"Out")}}function W(q,J){if(typeof q!=="number"||isNaN(q))return 0;if(q<0){if(J)console.warn(`[probabilityModel] Clamped negative value for ${J}: ${q} \u2192 0`);return 0}if(q>1){if(J)console.warn(`[probabilityModel] Clamped value >1 for ${J}: ${q} \u2192 1`);return 1}return q}function o(q){const{lineup:J,pitcher:U}=q;return J.map((Q)=>{const X=X0(Q,U);return{batter_id:Q.player_id,pitcher_id:U.player_id,probabilities:X}})}function I(q){const J=Object.values(q).reduce((Q,X)=>Q+X,0);let U=Math.random()*J;for(let[Q,X]of Object.entries(q))if((U-=X)<=0)return Q;return Object.keys(q).pop()||""}function Y0(q){if(q==="Out"){const J=I(g0),U=I(w0[J]);return`${J} to ${U}`}return q}var g0={Groundout:0.45,Flyout:0.3,Lineout:0.15,Popout:0.1},w0={Groundout:{"1B":0.2,"2B":0.2,SS:0.25,"3B":0.2,P:0.15},Flyout:{LF:0.35,CF:0.45,RF:0.2},Lineout:{"1B":0.25,"2B":0.25,SS:0.25,"3B":0.25},Popout:{C:0.3,"1B":0.2,"2B":0.15,SS:0.2,"3B":0.15}};function $0(){return{inning:1,top:!0,outs:0,bases:[0,0,0],lineupIndices:[0,0],score:[0,0]}}function Z0(q,J){let U=0;const Q=[0,0,0];for(let Y=2;Y>=0;Y--){if(!q[Y])continue;const $=Y+(J==="1B"?1:J==="2B"?2:J==="3B"?3:4);if($>=3)U++;else Q[$]=1}const X={"1B":0,"2B":1,"3B":2}[J];if(X!==void 0)Q[X]=1;if(J==="HR")U++;return[Q,U]}function V0(q,J,U,Q,X){const Y=Q||I,$=X||Y0,Z=U.top?0:1,V=Z===0?q:J,G=U.lineupIndices[Z],K=V[G%V.length],z=K.probabilities,_=Y(z),j=$(_);if(U.lineupIndices[Z]++,_==="Out"||_==="K")U.outs++;else if(_==="BB"||_==="HBP"){const[E,N]=Z0(U.bases,"1B");U.bases=E,U.score[Z]+=N}else{const[E,N]=Z0(U.bases,_);U.bases=E,U.score[Z]+=N}return{batter_id:K.batter_id,outcome:j}}async function y0(){return["CHC-2025.html","MIL-2025.html","PIT-2025.html","SEA-2025.html"]}async function N0(q){const U=await(await fetch(`./data/${q}`)).text(),{batting:Q,pitching:X}=q0(U),Y=Q?m(Q):[],$=X?m(X):[],Z=Q0(Y),V=U0($);return{batters:Z,pitchers:V}}function k0(q,J){if(!n)return;n.innerHTML="";const U=(Q,X)=>{if(!Q)return`<div><strong>${X}:</strong> Not loaded</div>`;const Y=Q.lineup||Q.batters||[],$=Q.pitcher||Q.pitchers&&Q.pitchers[0]||{name:"N/A"};return`
      <div style="margin-bottom:1.5em;">
        <strong>${X} Lineup</strong>
        <table class="lineup-table">
          <thead><tr><th>#</th><th>Name</th><th>PA</th></tr></thead>
          <tbody>
            ${(Y||[]).slice(0,9).map((Z,V)=>`<tr><td>${V+1}</td><td>${Z.name||""}</td><td>${Z.PA||""}</td></tr>`).join("")}
          </tbody>
        </table>
        <div><strong>Pitcher:</strong> ${$.name}</div>
      </div>
    `};n.innerHTML=`
    <div style="display:flex;gap:2em;flex-wrap:wrap;">
      <div style="flex:1;min-width:250px;">${U(q,"Home")}</div>
      <div style="flex:1;min-width:250px;">${U(J,"Away")}</div>
    </div>
  `}function D0(){if(!h)return;if(!P||!k||!D){if(h.innerHTML="<em>Game not started.</em>",C)C.style.display="none";return}const q=P,{inning:J,top:U,outs:Q,bases:X,score:Y,lineupIndices:$}=q,Z=U?0:1,V=Z===0?x:M,G=Z===0?D:k;if(!G){if(h.innerHTML="<em>Roster not loaded.</em>",C)C.style.display="none";return}const K=$[Z]%G.lineup.length,z=G.lineup[K],_=(Z===0?k:D).pitcher,j=["1B","2B","3B"].map((E,N)=>q.bases[N]?E:"").filter(Boolean).join(", ")||"Empty";if(h.innerHTML=`
    <div><strong>Inning:</strong> ${J} (${U?"Top":"Bottom"})</div>
    <div><strong>Outs:</strong> ${Q}</div>
    <div><strong>Bases:</strong> ${j}</div>
    <div><strong>Score:</strong> Away ${Y[0]} &ndash; Home ${Y[1]}</div>
    <div style="margin-top:1em;"><strong>At Bat:</strong> ${z.name} (vs ${_.name})</div>
  `,C)C.style.display=""}function C0(q,J=!1){if(!O)return;if(!q)return;if(J){const X=document.createElement("div");X.style.marginTop="1em",X.style.fontWeight="bold",X.textContent=`Inning ${q.inning} - ${q.top?"Top":"Bottom"}`,O.appendChild(X)}const U=["1B","2B","3B"].map((X,Y)=>q.bases[Y]?X:"").filter(Boolean).join(", ")||"Empty",Q=document.createElement("div");Q.innerHTML=`<strong>Batter:</strong> ${q.batterName}<br><strong>Result:</strong> ${q.outcome}<br><strong>Outs:</strong> ${q.outs} &nbsp; <strong>Score:</strong> Away ${q.score[0]} \u2013 Home ${q.score[1]} &nbsp; <strong>Bases:</strong> ${U}`,O.appendChild(Q),O.appendChild(document.createElement("br"))}function R0(){if(!k||!D)return;M=o(k),x=o(D),P=$0(),D0(),C0(null)}function B0(){if(!P||!M||!x)return;const q=P,J=q.top?0:1,U=J===0?x:M,Q=J===0?D:k;if(!Q)return;const X=q.lineupIndices[J]%Q.lineup.length,Y=Q.lineup[X],$=V0(x,M,q);C0({batterName:Y.name,outcome:$.outcome,outs:q.outs,score:[...q.score],bases:[...q.bases],inning:q.inning,top:q.top});let Z="",V=!1;if(q.outs>=3)if(q.outs=0,q.bases=[0,0,0],q.top)q.top=!1,Z="End of top half. Switching to bottom of inning.",V=!0;else q.top=!0,q.inning++,Z="End of inning. Advancing to next inning.",V=!0;if(V){if(O){const G=document.createElement("div");G.innerHTML=`<em>${Z}</em>`,O.appendChild(G),f0=q.inning,E0=q.top;const K=document.createElement("div");K.style.marginTop="1em",K.style.fontWeight="bold",K.textContent=`Inning ${q.inning} - ${q.top?"Top":"Bottom"}`,O.appendChild(K)}}D0()}async function c(){if(!F||!v||!T)return;const q=F.value,J=v.value;if(!q||!J)return;T.textContent="Loading lineups...";try{const[U,Q]=await Promise.all([N0(q),N0(J)]);b=U,u=Q,k=U&&U.batters&&U.pitchers?p(g&&g.length===9?g:U.batters.slice(0,9).map((X)=>X.player_id),r||U.pitchers[0].player_id,U.batters,U.pitchers):null,D=Q&&Q.batters&&Q.pitchers?p(w&&w.length===9?w:Q.batters.slice(0,9).map((X)=>X.player_id),i||Q.pitchers[0].player_id,Q.batters,Q.pitchers):null,k0(k,D),T.textContent="Lineups loaded. Ready to simulate!",R0()}catch(U){T.textContent="Failed to load lineups."}}async function F0(){if(!T)return;T.textContent="Loading teams...";const q=await y0();if(!q.length){T.textContent="No teams found in data folder.";return}for(let J of[F,v]){if(!J)continue;J.innerHTML="";for(let U of q){const Q=document.createElement("option");Q.value=U,Q.textContent=U.replace(".html",""),J.appendChild(Q)}}if(F)F.value="CHC-2025.html";if(v)v.value="MIL-2025.html";if(T.textContent="Select home and away teams.",F&&v)c()}function v0(q,J,U,Q,X){if(O0=q,!A||!z0||!H||!S)return;if(z0.textContent=`Customize ${q==="home"?"Home":"Away"} Lineup`,f)f.textContent="";A.style.display="flex",H.innerHTML="";for(let Y=0;Y<9;Y++){const $=document.createElement("li"),Z=document.createElement("select");if(Z.name=`batter${Y}`,Z.required=!0,Z.innerHTML='<option value="">-- Select --</option>'+J.map((V)=>`<option value="${V.player_id}">${V.name} (${V.PA} PA)</option>`).join(""),Q&&Q[Y])Z.value=Q[Y];$.appendChild(Z),H.appendChild($)}if(S.innerHTML='<option value="">-- Select --</option>'+U.map((Y)=>`<option value="${Y.player_id}">${Y.name} (${Y.stats&&Y.stats.IP?Y.stats.IP:""} IP)</option>`).join(""),X)S.value=X}var F=document.getElementById("home-team-select"),v=document.getElementById("away-team-select"),K0=document.getElementById("load-teams-btn"),T=document.getElementById("status"),n=document.getElementById("lineups-container"),h=document.getElementById("game-state-container"),C=document.getElementById("next-atbat-btn"),O=document.getElementById("atbat-result-container"),W0=document.getElementById("customize-home-lineup-btn"),G0=document.getElementById("customize-away-lineup-btn"),A=document.getElementById("custom-lineup-modal"),_0=document.getElementById("close-lineup-modal"),z0=document.getElementById("lineup-modal-title"),j0=document.getElementById("custom-lineup-form"),H=document.getElementById("batting-order-list"),S=document.getElementById("pitcher-select"),f=document.getElementById("lineup-error"),b=null,u=null,k=null,D=null,M=null,x=null,P=null,f0=1,E0=!0,g=null,r=null,w=null,i=null,O0=null;if(K0)K0.addEventListener("click",F0);if(F)F.addEventListener("change",c);if(v)v.addEventListener("change",c);if(C)C.addEventListener("click",B0);if(W0)W0.addEventListener("click",()=>{if(!b)return;v0("home",b.batters,b.pitchers,g,r)});if(G0)G0.addEventListener("click",()=>{if(!u)return;v0("away",u.batters,u.pitchers,w,i)});if(_0)_0.addEventListener("click",()=>{if(A)A.style.display="none"});if(j0)j0.addEventListener("submit",(q)=>{if(q.preventDefault(),!H||!S)return;const J=[],U=H.querySelectorAll("select");for(let X of U){if(!X.value){if(f)f.textContent="Please select a player for every lineup slot.";return}J.push(X.value)}if(new Set(J).size!==J.length){if(f)f.textContent="No duplicate players allowed in the lineup.";return}const Q=S.value;if(!Q){if(f)f.textContent="Please select a starting pitcher.";return}if(J.includes(Q)){if(f)f.textContent="Pitcher cannot also be in the batting lineup.";return}if(O0==="home")g=J,r=Q;else w=J,i=Q;if(A)A.style.display="none";if(M=null,x=null,P=null,f0=1,E0=!0,O)O.innerHTML="";k0(k,D),c()});window.addEventListener("DOMContentLoaded",()=>{F0()});
