function z0(q){const J=/<!--([\s\S]*?)-->/g,Q=[];let U;while((U=J.exec(q))!==null)Q.push(U[1]);return Q}function W0(q,J){const Q=new DOMParser;for(let U of q)if(U.includes(`id="${J}"`))return Q.parseFromString(U,"text/html").querySelector(`table#${J}`)||null;return null}function m(q){const J=document.createElement("div");J.style.display="none",document.body.appendChild(J),J.innerHTML=q;const Q=J.querySelector("table#players_standard_batting"),U=J.querySelector("table#players_standard_pitching"),X=z0(q),Z=W0(X,"players_standard_fielding");return J.remove(),{batting:Q,pitching:U,fielding:Z}}function n(q){if(!q||!q.href)return null;const J=q.href.match(/\/players\/.\/([^/.]+)\.shtml/);return J?J[1]:null}function E0(q){return q.toLowerCase().replace(/[^a-z0-9]/g,"").slice(0,12)}function w(q){if(!q)return[];const J=Array.from(q.querySelectorAll("tbody > tr")).filter((X)=>!X.classList.contains("thead")),Q=Array.from(q.querySelectorAll("thead tr th")).map((X)=>(X.textContent??"").trim()),U=[];for(let X of J){const Z=[X.querySelector("th"),...X.querySelectorAll("td")];if(Z.length!==Q.length)continue;const $={};for(let Y=0;Y<Q.length;Y++){const K=Q[Y],W=Z[Y];if(Y===0){let V=W?.textContent?.trim()||"",G=W?.querySelector?.("a")||null,E=n(G);if(/^\d+$/.test(V)){const _=X.querySelector("td");V=_?.textContent?.trim()||"(unknown)",G=_?.querySelector?.("a")||null,E=n(G)||E}$.name=V,$.player_id=E||E0(V)}else{const V=W?.textContent?.trim()||"",G=Number(V.replace(/,/g,""));$[K]=isNaN(G)?V:G}}U.push($)}return U}function o(q){return q.map((J)=>{const Q=Number(J.PA)||0,U=Number(J.AB)||0,X=Number(J.H)||0,Z=Number(J.HR)||0,$=Number(J.BB)||0,Y=Number(J.SO)||0,K=Number(J.SF)||0,W=Number(J.HBP)||0,V=Number(J["2B"])||0,G=Number(J["3B"])||0,E=X-V-G-Z,_=U-Y-Z+K,j=_>0?(X-Z)/_:null,L=Q>0?Y/Q:null,P=Q>0?$/Q:null,x=Q>0?Z/Q:null;return{name:J.name,player_id:J.player_id,PA:Q,stats:{H:X,HR:Z,BB:$,SO:Y,SF:K,HBP:W,singles:E,doubles:V,triples:G},rates:{kRate:L,bbRate:P,hrRate:x,BABIP:j}}})}function i(q){return q.map((J)=>{const Q=Number(J.IP)||0,U=Number(J.TBF)||0,X=Number(J.H)||0,Z=Number(J.HR)||0,$=Number(J.BB)||0,Y=Number(J.SO)||0,K=Number(J.HBP)||0,W=U>0?Y/U:null,V=U>0?$/U:null,G=U>0?Z/U:null,E=U-Y-Z-$-K,_=E>0?(X-Z)/E:null;return{name:J.name,player_id:J.player_id,TBF:U,stats:{IP:Q,H:X,HR:Z,BB:$,SO:Y,HBP:K},rates:{kRate:W,bbRate:V,hrRate:G,BABIP:_}}})}function y(q,J,Q,U){const X=q.map((Y)=>{const K=Q.find((W)=>W.player_id===Y);if(!K)throw new Error(`Lineup player not found: ${Y}`);return K}),Z=U.find((Y)=>Y.player_id===J);if(!Z)throw new Error(`Starting pitcher not found: ${J}`);const $=new Set;for(let Y of X){if($.has(Y.player_id))throw new Error(`Duplicate player in lineup: ${Y.player_id}`);$.add(Y.player_id)}if($.has(J))throw new Error(`Pitcher also appears in lineup: ${J}`);return{lineup:X,pitcher:Z}}function S(q,J){return(q+J)/2}function r(q,J){const Q=q.rates||{},U=J.rates||{},X=q.stats||{},Z=z(Q.kRate??0,"batter.kRate"),$=z(U.kRate??0,"pitcher.kRate"),Y=z(Q.bbRate??0,"batter.bbRate"),K=z(U.bbRate??0,"pitcher.bbRate"),W=z(Q.hrRate??0,"batter.hrRate"),V=z(U.hrRate??0,"pitcher.hrRate"),G=z(Q.BABIP??0.29,"batter.BABIP"),E=z(U.BABIP??0.29,"pitcher.BABIP"),_=Math.max(0,q.PA||0),j=Math.max(0,X.HBP??0),L=Math.max(0,X.singles??0),P=Math.max(0,X.doubles??0),x=Math.max(0,X.triples??0),h=z(S(Z,$),"K"),u=z(S(Y,K),"BB"),c=z(S(W,V),"HR"),X0=z(S(G,E),"BABIP"),b=z(_>0?j/_:0,"HBP"),Y0=h+u+b+c,p=Math.max(0,1-Y0),I=X0*p,Z0=p-I,F=L+P+x,$0=F>0?L/F:0.7,V0=F>0?P/F:0.2,K0=F>0?x/F:0.1;return{K:z(h,"K"),BB:z(u,"BB"),HBP:z(b,"HBP"),HR:z(c,"HR"),"1B":z(I*$0,"1B"),"2B":z(I*V0,"2B"),"3B":z(I*K0,"3B"),Out:z(Z0,"Out")}}function z(q,J){if(typeof q!=="number"||isNaN(q))return 0;if(q<0){if(J)console.warn(`[probabilityModel] Clamped negative value for ${J}: ${q} \u2192 0`);return 0}if(q>1){if(J)console.warn(`[probabilityModel] Clamped value >1 for ${J}: ${q} \u2192 1`);return 1}return q}function R(q){const{lineup:J,pitcher:Q}=q;return J.map((U)=>{const X=r(U,Q);return{batter_id:U.player_id,pitcher_id:Q.player_id,probabilities:X}})}function T(q){const J=Object.values(q).reduce((U,X)=>U+X,0);let Q=Math.random()*J;for(let[U,X]of Object.entries(q))if((Q-=X)<=0)return U;return Object.keys(q).pop()||""}function l(q){if(q==="Out"){const J=T(G0),Q=T(_0[J]);return`${J} to ${Q}`}return q}var G0={Groundout:0.45,Flyout:0.3,Lineout:0.15,Popout:0.1},_0={Groundout:{"1B":0.2,"2B":0.2,SS:0.25,"3B":0.2,P:0.15},Flyout:{LF:0.35,CF:0.45,RF:0.2},Lineout:{"1B":0.25,"2B":0.25,SS:0.25,"3B":0.25},Popout:{C:0.3,"1B":0.2,"2B":0.15,SS:0.2,"3B":0.15}};function a(){return{inning:1,top:!0,outs:0,bases:[0,0,0],lineupIndices:[0,0],score:[0,0]}}function s(q,J){let Q=0;const U=[0,0,0];for(let Z=2;Z>=0;Z--){if(!q[Z])continue;const $=Z+(J==="1B"?1:J==="2B"?2:J==="3B"?3:4);if($>=3)Q++;else U[$]=1}const X={"1B":0,"2B":1,"3B":2}[J];if(X!==void 0)U[X]=1;if(J==="HR")Q++;return[U,Q]}function t(q,J,Q,U,X){const Z=U||T,$=X||l,Y=Q.top?0:1,K=Y===0?q:J,W=Q.lineupIndices[Y],V=K[W%K.length],G=V.probabilities,E=Z(G),_=$(E);if(Q.lineupIndices[Y]++,E==="Out"||E==="K")Q.outs++;else if(E==="BB"||E==="HBP"){const[j,L]=s(Q.bases,"1B");Q.bases=j,Q.score[Y]+=L}else{const[j,L]=s(Q.bases,E);Q.bases=j,Q.score[Y]+=L}return{batter_id:V.batter_id,outcome:_}}async function f0(){return["CHC-2025.html","MIL-2025.html","PIT-2025.html"]}async function q0(q){const Q=await(await fetch(`./data/${q}`)).text(),{batting:U,pitching:X}=m(Q),Z=U?w(U):[],$=X?w(X):[],Y=o(Z),K=i($);return{batters:Y,pitchers:K}}function k0(q,J){if(!B)return;B.innerHTML="";const Q=(U,X)=>{if(!U)return`<div><strong>${X}:</strong> Not loaded</div>`;const Z=U.pitchers&&U.pitchers[0]||{name:"N/A"};return`
      <div style="margin-bottom:1.5em;">
        <strong>${X} Lineup</strong>
        <table class="lineup-table">
          <thead><tr><th>#</th><th>Name</th><th>PA</th></tr></thead>
          <tbody>
            ${(U.batters||[]).slice(0,9).map(($,Y)=>`<tr><td>${Y+1}</td><td>${$.name||""}</td><td>${$.PA||""}</td></tr>`).join("")}
          </tbody>
        </table>
        <div><strong>Pitcher:</strong> ${Z.name}</div>
      </div>
    `};B.innerHTML=`
    <div style="display:flex;gap:2em;flex-wrap:wrap;">
      <div style="flex:1;min-width:250px;">${Q(q,"Home")}</div>
      <div style="flex:1;min-width:250px;">${Q(J,"Away")}</div>
    </div>
  `}function J0(){if(!g)return;if(!H||!D||!C){if(g.innerHTML="<em>Game not started.</em>",N)N.style.display="none";return}const q=H,{inning:J,top:Q,outs:U,bases:X,score:Z,lineupIndices:$}=q,Y=Q?0:1,K=Y===0?A:v,W=Y===0?C:D;if(!W){if(g.innerHTML="<em>Roster not loaded.</em>",N)N.style.display="none";return}const V=$[Y]%W.lineup.length,G=W.lineup[V],E=(Y===0?D:C).pitcher,_=["1B","2B","3B"].map((j,L)=>q.bases[L]?j:"").filter(Boolean).join(", ")||"Empty";if(g.innerHTML=`
    <div><strong>Inning:</strong> ${J} (${Q?"Top":"Bottom"})</div>
    <div><strong>Outs:</strong> ${U}</div>
    <div><strong>Bases:</strong> ${_}</div>
    <div><strong>Score:</strong> Away ${Z[0]} &ndash; Home ${Z[1]}</div>
    <div style="margin-top:1em;"><strong>At Bat:</strong> ${G.name} (vs ${E.name})</div>
  `,N)N.style.display=""}function Q0(q,J=!1){if(!M)return;if(!q)return;if(J){const X=document.createElement("div");X.style.marginTop="1em",X.style.fontWeight="bold",X.textContent=`Inning ${q.inning} - ${q.top?"Top":"Bottom"}`,M.appendChild(X)}const Q=["1B","2B","3B"].map((X,Z)=>q.bases[Z]?X:"").filter(Boolean).join(", ")||"Empty",U=document.createElement("div");U.innerHTML=`<strong>Batter:</strong> ${q.batterName}<br><strong>Result:</strong> ${q.outcome}<br><strong>Outs:</strong> ${q.outs} &nbsp; <strong>Score:</strong> Away ${q.score[0]} \u2013 Home ${q.score[1]} &nbsp; <strong>Bases:</strong> ${Q}`,M.appendChild(U),M.appendChild(document.createElement("br"))}function M0(){if(!D||!C)return;v=R(D),A=R(C),H=a(),J0(),Q0(null)}function D0(){if(!H||!v||!A)return;const q=H,J=q.top?0:1,Q=J===0?A:v,U=J===0?C:D;if(!U)return;const X=q.lineupIndices[J]%U.lineup.length,Z=U.lineup[X],$=t(A,v,q);Q0({batterName:Z.name,outcome:$.outcome,outs:q.outs,score:[...q.score],bases:[...q.bases],inning:q.inning,top:q.top});let Y="",K=!1;if(q.outs>=3)if(q.outs=0,q.bases=[0,0,0],q.top)q.top=!1,Y="End of top half. Switching to bottom of inning.",K=!0;else q.top=!0,q.inning++,Y="End of inning. Advancing to next inning.",K=!0;if(K){if(M){const W=document.createElement("div");W.innerHTML=`<em>${Y}</em>`,M.appendChild(W),N0=q.inning,O0=q.top;const V=document.createElement("div");V.style.marginTop="1em",V.style.fontWeight="bold",V.textContent=`Inning ${q.inning} - ${q.top?"Top":"Bottom"}`,M.appendChild(V)}}J0()}async function d(){if(!O||!f||!k)return;const q=O.value,J=f.value;if(!q||!J)return;k.textContent="Loading lineups...";try{const[Q,U]=await Promise.all([q0(q),q0(J)]);L0=Q,j0=U,D=Q&&Q.batters&&Q.pitchers?y(Q.batters.slice(0,9).map((X)=>X.player_id),Q.pitchers[0].player_id,Q.batters,Q.pitchers):null,C=U&&U.batters&&U.pitchers?y(U.batters.slice(0,9).map((X)=>X.player_id),U.pitchers[0].player_id,U.batters,U.pitchers):null,k0(Q,U),k.textContent="Lineups loaded. Ready to simulate!",M0()}catch(Q){k.textContent="Failed to load lineups."}}async function U0(){if(!k)return;k.textContent="Loading teams...";const q=await f0();if(!q.length){k.textContent="No teams found in data folder.";return}for(let J of[O,f]){if(!J)continue;J.innerHTML="";for(let Q of q){const U=document.createElement("option");U.value=Q,U.textContent=Q.replace(".html",""),J.appendChild(U)}}if(O)O.value="CHC-2025.html";if(f)f.value="MIL-2025.html";if(k.textContent="Select home and away teams.",O&&f)d()}var O=document.getElementById("home-team-select"),f=document.getElementById("away-team-select"),e=document.getElementById("load-teams-btn"),k=document.getElementById("status"),B=document.getElementById("lineups-container"),g=document.getElementById("game-state-container"),N=document.getElementById("next-atbat-btn"),M=document.getElementById("atbat-result-container"),L0=null,j0=null,D=null,C=null,v=null,A=null,H=null,N0=1,O0=!0;if(e)e.addEventListener("click",U0);if(O)O.addEventListener("change",d);if(f)f.addEventListener("change",d);if(N)N.addEventListener("click",D0);window.addEventListener("DOMContentLoaded",()=>{U0()});
